(window.webpackJsonp=window.webpackJsonp||[]).push([[96],{987:function(s,a,t){"use strict";t.r(a);var n=t(12),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("p",[s._v("OpenLDAP：提供ldap认证服务的东西\n时间：2019-07-07")])]),t("p",[s._v("[TOC]")]),s._v(" "),t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("ul",[t("li",[s._v("公司原本使用的ldap服务(我前领导用ldapjs这个库手写的，就几百行)存在各种问题(但仍然已经接入了jira、grafana、yearning、jumpserver等系统)，在运维组老大的需求下，玩玩这个OpenLDAP(一开始ldap选型的时候就玩过这个，因为OpenLDAP没法自定义密码加密方式以及出于维护成本的考虑就没采用，我当时是在CentOS上用yum装的，累的半死，现在用docker搭一遍就当复习一下)。")]),s._v(" "),t("li",[s._v("openldap：服务")]),s._v(" "),t("li",[s._v("phpldapadmin：web管理界面")])]),s._v(" "),t("h2",{attrs:{id:"安装-docker方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-docker方式"}},[s._v("#")]),s._v(" 安装(docker方式)")]),s._v(" "),t("p",[s._v("dockerhub：")]),s._v(" "),t("ul",[t("li",[s._v("openldap：https://hub.docker.com/r/osixia/openldap")]),s._v(" "),t("li",[s._v("phpldapadmin：https://hub.docker.com/r/osixia/phpldapadmin")])]),s._v(" "),t("p",[s._v("github：")]),s._v(" "),t("ul",[t("li",[s._v("openldap：https://github.com/osixia/docker-openldap，有详细的使用说明")]),s._v(" "),t("li",[s._v("phpldapadmin：https://github.com/osixia/docker-phpLDAPadmin，有详细的使用说明")])]),s._v(" "),t("ol",[t("li",[s._v("启动openldap容器：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('docker run -p 389:389 -p 636:636 --name ldap-service --detach --hostname ldap-service osixia/openldap\n\n# 检查是否启动成功\ndocker exec ldap-service ldapsearch -x -H ldap://localhost -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("启动phpldapadmin容器：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -p 6443:443 --name phpldapadmin-service --hostname phpldapadmin-service --link ldap-service:ldap-host --env PHPLDAPADMIN_LDAP_HOSTS=ldap-host --detach osixia/phpldapadmin\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[t("p",[s._v("浏览器打开：https://localhost:6443/\n默认账号：cn=admin,dc=example,dc=org\n默认密码：admin")])]),s._v(" "),t("li",[t("p",[s._v("新建一个用户组和用户")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# 参考：https://www.cnblogs.com/xiaomifeng0510/p/9564688.html\n左侧dc=example,dc=org域下点击Create new entry here\n选择Generic: Posix Group\n输入组名，比如employee\n点击Create Object\n点击Commit\n左侧选择刚刚创建的组\n右侧点击Create a child entry\n右侧选择Generic: User Account\n只需要输入Last name和Password，这里我填e1和123456\n点击Create Object\n点击Commit\n\n这样我们就得到了一个dn为cn=e1,cn=employee,dc=example,dc=org，密码为123456的用户，各种系统接入ldap登录时用户名就是e1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("可以新开一个无痕浏览器进入https://localhost:6443/， 使用dn="),t("code",[s._v("cn=e1,cn=employee,dc=example,dc=org")]),s._v("，密码=123456进行登录")])])]),s._v(" "),t("h2",{attrs:{id:"python操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#python操作"}},[s._v("#")]),s._v(" Python操作")]),s._v(" "),t("ol",[t("li",[s._v("python代码中测试这个新创建的用户的登录"),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pip install ldap3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ldap3 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Connection\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 基本认证")]),s._v("\nserver "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'127.0.0.1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("389")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cn=e1, cn=employee,dc=example,dc=org'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" auto_bind"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extend"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("standard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("who_am_i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 会输出：dn:cn=e1,cn=employee,dc=example,dc=org")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[s._v("管理员身份登录ldap并搜索用户"),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ldap3 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Connection\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# admin账号绑定search")]),s._v("\nconn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cn=admin,dc=example,dc=org'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'admin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" auto_bind"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bind"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("search"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("search_base"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cn=employee,dc=example,dc=org'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                search_filter"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'(cn=e1)'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" attributes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mail'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# search是否成功（True，False）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询失败的原因")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("entries"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询到的数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" entry "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("entries"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("entry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("entry_to_json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"后话"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#后话"}},[s._v("#")]),s._v(" 后话")]),s._v(" "),t("ul",[t("li",[s._v("使用代码管理ldap，包括新建组、用户、修改密码等：http://ldap3.readthedocs.io/")]),s._v(" "),t("li",[s._v("想要自定义各种配置以及了解更多细节请仔细查阅：\n"),t("ul",[t("li",[s._v("https://github.com/osixia/docker-openldap")]),s._v(" "),t("li",[s._v("https://github.com/osixia/docker-phpLDAPadmin")]),s._v(" "),t("li",[s._v("主要是通过环境变量来控制各种东西")])])]),s._v(" "),t("li",[s._v("生产环境注意保管好OpenLDAP的数据卷")]),s._v(" "),t("li",[s._v("最后清理本地测试容器："),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker stop phpldapadmin-service && docker rm -v phpldapadmin-service\ndocker stop ldap-service && docker rm -v ldap-service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);