(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{1013:function(t,a,s){"use strict";s.r(a);var n=s(12),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("div",{staticClass:"custom-block danger"},[n("p",{staticClass:"title"}),n("p",[t._v("课程地址：https://coding.imooc.com/class/chapter/121.html"),n("br"),t._v("\n课程名称：Nginx 入门到实践"),n("br"),t._v("\n简介：web 服务、代理，应用层负载均衡、应用层安全防护、 Nginx+Lua，动静分离，全面系统的 Nginx 课程"),n("br"),t._v("\nB 站视频地址：https://www.bilibili.com/video/av34537494/ ，视频不完整且目前已经失效"),n("br"),t._v("\n别人的 github 源码地址：https://github.com/imjeson/nginx_imooc"),n("br"),t._v("\n我的评价：★★★★★")])]),t._v(" "),n("p",[t._v("[TOC]")]),t._v(" "),n("h2",{attrs:{id:"第-1-章-课程前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-1-章-课程前言"}},[t._v("#")]),t._v(" 第 1 章 课程前言")]),t._v(" "),n("p",[t._v("总览课程，介绍课程学习须知，环境准备，了解课程意义。")]),t._v(" "),n("h3",{attrs:{id:"_1-1-课程介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-课程介绍"}},[t._v("#")]),t._v(" 1-1 课程介绍")]),t._v(" "),n("p",[t._v("Nginx：高效、可靠、开源\nhttps://w3techs.com/")]),t._v(" "),n("h4",{attrs:{id:"收获一-教你实战"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#收获一-教你实战"}},[t._v("#")]),t._v(" 收获一：教你实战")]),t._v(" "),n("ul",[n("li",[t._v("数十个典型的 Nginx 配置场景：代理服务、动态缓存、动静分离、负载均衡、Nginx 与 LUA 开发")]),t._v(" "),n("li",[t._v("覆盖了 90%以上的 Nginx 核心配置模块")]),t._v(" "),n("li",[t._v("基于企业中所常见的业务配置常见")])]),t._v(" "),n("h4",{attrs:{id:"收获二-了解中间件架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#收获二-了解中间件架构"}},[t._v("#")]),t._v(" 收获二：了解中间件架构")]),t._v(" "),n("ul",[n("li",[t._v("Nginx 应用层的安全防护")]),t._v(" "),n("li",[t._v("基于 Nginx 的中间件架构性能优化问题")]),t._v(" "),n("li",[t._v("对 sql 的注入防护攻击")]),t._v(" "),n("li",[t._v("对请求的访问控制")]),t._v(" "),n("li",[t._v("对请求的频率控制")]),t._v(" "),n("li",[t._v("对防爬虫")]),t._v(" "),n("li",[t._v("Nginx 中间件性能优化\n"),n("ul",[n("li",[t._v("http 性能压测")]),t._v(" "),n("li",[t._v("性能瓶颈分析")]),t._v(" "),n("li",[t._v("系统性能优化")]),t._v(" "),n("li",[t._v("基于 Nginx 的性能配置优化")])])])]),t._v(" "),n("h4",{attrs:{id:"收获三-贯彻了解技术原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#收获三-贯彻了解技术原理"}},[t._v("#")]),t._v(" 收获三：贯彻了解技术原理")]),t._v(" "),n("ul",[n("li",[t._v("http 协议原理")]),t._v(" "),n("li",[t._v("linux 系统原理")])]),t._v(" "),n("h4",{attrs:{id:"收获四-理论结合实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#收获四-理论结合实践"}},[t._v("#")]),t._v(" 收获四：理论结合实践")]),t._v(" "),n("ul",[n("li",[t._v("帮助完善整个知识体系")]),t._v(" "),n("li",[t._v("扩展自己的经验和技能优势")])]),t._v(" "),n("h4",{attrs:{id:"课程安排"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#课程安排"}},[t._v("#")]),t._v(" 课程安排")]),t._v(" "),n("ul",[n("li",[t._v("基础篇：\n"),n("ul",[n("li",[t._v("快速安装")]),t._v(" "),n("li",[t._v("配置语法")]),t._v(" "),n("li",[t._v("默认模块")]),t._v(" "),n("li",[t._v("Nginx 的 log")]),t._v(" "),n("li",[t._v("访问限制\n"),n("ul",[n("li",[t._v("HTTP 的请求和连接")]),t._v(" "),n("li",[t._v("请求限制于连接限制")]),t._v(" "),n("li",[t._v("access 模块配置语法")]),t._v(" "),n("li",[t._v("请求限制局限性")]),t._v(" "),n("li",[t._v("基本安全认证")]),t._v(" "),n("li",[t._v("auth 模块配置语法")]),t._v(" "),n("li",[t._v("安全认证局限性")])])])])]),t._v(" "),n("li",[t._v("场景实践篇\n"),n("ul",[n("li",[t._v("静态资源 WEB 服务\n"),n("ul",[n("li",[t._v("什么是静态资源")]),t._v(" "),n("li",[t._v("静态资源服务场景")]),t._v(" "),n("li",[t._v("静态资源服务配置")]),t._v(" "),n("li",[t._v("客户端缓存")]),t._v(" "),n("li",[t._v("静态资源压缩")]),t._v(" "),n("li",[t._v("防盗链")]),t._v(" "),n("li",[t._v("跨域访问")])])]),t._v(" "),n("li",[t._v("代理服务")]),t._v(" "),n("li",[t._v("负载均衡")]),t._v(" "),n("li",[t._v("缓存服务")])])]),t._v(" "),n("li",[t._v("深度学习篇\n"),n("ul",[n("li",[t._v("动静分离")]),t._v(" "),n("li",[t._v("rewrite 规则")]),t._v(" "),n("li",[t._v("进阶模块配置")]),t._v(" "),n("li",[t._v("HTTPS 服务\n"),n("ul",[n("li",[t._v("HTTPS 协议")]),t._v(" "),n("li",[t._v("配置语法")]),t._v(" "),n("li",[t._v("Nginx 的 HTTPS 服务")]),t._v(" "),n("li",[t._v("苹果要求的 https 服务")])])]),t._v(" "),n("li",[t._v("Nginx 与 LUA 开发")])])]),t._v(" "),n("li",[t._v("架构篇\n"),n("ul",[n("li",[t._v("常见问题")]),t._v(" "),n("li",[t._v("Nginx 中间件性能优化\n"),n("ul",[n("li",[t._v("如何调试性能优化")]),t._v(" "),n("li",[t._v("性能优化影响因素")]),t._v(" "),n("li",[t._v("操作系统性能优化")]),t._v(" "),n("li",[t._v("Nginx 性能优化")])])]),t._v(" "),n("li",[t._v("Nginx 与安全")]),t._v(" "),n("li",[t._v("新版本特性")]),t._v(" "),n("li",[t._v("中间件架构设计")])])])]),t._v(" "),n("h4",{attrs:{id:"leader"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#leader"}},[t._v("#")]),t._v(" Leader")]),t._v(" "),n("ul",[n("li",[t._v("实战经验的考验磨合")]),t._v(" "),n("li",[t._v("指引团队前进方向")]),t._v(" "),n("li",[t._v("提升团队技术")])]),t._v(" "),n("h3",{attrs:{id:"_1-2-学习环境准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-学习环境准备"}},[t._v("#")]),t._v(" 1-2 学习环境准备")]),t._v(" "),n("h4",{attrs:{id:"学习环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#学习环境"}},[t._v("#")]),t._v(" 学习环境")]),t._v(" "),n("ul",[n("li",[t._v("服务器系统硬件：CPU>=2Core，内存>=256M")]),t._v(" "),n("li",[t._v("操作系统：CentOS>7.0，位数 X64，或者 redhat")]),t._v(" "),n("li",[t._v("环境调试确认：系统网络、yum 可用、关闭 iptables 规则、确认停用 selinux\n"),n("ul",[n("li",[t._v("两项安装：")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("yum -y install gcc gcc-c++ autoconf pcre pcre-defel make automake\nyum -y install wget httpd-tools vim\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("ul",[n("li",[t._v("一次初始化：")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd /opt\nmkdir app download logs work backup\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])])])]),t._v(" "),n("h4",{attrs:{id:"查看服务器环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查看服务器环境"}},[t._v("#")]),t._v(" 查看服务器环境")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("yum list|grep gcc   # 查看gcc是否安装\niptables -L # 查看防火墙规则\niptables -F # 关闭防火墙\niptables -t nat -L # 保险再执行一句，关闭防火墙\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h2",{attrs:{id:"第-2-章-基础篇"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-2-章-基础篇"}},[t._v("#")]),t._v(" 第 2 章 基础篇")]),t._v(" "),n("p",[t._v("讲解 Nginx 的快速部署安装、模块、基础配置语法。Nginx 的日志输出、Nginx 默认配置模块。Nginx 对于请求的处理，访问控制模块使用，并区别介绍连接限制与请求限制。")]),t._v(" "),n("h3",{attrs:{id:"_2-1-什么是-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-什么是-nginx"}},[t._v("#")]),t._v(" 2-1 什么是 Nginx")]),t._v(" "),n("p",[t._v("中间件：现在越来越重要了\nNginx 简述：Nginx 是一个开源且高性能、可靠的 HTTP 中间件、代理服务。")]),t._v(" "),n("h3",{attrs:{id:"_2-2-常见的中间件服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-常见的中间件服务"}},[t._v("#")]),t._v(" 2-2 常见的中间件服务")]),t._v(" "),n("p",[t._v("常见的 HTTP 服务：")]),t._v(" "),n("ul",[n("li",[t._v("HTTPD：Apache 基金会")]),t._v(" "),n("li",[t._v("IIS：微软")]),t._v(" "),n("li",[t._v("GWS：Google")])]),t._v(" "),n("h3",{attrs:{id:"_2-3-nginx-优势多路-io-复用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-nginx-优势多路-io-复用"}},[t._v("#")]),t._v(" 2-3 Nginx 优势多路 IO 复用")]),t._v(" "),n("p",[t._v("2-3、2-4、2-5、2-6 四节合并")]),t._v(" "),n("h3",{attrs:{id:"_2-4-nginx-使用-epoll-模型的优势介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-nginx-使用-epoll-模型的优势介绍"}},[t._v("#")]),t._v(" 2-4 Nginx 使用 Epoll 模型的优势介绍")]),t._v(" "),n("h3",{attrs:{id:"_2-5-nginx-cpu-亲和"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-nginx-cpu-亲和"}},[t._v("#")]),t._v(" 2-5 Nginx-CPU 亲和")]),t._v(" "),n("h3",{attrs:{id:"_2-6-nginx-sendfile"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-nginx-sendfile"}},[t._v("#")]),t._v(" 2-6 Nginx-sendfile")]),t._v(" "),n("p",[t._v("为什么选择 Nginx？")]),t._v(" "),n("ul",[n("li",[t._v("原因一：IO 多路复用 epoll\n"),n("ul",[n("li",[t._v("什么是 IO 多路复用")]),t._v(" "),n("li",[t._v("什么是 epoll：IO 多路复用的实现方式 select、poll、epoll\n"),n("ul",[n("li",[t._v("select 缺点：能够监视文件描述符的数量存在最大限制；线性扫描效率地下")]),t._v(" "),n("li",[t._v("epoll：每当 FD 就绪，采用系统的回调函数之间将 FD 放入，效率更高；最大连接无限制。")])])])])]),t._v(" "),n("li",[t._v("原因二：轻量级\n"),n("ul",[n("li",[t._v("功能模块少")]),t._v(" "),n("li",[t._v("代码模块化")])])]),t._v(" "),n("li",[t._v("原因三：CPU 亲和(affinity)\n"),n("ul",[n("li",[t._v("为什么需要 CPU 亲和：充分利用资源，减少损耗")]),t._v(" "),n("li",[t._v("什么是 CPU 亲和：是一种把 CPU 核心和 Nginx 工作进程绑定方式，把每个 worker 进程固定在一个 cpu 上执行，减少切换 cpu 的 cache miss，获得更好的性能。")])])]),t._v(" "),n("li",[t._v("原因四：sendfile\n"),n("ul",[n("li",[t._v("静态文件不再经过 User space，直接扔给 socket")])])])]),t._v(" "),n("h3",{attrs:{id:"_2-7-nginx-快速安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-nginx-快速安装"}},[t._v("#")]),t._v(" 2-7 Nginx 快速安装")]),t._v(" "),n("p",[t._v("开发版：Mainline version\n稳定版：Stable version\n历史版本：Legacy version")]),t._v(" "),n("h4",{attrs:{id:"安装-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-nginx"}},[t._v("#")]),t._v(" 安装 Nginx")]),t._v(" "),n("ol",[n("li",[t._v("下载页面：http://nginx.org/en/download.html，点击页面底部的"),n("code",[t._v("Linux packages for stable version")])]),t._v(" "),n("li",[n("code",[t._v("vim /etc/yum.repos.d/nginx.repo")]),t._v("，写入以下内容："),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])])]),t._v(" "),n("li",[n("code",[t._v("yum list|grep nginx")]),t._v("列出，"),n("code",[t._v("yum install nginx")]),t._v("安装")]),t._v(" "),n("li",[n("code",[t._v("nginx -v")]),t._v("查看版本")])]),t._v(" "),n("h3",{attrs:{id:"_2-8-nginx-的目录和配置语法-nginx-安装目录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-8-nginx-的目录和配置语法-nginx-安装目录"}},[t._v("#")]),t._v(" 2-8 Nginx 的目录和配置语法_Nginx 安装目录")]),t._v(" "),n("p",[t._v("查看安装目录位置：rpm -ql nginx")]),t._v(" "),n("h4",{attrs:{id:"安装目录讲解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装目录讲解"}},[t._v("#")]),t._v(" 安装目录讲解")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("路径")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("类型")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/etc/logtotate.d/nginx")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("配置文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 日志轮转,用于 logrotate 服务的日志切割")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/etc/nginx"),n("br"),t._v("/etc/nginx/nginx.conf"),n("br"),t._v("/etc/nginx/conf.d"),n("br"),t._v("/etc/nginx/conf.d/default.conf")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("目录、配置文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 主配置文件")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/etc/nginx/fastcgi_params"),n("br"),t._v("/etc/nginx/uwsgi_params"),n("br"),t._v("/etc/nginx/scgi_params")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("配置文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("cgi 配置相关，fastcgi 配置")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/etc/nginx/koi-utf"),n("br"),t._v("/etc/nginx/koi-win"),n("br"),t._v("/etc/nginx/win-utf")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("配置文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("编码转换映射转化文件")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/etc/nginx/mime.types")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("配置文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("设置 http 协议的 Content-Type 与扩展名对应关系")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/usr/lib/systemd/system/nginx-debug.service"),n("br"),t._v("/usr/lib/systemd/system/nginx.service"),n("br"),t._v("/etc/sysconfig/nginx"),n("br"),t._v("/etc/sysconfig/nginx-deubug")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("配置文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("用于配置出系统守护进程管理器管理方式")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/usr/lib64/nginx/modules"),n("br"),t._v("/etc/nginx/modules")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("目录")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 模块目录")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/usr/sbin/nginx"),n("br"),t._v("/usr/sbin/nginx-debug")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("命令")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 服务的启动管理和终端命令")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/usr/share/doc/nginx-1.12.0"),n("br"),t._v("/usr/share/doc/nginx-1.12.0/COPYRIGHT"),n("br"),t._v("/usr/share/man/man8/nginx.8.gz")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("文件、目录")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 的手册和帮助文件")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/var/cache/nginx")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("目录")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 的缓存目录")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("/var/log/nginx")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("目录")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 的日志目录")])])])]),t._v(" "),n("h3",{attrs:{id:"_2-9-nginx-的目录和配置语法-nginx-编译配置参数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-9-nginx-的目录和配置语法-nginx-编译配置参数"}},[t._v("#")]),t._v(" 2-9 Nginx 的目录和配置语法_Nginx 编译配置参数")]),t._v(" "),n("p",[t._v("查看安装编译参数命令："),n("code",[t._v("nginx -V")])]),t._v(" "),n("p",[t._v("编译参数解释：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("编译选项")]),t._v(" "),n("th",[t._v("作用")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("--prefix=/etc/nginx"),n("br"),t._v("--sbin-path=/usr/sbin/nginx"),n("br"),t._v("--modules-path=/usr/lib64/nginx/modules"),n("br"),t._v("--conf-path=/etc/nginx/nginx.conf"),n("br"),t._v("--error-log-path=/var/log/nginx/error.log"),n("br"),t._v("--http-log-path=/var/log/nginx/access.log"),n("br"),t._v("--pid-path=/var/run/nginx.pid"),n("br"),t._v("--lock-path=/var/run/nginx.lock")]),t._v(" "),n("td",[t._v("安装目的目录或路径")])]),t._v(" "),n("tr",[n("td",[t._v("--http-client-body-temp-path=/var/cache/nginx/client_temp"),n("br"),t._v("--http-proxy-temp-path=/var/cache/nginx/proxy_temp"),n("br"),t._v("--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp"),n("br"),t._v("--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp"),n("br"),t._v("--http-scgi-temp-path=/var/cache/nginx/scgi_temp"),n("br")]),t._v(" "),n("td",[t._v("执行对应模块时，Nginx 所保留的临时性文件")])]),t._v(" "),n("tr",[n("td",[t._v("--user=nginx"),n("br"),t._v("--group=nginx")]),t._v(" "),n("td",[t._v("设定 Nginx 进程启动的用户和组用户")])]),t._v(" "),n("tr",[n("td",[t._v("--with-cc-opt=parameters")]),t._v(" "),n("td",[t._v("设置额外的参数将被添加到 CFLAGS 变量")])]),t._v(" "),n("tr",[n("td",[t._v("--with-ld-opt=parameters")]),t._v(" "),n("td",[t._v("设置附加的参数，链接系统库")])])])]),t._v(" "),n("h3",{attrs:{id:"_2-10-nginx-的目录和配置语法-默认配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-10-nginx-的目录和配置语法-默认配置语法"}},[t._v("#")]),t._v(" 2-10 Nginx 的目录和配置语法_默认配置语法")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd /etc/nginx/\nvim nginx.conf  # 主配置文件，里面有一个include负责包含目标目录(/etc/nginx/conf.d/)下所有conf文件\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("h4",{attrs:{id:"nginx-默认配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-默认配置语法"}},[t._v("#")]),t._v(" Nginx 默认配置语法：")]),t._v(" "),n("p",[t._v("设置 Nginx 服务的系统使用用户：user\n工作进程数：worker_processes\nNginx 的错误日志：error_log\nNginx 服务启动时候 pid：pid\nevents： - worker_connections：每个进程允许最大连接数 - use：使用的内核模型")]),t._v(" "),n("p",[t._v("配置文件大致结构：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("http {\n    ...\n    server {\n        listen 80;\n        server_name localhost;  # 域名\n        location / {\n            root /usr/share/nginx/html;\n            index index.html index.htm;\n        }\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n            root /usr/share/nginx/html;\n        }\n    }\n    server {\n        ...\n    }\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br")])]),n("h3",{attrs:{id:"_2-11-nginx-的目录和配置语法-默认配置与默认站点启动"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-11-nginx-的目录和配置语法-默认配置与默认站点启动"}},[t._v("#")]),t._v(" 2-11 Nginx 的目录和配置语法_默认配置与默认站点启动")]),t._v(" "),n("p",[t._v("超时时间：keepalive_timeout")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("error_page 500 502 503 504 404 /50x.html;   # 配置状态码返回页面\nlocation = /50x.html {\n    root /usr/share/nginx/html;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"_2-12-http-请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-12-http-请求"}},[t._v("#")]),t._v(" 2-12 HTTP 请求")]),t._v(" "),n("p",[t._v("request：请求行、请求头、请求数据\nresponse：状态行、消息报头、响应正文\n例子："),n("code",[t._v("curl -v http://www.imooc.com >/dev/null")])]),t._v(" "),n("h3",{attrs:{id:"_2-13-nginx-虚拟主机及实现方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-13-nginx-虚拟主机及实现方式"}},[t._v("#")]),t._v(" 2-13 Nginx 虚拟主机及实现方式")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_2-14-nginx-虚拟主机单网卡多-ip-配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-14-nginx-虚拟主机单网卡多-ip-配置演示"}},[t._v("#")]),t._v(" 2-14 Nginx 虚拟主机单网卡多 IP 配置演示")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_2-15-nginx-虚拟主机基于多端口的配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-15-nginx-虚拟主机基于多端口的配置演示"}},[t._v("#")]),t._v(" 2-15 Nginx 虚拟主机基于多端口的配置演示")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_2-16-nginx-虚拟主机基于-host-域名的配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-16-nginx-虚拟主机基于-host-域名的配置演示"}},[t._v("#")]),t._v(" 2-16 Nginx 虚拟主机基于 host 域名的配置演示")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_2-17-nginx-日志-log-format1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-17-nginx-日志-log-format1"}},[t._v("#")]),t._v(" 2-17 Nginx 日志_log_format1")]),t._v(" "),n("p",[t._v("Nginx 日志类型：包括：error_log access_log\nlog_format：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('Syntax：log_format name [escape=default[json] string ...;\nDefault：log_format combined "...";\nContext：http\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h4",{attrs:{id:"修改日志基本配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改日志基本配置"}},[t._v("#")]),t._v(" 修改日志基本配置")]),t._v(" "),n("p",[t._v("错误日志：vim /etc/nginx/nginx.conf")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("error_log /var/log/nginx/error.log warn;  #warn是指日志等级\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("成功日志：vim /etc/nginx/nginx.conf")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("http {\n    ...\n    log_format main ...; # 定义日志格式\n    access_log /var/log/nginx/access.log main;# main是日志格式名称\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("h4",{attrs:{id:"nginx-变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-变量"}},[t._v("#")]),t._v(" Nginx 变量")]),t._v(" "),n("ul",[n("li",[t._v("HTTP 请求变量：arg_PARAMETER、http_HEADER、sent_http_HEADER")]),t._v(" "),n("li",[t._v("内置变量：Nginx 内置的")]),t._v(" "),n("li",[t._v("自定义变量：自己定义")])]),t._v(" "),n("p",[t._v("比如想在日志里记录 User-Agent，就在 log_format 配置'$http_user_agent'")]),t._v(" "),n("h4",{attrs:{id:"检查配置文件是否正确以及重启-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#检查配置文件是否正确以及重启-nginx"}},[t._v("#")]),t._v(" 检查配置文件是否正确以及重启 Nginx")]),t._v(" "),n("p",[t._v("检查配置是否正确：nginx -t -c /etc/nginx/nginx.conf\n重启：nginx -s reload -c /etc/nginx/nginx.conf")]),t._v(" "),n("h3",{attrs:{id:"_2-18-nginx-日志-log-format2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-18-nginx-日志-log-format2"}},[t._v("#")]),t._v(" 2-18 Nginx 日志_log_format2")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$remote_addr：客户端ip\n$remote_user：开启了auth验证的话，会记录用户名\n$time_local：时间\n$request：请求头的请求行(get/post http1.0这种)\n$status：response状态\n$body_bytes_sent：响应体body大小\n$http_referer：就是referer\n$http_user_agent：就是User-Agent\n$http_x_forwarded_for：就是X-Forwarded-For\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])]),n("h3",{attrs:{id:"_2-19-nginx-模块讲解-模块介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-19-nginx-模块讲解-模块介绍"}},[t._v("#")]),t._v(" 2-19 Nginx 模块讲解_模块介绍")]),t._v(" "),n("ul",[n("li",[t._v("Nginx 官方模块：nginx -V 可以看")]),t._v(" "),n("li",[t._v("第三方模块")])]),t._v(" "),n("h3",{attrs:{id:"_2-20-nginx-模块讲解-sub-status"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-20-nginx-模块讲解-sub-status"}},[t._v("#")]),t._v(" 2-20 Nginx 模块讲解_sub_status")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("编译选项")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("--with-http_stub_status_module")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Nginx 的客户端状态")])])])]),t._v(" "),n("p",[t._v("http_stub_status_module 配置：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：stub_status;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：server,location")])]),t._v(" "),n("p",[t._v("配置流程：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim default.conf\n# 在server里设置\nserver {\n    ...\n    location /mystatus {\n        stub_status;\n    }\n    ...\n}\n# 此时就可以网页访问ip:port/mystatus就可以看到服务器状态了\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])]),n("h3",{attrs:{id:"_2-21-nginx-模块讲解-random-index"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-21-nginx-模块讲解-random-index"}},[t._v("#")]),t._v(" 2-21 Nginx 模块讲解_random_index")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("编译选项")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("--with-http_random_index_module")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("目录中选择一个随机主页")])])])]),t._v(" "),n("p",[t._v("random_index_module 配置：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：random_index on|off;")]),t._v(" "),n("li",[t._v("Default：random_index off;")]),t._v(" "),n("li",[t._v("Context：location")])]),t._v(" "),n("p",[t._v("配置流程：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim default.conf\n# 在server里设置\nserver {\n    ...\n    location / {\n        root /opt/app/code;\n        random_index on;    # 随机从/opt/app/code选择html文件返回\n    }\n    ...\n}\n# 此时就可以网页访问ip:port就可以看到随机主页了\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])]),n("p",[t._v("注意：文件名以.开头的隐藏文件不会被随机到")]),t._v(" "),n("h3",{attrs:{id:"_2-22-nginx-模块讲解-sub-module"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-22-nginx-模块讲解-sub-module"}},[t._v("#")]),t._v(" 2-22 Nginx 模块讲解_sub_module")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("编译选项")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("--with-http_sub_module")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("HTTP 内容替换")])])])]),t._v(" "),n("p",[t._v("http_sub_module 配置：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：sub_filter string replacement;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：sub_filter_last_modified on|off;")]),t._v(" "),n("li",[t._v("Default：sub_filter_last_modified off;")]),t._v(" "),n("li",[t._v("Context：http,server,location")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：sub_filter_once on|off;")]),t._v(" "),n("li",[t._v("Default：sub_filter_once on;")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h3",{attrs:{id:"_2-23-nginx-模块讲解-sub-module-配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-23-nginx-模块讲解-sub-module-配置演示"}},[t._v("#")]),t._v(" 2-23 Nginx 模块讲解_sub_module 配置演示")]),t._v(" "),n("p",[t._v("配置流程：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim default.conf\n# 在server里设置\nserver {\n    ...\n    location / {\n        root /opt/app/code;\n        index index.html index.htm;\n        sub_filter '<a>imooc' '<a>IMOOC'; # 这样就会替换网页内容\n        sub_filter_once off; # 默认是on:只替换一次,off的话可以替换所有的\n    }\n    ...\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br")])]),n("h3",{attrs:{id:"_2-24-nginx-的请求限制-连接频率限制配置语法与原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-24-nginx-的请求限制-连接频率限制配置语法与原理"}},[t._v("#")]),t._v(" 2-24 Nginx 的请求限制_连接频率限制配置语法与原理")]),t._v(" "),n("p",[t._v("连接频率限制——limit_conn_module\n请求频率限制——limit_req_module")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"80",height:"80",src:s(883)}})]),t._v(" "),n("center",[t._v("图-HTTP连接和请求")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("HTTP 协议版本")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("连接关系")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("HTTP1.0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("TCP 不能复用")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("HTTP1.1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("顺序性 TCP 复用")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("HTTP2.0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("多路 TCP 复用")])])])]),t._v(" "),n("ul",[n("li",[t._v("HTTP 请求建立在一次 TCP 连接基础上")]),t._v(" "),n("li",[t._v("一次 TCP 请求至少产生一次 HTTP 请求")])]),t._v(" "),n("p",[t._v("连接限制配置语法：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：limit_conn_zone key zone=name:size;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：limit_conn zone number;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h3",{attrs:{id:"_2-25-nginx-的请求限制-请求限制配置原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-25-nginx-的请求限制-请求限制配置原理"}},[t._v("#")]),t._v(" 2-25 Nginx 的请求限制_请求限制配置原理")]),t._v(" "),n("p",[t._v("和 2-26 合并")]),t._v(" "),n("h3",{attrs:{id:"_2-26-nginx-的请求限制-请求限制配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-26-nginx-的请求限制-请求限制配置语法"}},[t._v("#")]),t._v(" 2-26 Nginx 的请求限制_请求限制配置语法")]),t._v(" "),n("p",[t._v("请求限制配置语法：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：limit_req_zone key zone=name:size rate=rate;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：limit_req zone=name [burst=number][nodelay];")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("p",[t._v("配置流程：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim default.conf\n# 修改配置文件\nlimit_conn_zone $binary_remote_addr zone=conn_zone:1m;\nlimit_req_zone $binary_remote_addr zone=req_zone:1m rate=1r/s; # 按ip限制请求频率为每秒1个\n# binary_remote_addr代替remote_addr的原因是省空间\n# 1m代表存储binary_remote_addr的空间，可以设置更大，比如2m 10m\nserver {\n    ...\n    location / {\n        root /opt/app/code;\n        limit_conn conn_zone 1; # 同一时刻同一个ip,只允许一个连接\n        # limit_req zone=req_zone burst=3 nodelay; # burst=3：访问限速，超过的3个请求在后一秒执行，nodelay：其他的全都返回503。比如并发20个，那么会处理4个，返回16个503\n        # limit_req zone=req_zone; # 使用上面的zone=req_zone配置来限制请求频率\n        index index.html index.htm;\n    }\n    ...\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("p",[t._v("tips——压力测试：ab -n 50 -c 20 http:127.0.0.1:8080/1.html # 总请求数为 50，并发数 20")]),t._v(" "),n("h3",{attrs:{id:"_2-27-nginx-的访问控制-介绍实现访问控制的基本方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-27-nginx-的访问控制-介绍实现访问控制的基本方式"}},[t._v("#")]),t._v(" 2-27 Nginx 的访问控制_介绍实现访问控制的基本方式")]),t._v(" "),n("p",[t._v("基于 IP 的访问控制：http_access_module\n基于用户的信任登录：http_auth_basic_module")]),t._v(" "),n("h3",{attrs:{id:"_2-28-nginx-的访问控制-access-module-配置语法介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-28-nginx-的访问控制-access-module-配置语法介绍"}},[t._v("#")]),t._v(" 2-28 Nginx 的访问控制—access_module 配置语法介绍")]),t._v(" "),n("p",[t._v("access_module 配置语法：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：allow address|CIDR|unix:|all;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location,limit_except")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：deny address|CIDR|unix:|all;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location,limit_except")])]),t._v(" "),n("h3",{attrs:{id:"_2-29-nginx-的访问控制-access-module-配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-29-nginx-的访问控制-access-module-配置"}},[t._v("#")]),t._v(" 2-29 Nginx 的访问控制—access_module 配置")]),t._v(" "),n("p",[t._v("配置过程：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd /etc/nginx/conf.d/\nmv default.conf access_mod.conf # 这一步可以跳过\nvim access_mod.conf\n# 开始配置\nserver{\n    ...\n    # ~ 的意思是模式匹配\n    location ~ ^/admin.html {  // 配置在location里就只对这个url生效\n        root /opt/app/code;\n        index index.html index.html;\n\n        # 配置一：禁止某ip访问\n        # deny 222.128.189.17; # 限制这个ip不能访问,会报403\n        # allow all;  # 允许所有ip访问\n\n        # 配置二：只允许某ip访问\n        allow 222.128.189.0/24;  # 允许该ip段访问\n        deny all; # 拒绝所有ip\n    }\n    ...\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br")])]),n("h3",{attrs:{id:"_2-30-nginx-的访问控制-access-module-局限性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-30-nginx-的访问控制-access-module-局限性"}},[t._v("#")]),t._v(" 2-30 Nginx 的访问控制—access_module 局限性")]),t._v(" "),n("p",[t._v("access_module 基于的是 remote_addr，有代理的话就没法控制了")]),t._v(" "),n("p",[t._v("http_x_forwarded_for：Client IP,Proxy(1) IP,Proxy(2) IP,...\n需要注意的是，这个字段可以由客户端伪造")]),t._v(" "),n("p",[t._v("解决 access_module 的局限性：")]),t._v(" "),n("ul",[n("li",[t._v("方法一：采用别的 HTTP 头信息控制访问，如 HTTP_X_FORWARD_FOR")]),t._v(" "),n("li",[t._v("方法二：结合 geo 模块做")]),t._v(" "),n("li",[t._v("方法三：通过 HTTP 自定义变量传递")])]),t._v(" "),n("h3",{attrs:{id:"_2-31-nginx-的访问控制-auth-basic-module-配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-31-nginx-的访问控制-auth-basic-module-配置"}},[t._v("#")]),t._v(" 2-31 Nginx 的访问控制—auth_basic_module 配置")]),t._v(" "),n("p",[t._v("auth_basic_module 配置语法：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：auth_basic string|off;")]),t._v(" "),n("li",[t._v("Default：auth_basic off;")]),t._v(" "),n("li",[t._v("Context：http,server,location,limit_except")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：auth_basic_user_file file; # 认证文件存储路径")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location,limit_except")])]),t._v(" "),n("p",[t._v("auth_basic_module 配置过程：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('yum install httpd-tools -y # 安装用户名密码文件生成工具\nhtpasswd -c /etc/nginx/auth_conf username # 生成文件\n# 这里会提示输入两次密码\nvim default.conf\n# 编辑配置文件\nserver {\n    ...\n    location ~ ^/admin.html {\n        root /opt/app/code;\n        index index.html index.html;\n\n        auth_basic "请输入账号密码:";\n        auth_basic_user_file /etc/nginx/auth_conf;\n    }\n}\n重启nginx后访问地址，就会要求输入用户名和密码了\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br")])]),n("h3",{attrs:{id:"_2-32-nginx-的访问控制-auth-basic-module-局限性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-32-nginx-的访问控制-auth-basic-module-局限性"}},[t._v("#")]),t._v(" 2-32 Nginx 的访问控制—auth_basic_module 局限性")]),t._v(" "),n("p",[t._v("auth_basic_module 局限性：")]),t._v(" "),n("ul",[n("li",[t._v("用户信息依赖文件方式")]),t._v(" "),n("li",[t._v("操作管理机械，效率低下")]),t._v(" "),n("li",[t._v("解决方案：\n"),n("ul",[n("li",[t._v("Nginx 结合 LUA 实现高效验证")]),t._v(" "),n("li",[t._v("Nginx 和 LDAP 打通，利用 nginx-auth-ldap 模块")])])])]),t._v(" "),n("h2",{attrs:{id:"第-3-章-场景实践篇"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-3-章-场景实践篇"}},[t._v("#")]),t._v(" 第 3 章 场景实践篇")]),t._v(" "),n("p",[t._v("Nginx 作为静态资源 web 服务的场景应用，Nginx 做为 http 代理服务,介绍代理服务的类型，正向反向代理配置，重点讲解 nginx 作为的应用层负载均衡服务的各种应用，hash 负载均衡策略,Nginx 缓存等")]),t._v(" "),n("h3",{attrs:{id:"_3-1-场景实践篇内容介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-场景实践篇内容介绍"}},[t._v("#")]),t._v(" 3-1 场景实践篇内容介绍")]),t._v(" "),n("p",[t._v("一、静态资源 WEB 服务\n二、代理服务\n三、负载均衡调度器 SLB\n四、动态缓存")]),t._v(" "),n("h3",{attrs:{id:"_3-2-nginx-作为静态资源-web-服务-静态资源类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-nginx-作为静态资源-web-服务-静态资源类型"}},[t._v("#")]),t._v(" 3-2 Nginx 作为静态资源 web 服务_静态资源类型")]),t._v(" "),n("p",[t._v("非服务器动态运行生成的文件：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("类型")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("种类")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("浏览器端渲染")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("HTML、CSS、JS")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("图片")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("JPEG、GIF、PNG")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("视频")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("FLV、MPEG")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("文件")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("TXT、等任意下载文件")])])])]),t._v(" "),n("h3",{attrs:{id:"_3-3-nginx-作为静态资源-web-服务-cdn-场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-nginx-作为静态资源-web-服务-cdn-场景"}},[t._v("#")]),t._v(" 3-3 Nginx 作为静态资源 web 服务_CDN 场景")]),t._v(" "),n("p",[t._v("CDN：Content Delivery Network(内容分发网络)")]),t._v(" "),n("h3",{attrs:{id:"_3-4-nginx-作为静态资源-web-服务-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-nginx-作为静态资源-web-服务-配置语法"}},[t._v("#")]),t._v(" 3-4 Nginx 作为静态资源 web 服务_配置语法")]),t._v(" "),n("h4",{attrs:{id:"sendfile-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sendfile-配置语法"}},[t._v("#")]),t._v(" sendfile 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：sendfile on|off;")]),t._v(" "),n("li",[t._v("Default：sendfile off;")]),t._v(" "),n("li",[t._v("Context：http,server,location,if in location")]),t._v(" "),n("li",[t._v("引读：--with-file-aio 异步文件读取")])]),t._v(" "),n("h4",{attrs:{id:"tcp-nopush-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tcp-nopush-配置语法"}},[t._v("#")]),t._v(" tcp_nopush 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：tcp_nopush on|off;")]),t._v(" "),n("li",[t._v("Default：tcp_nopush off;")]),t._v(" "),n("li",[t._v("Context：http,server,location")]),t._v(" "),n("li",[t._v("作用：sendfile 开启的情况下，提高网络包的传输效率")])]),t._v(" "),n("h4",{attrs:{id:"tcp-nodelay-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tcp-nodelay-配置语法"}},[t._v("#")]),t._v(" tcp_nodelay 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：tcp_nodelay on|off;")]),t._v(" "),n("li",[t._v("Default：tcp_nodelay on;")]),t._v(" "),n("li",[t._v("Context：http,server,location")]),t._v(" "),n("li",[t._v("作用：keepalive 连接下，提高网络包的传输实时性")]),t._v(" "),n("li",[t._v("说明：实时性要求较高的情况下可以打开，实时发送")])]),t._v(" "),n("h4",{attrs:{id:"配置语法-压缩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置语法-压缩"}},[t._v("#")]),t._v(" 配置语法-压缩")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：gzip on|off;")]),t._v(" "),n("li",[t._v("Default：gzip off;")]),t._v(" "),n("li",[t._v("Context：http,server,location,if in location")]),t._v(" "),n("li",[t._v("作用：压缩传输")]),t._v(" "),n("li",[t._v("----分隔线----\n压缩比配置")]),t._v(" "),n("li",[t._v("Syntax：gzip_comp_level level;")]),t._v(" "),n("li",[t._v("Default：gzip_comp_level 1;")]),t._v(" "),n("li",[t._v("Context：http,server,location")]),t._v(" "),n("li",[t._v("----分割线----\n压缩 http 版本配置")]),t._v(" "),n("li",[t._v("Syntax：gzip_http_version 1.0|1.1;")]),t._v(" "),n("li",[t._v("Default：gzip_http_version 1.1;")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h3",{attrs:{id:"_3-5-nginx-作为静态资源-web-服务-场景演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-nginx-作为静态资源-web-服务-场景演示"}},[t._v("#")]),t._v(" 3-5 Nginx 作为静态资源 web 服务_场景演示")]),t._v(" "),n("h4",{attrs:{id:"扩展-nginx-压缩模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#扩展-nginx-压缩模块"}},[t._v("#")]),t._v(" 扩展 Nginx 压缩模块")]),t._v(" "),n("p",[t._v("http_gzip_static_module-预读 gzip 功能,需要先手动提前压缩好文件("),n("code",[t._v("gzip ./test.img")]),t._v(")\nhttp_gunzip_module-应用支持 gunzip 的压缩方式\n使用代码例子见课堂源码 3-5\n注意：gzip 对图片压缩能力较弱，效果最好的是文字压缩(都是成倍的压缩的)。")]),t._v(" "),n("h3",{attrs:{id:"_3-6-nginx-作为静态资源-web-服务-浏览器缓存原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-nginx-作为静态资源-web-服务-浏览器缓存原理"}},[t._v("#")]),t._v(" 3-6 Nginx 作为静态资源 web 服务_浏览器缓存原理")]),t._v(" "),n("p",[t._v("和 3-7 合并")]),t._v(" "),n("h3",{attrs:{id:"_3-7-nginx-作为静态资源-web-服务-浏览器缓存场景演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-nginx-作为静态资源-web-服务-浏览器缓存场景演示"}},[t._v("#")]),t._v(" 3-7 Nginx 作为静态资源 web 服务_浏览器缓存场景演示")]),t._v(" "),n("p",[t._v("HTTP 协议定义的缓存机制(如：Expires;Cache-control 等)")]),t._v(" "),n("h4",{attrs:{id:"校验过期机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#校验过期机制"}},[t._v("#")]),t._v(" 校验过期机制")]),t._v(" "),n("ul",[n("li",[t._v("校验是否过期：Expires、Cache-Control(max-age)")]),t._v(" "),n("li",[t._v("协议中 Etag 头信息校验：Etag")]),t._v(" "),n("li",[t._v("Last-Modified 头信息校验：Last-Modified")])]),t._v(" "),n("h4",{attrs:{id:"配置语法-expires"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置语法-expires"}},[t._v("#")]),t._v(" 配置语法-expires")]),t._v(" "),n("p",[t._v("添加 Cache-Control、Expires 头")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：\n"),n("ul",[n("li",[t._v("expires [modified]time;")]),t._v(" "),n("li",[t._v("expires epoch|max|off;")])])]),t._v(" "),n("li",[t._v("Default：expires off;")]),t._v(" "),n("li",[t._v("Context：http,server,location,if in location")])]),t._v(" "),n("p",[t._v("配置例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location ~ .*\\.(htm|html)$ {\n    expires 24h;\n    root /opt/app/code;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"_3-8-nginx-作为静态资源-web-服务-跨站访问"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-nginx-作为静态资源-web-服务-跨站访问"}},[t._v("#")]),t._v(" 3-8 Nginx 作为静态资源 web 服务_跨站访问")]),t._v(" "),n("p",[t._v("跨站：浏览器默认会禁止跨站\n为什么浏览器禁止跨域访问：")]),t._v(" "),n("ul",[n("li",[t._v("不安全，容易出现 CSRF 攻击。")])]),t._v(" "),n("p",[t._v("Nginx 怎么设置允许跨域访问：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：add_header name value [always];")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location,if in location")]),t._v(" "),n("li",[t._v("需要设置：Access-Control-Allow-Origin")])]),t._v(" "),n("h3",{attrs:{id:"_3-9-nginx-作为静态资源-web-服务-跨域访问场景配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-nginx-作为静态资源-web-服务-跨域访问场景配置"}},[t._v("#")]),t._v(" 3-9 Nginx 作为静态资源 web 服务_跨域访问场景配置")]),t._v(" "),n("p",[t._v("配置例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location ~ .*\\.(htm|html)$ {\n    add_header Access-Control-Allow-Origin *;\n    # add_header Access-Control-Allow-Origin www.imooc.com; # 只允许这一个域名跨域访问\n    add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;\n    root  /opt/app/code;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("h3",{attrs:{id:"_3-10-nginx-作为静态资源-web-服务-防盗链目的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-10-nginx-作为静态资源-web-服务-防盗链目的"}},[t._v("#")]),t._v(" 3-10 Nginx 作为静态资源 web 服务_防盗链目的")]),t._v(" "),n("p",[t._v("和 3-11 合并")]),t._v(" "),n("h3",{attrs:{id:"_3-11-nginx-作为静态资源-web-服务-防盗链配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-11-nginx-作为静态资源-web-服务-防盗链配置"}},[t._v("#")]),t._v(" 3-11 Nginx 作为静态资源 web 服务_防盗链配置")]),t._v(" "),n("p",[t._v("防盗链目的：防止资源被盗用\n防盗链设置思路：")]),t._v(" "),n("ul",[n("li",[t._v("首要方式：区别哪些请求是非正常的用户请求")])]),t._v(" "),n("p",[t._v("基于 http_referer 防盗链配置模块：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：valid_referers none|blocked|server_names|string ...;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：server,location")])]),t._v(" "),n("p",[t._v("none：允许不带 referer 的访问\nblocked：允许非 http 的访问\n同时支持正则匹配形式的写法：~/google./;\n配置例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location ~ .*\\.(jpg|gif|png)$ {\n        valid_referers none blocked 116.62.103.228 jeson.imoocc.com ~wei\\.png;\n        if ($invalid_referer) {\n            return 403;\n        }\n        root  /opt/app/code/images;\n    }\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h3",{attrs:{id:"_3-12-nginx-作为代理服务-代理服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-12-nginx-作为代理服务-代理服务"}},[t._v("#")]),t._v(" 3-12 Nginx 作为代理服务_代理服务")]),t._v(" "),n("p",[t._v("合并到下一节")]),t._v(" "),n("h3",{attrs:{id:"_3-13-nginx-作为代理的模式和使用模块介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-13-nginx-作为代理的模式和使用模块介绍"}},[t._v("#")]),t._v(" 3-13 Nginx 作为代理的模式和使用模块介绍")]),t._v(" "),n("p",[t._v("合并到下一节")]),t._v(" "),n("h3",{attrs:{id:"_3-14-nginx-作为代理服务-配置语法及反向代理场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-14-nginx-作为代理服务-配置语法及反向代理场景"}},[t._v("#")]),t._v(" 3-14 Nginx 作为代理服务_配置语法及反向代理场景")]),t._v(" "),n("p",[t._v("客户端与 Nginx 常见的交互：")]),t._v(" "),n("ul",[n("li",[t._v("普通请求：HTTP、HTTPS")]),t._v(" "),n("li",[t._v("邮件：ICMP、POP、IMAP")]),t._v(" "),n("li",[t._v("流媒体：RTMP\n正向代理：客户端——>代理—|—>服务端\n反向代理：客户端—|—>代理——>服务端\n正向代理和反向代理的区别：代理的对象不一样")]),t._v(" "),n("li",[t._v("正向代理代理的对象是客户端")]),t._v(" "),n("li",[t._v("反向代理代理的对象是服务端")])]),t._v(" "),n("p",[t._v("Nginx 正向代理配置语法：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_pass URL;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：location、if in location、limit_except")]),t._v(" "),n("li",[t._v("URL 一般这么写：\n"),n("ul",[n("li",[t._v("http://localhost:8000/uri/")]),t._v(" "),n("li",[t._v("https://192.168.1.1:8000/uri/")]),t._v(" "),n("li",[t._v("http://unix:/tmp/backend.socket:/uri/;")])])])]),t._v(" "),n("p",[t._v("Nginx 配置正向代理例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location ~ /test_proxy.html$ {\n        proxy_pass http://127.0.0.1:8080;\n    }\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"_3-15-nginx-作为代理服务-正向代理配置场景-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-15-nginx-作为代理服务-正向代理配置场景-1"}},[t._v("#")]),t._v(" 3-15 Nginx 作为代理服务_正向代理配置场景(1)")]),t._v(" "),n("p",[t._v("合并到后面一节")]),t._v(" "),n("h3",{attrs:{id:"_3-16-nginx-作为代理服务-正向代理配置场景-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-16-nginx-作为代理服务-正向代理配置场景-2"}},[t._v("#")]),t._v(" 3-16 Nginx 作为代理服务_正向代理配置场景(2)")]),t._v(" "),n("p",[t._v("只允许某个服务器访问：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('location / {\n    if ($http_x_forwarded_for !~* "^11..62\\.103\\.228"){ #访问控制,这个ip是另一台主机ip\n        return 403;\n    }\n    root /opt/app/code;\n    index index.html index.htm;\n}\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("resolver 8.8.8.8;   # 设置DNS解析服务器\nlocation / {\n    proxy_pass http://$http_host$request_uri;   # 原样转发\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"_3-17-nginx-作为代理服务-代理配置语法补充"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-17-nginx-作为代理服务-代理配置语法补充"}},[t._v("#")]),t._v(" 3-17 Nginx 作为代理服务_代理配置语法补充")]),t._v(" "),n("p",[t._v("官方文档：http://nginx.org/en/docs/http/ngx_http_proxy_module.html")]),t._v(" "),n("h4",{attrs:{id:"其他配置语法-缓冲区"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其他配置语法-缓冲区"}},[t._v("#")]),t._v(" 其他配置语法-缓冲区：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_buffering on|off;")]),t._v(" "),n("li",[t._v("Default：proxy_buffering on;")]),t._v(" "),n("li",[t._v("Context：http,server,location;")]),t._v(" "),n("li",[t._v("扩展：proxy_buffer_size、proxy_buffers、proxy_busy_buffers_size")])]),t._v(" "),n("h4",{attrs:{id:"其他配置语法-跳转重定向"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其他配置语法-跳转重定向"}},[t._v("#")]),t._v(" 其他配置语法-跳转重定向：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_redirect default;proxy_redirect off;proxy_redirect redirect replacement;")]),t._v(" "),n("li",[t._v("Default：proxy_redirect default;")]),t._v(" "),n("li",[t._v("Context：http,server,location;")])]),t._v(" "),n("h4",{attrs:{id:"其他配置语法-头信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其他配置语法-头信息"}},[t._v("#")]),t._v(" 其他配置语法-头信息")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_set_header field value;")]),t._v(" "),n("li",[t._v("Default：\n"),n("ul",[n("li",[t._v("proxy_set_header Host $proxy_host;")]),t._v(" "),n("li",[t._v("proxy_set_header Connection close;")])])]),t._v(" "),n("li",[t._v("Context：http,server,location;")]),t._v(" "),n("li",[t._v("扩展：proxy_hide_header、proxy_set_body")])]),t._v(" "),n("h4",{attrs:{id:"其他配置语法-超时"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其他配置语法-超时"}},[t._v("#")]),t._v(" 其他配置语法-超时")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_connect_timeout time;")]),t._v(" "),n("li",[t._v("Default：proxy_connect_timeout 60s;")]),t._v(" "),n("li",[t._v("Context：http,server,location;")]),t._v(" "),n("li",[t._v("扩展：proxy_read_timeout、proxy_send_timeout")])]),t._v(" "),n("h3",{attrs:{id:"_3-18-nginx-作为代理服务-代理补充配置和规范"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-18-nginx-作为代理服务-代理补充配置和规范"}},[t._v("#")]),t._v(" 3-18 Nginx 作为代理服务_代理补充配置和规范")]),t._v(" "),n("p",[t._v("proxy 常用配置：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location / {\n    proxy_pass http://127.0.0.1:8080\n    proxy_redirect default;\n\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Real-IP $remote_addr;\n\n    proxy_connect_timeout 30;\n    proxy_send_timeout 60;\n    proxy_read_timeout 60;\n\n    proxy_buffer_size 32k; # 缓冲区大小\n    proxy_buffering on;\n    proxy_buffers 4 128k;\n    proxy_busy_buffers_size 256k;\n    proxy_max_temp_file_size 256k;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("h3",{attrs:{id:"_3-19-nginx-作为缓存服务-nginx-作为缓存服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-19-nginx-作为缓存服务-nginx-作为缓存服务"}},[t._v("#")]),t._v(" 3-19 Nginx 作为缓存服务_Nginx 作为缓存服务")]),t._v(" "),n("p",[t._v("缓存类型：服务器缓存、代理(Nginx)缓存、客户端缓存")]),t._v(" "),n("h3",{attrs:{id:"_3-20-nginx-作为缓存服务-缓存服务配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-20-nginx-作为缓存服务-缓存服务配置语法"}},[t._v("#")]),t._v(" 3-20 Nginx 作为缓存服务_缓存服务配置语法")]),t._v(" "),n("h4",{attrs:{id:"proxy-cache-path-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-path-配置语法"}},[t._v("#")]),t._v(" proxy_cache_path 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_cache_path path [levels=levels][user_temp_path=on|off] keys_zone=name:size [inactive=time][max_size=size] [manager_files=number][manager_sleep=time] [manager_threshold=time][loader_files=number] [loader_sleep=time][loader_threshold=time] [purger=on|off][purger_files=number] [purger_sleep=time][purger_threshold=time];")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http")])]),t._v(" "),n("h4",{attrs:{id:"proxy-cache-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-配置语法"}},[t._v("#")]),t._v(" proxy_cache 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_cache zone|off;")]),t._v(" "),n("li",[t._v("Default：proxy_cache off;")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h4",{attrs:{id:"缓存过期周期配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缓存过期周期配置语法"}},[t._v("#")]),t._v(" 缓存过期周期配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_cache_valid [code ...] time;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h4",{attrs:{id:"缓存的维度配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缓存的维度配置语法"}},[t._v("#")]),t._v(" 缓存的维度配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy"),n("em",[t._v("cache_key string")]),t._v(";")]),t._v(" "),n("li",[t._v("Default：proxy_cache_key $scheme$proxy_host$request_uri;")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h3",{attrs:{id:"_3-21-nginx-作为缓存服务-场景配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-21-nginx-作为缓存服务-场景配置演示"}},[t._v("#")]),t._v(" 3-21 Nginx 作为缓存服务_场景配置演示")]),t._v(" "),n("p",[t._v("代码例子见"),n("code",[t._v("Nginx入门到实践课堂源码/3-28/cache_test.conf")]),t._v("\ntips——清空当前目录："),n("code",[t._v("rm -rf ./*")])]),t._v(" "),n("h3",{attrs:{id:"_3-22-nginx-作为缓存服务-场景配置补充说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-22-nginx-作为缓存服务-场景配置补充说明"}},[t._v("#")]),t._v(" 3-22 Nginx 作为缓存服务_场景配置补充说明")]),t._v(" "),n("h4",{attrs:{id:"如何清理指定缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何清理指定缓存"}},[t._v("#")]),t._v(" 如何清理指定缓存？")]),t._v(" "),n("ul",[n("li",[t._v("方式一：rm -rf 缓存目录内容(./*)")]),t._v(" "),n("li",[t._v("方式二：第三方扩展模块 ngx_cache_purge")])]),t._v(" "),n("h4",{attrs:{id:"如何让部分页面不缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何让部分页面不缓存"}},[t._v("#")]),t._v(" 如何让部分页面不缓存？")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：proxy_no_cache string ...;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("# 设置不缓存的url\nif ($request_uri ~ ^/(url3|login|register|password\\/rest)){\n    set $cookie_nochache 1;\n}\nlocation / {\n    proxy_no_cache $cookie_nocache $arg_nocache $arg_comment;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h3",{attrs:{id:"_3-23-nginx-缓存命中分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-23-nginx-缓存命中分析"}},[t._v("#")]),t._v(" 3-23 Nginx 缓存命中分析")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_3-24-nginx-统计日志进行缓存命率中分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-24-nginx-统计日志进行缓存命率中分析"}},[t._v("#")]),t._v(" 3-24 Nginx 统计日志进行缓存命率中分析")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_3-25-nginx-作为缓存服务-分片请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-25-nginx-作为缓存服务-分片请求"}},[t._v("#")]),t._v(" 3-25 Nginx 作为缓存服务_分片请求")]),t._v(" "),n("h4",{attrs:{id:"大文件分片请求-http-slice-module"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#大文件分片请求-http-slice-module"}},[t._v("#")]),t._v(" 大文件分片请求 http_slice_module")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：slice size;")]),t._v(" "),n("li",[t._v("Default：slice 0;")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("p",[t._v("优势：每个自请求收到的数据都会形成一个独立文件，一个请求断了，其他请求不受影响。\n缺点：当文件很大或者 slice 很小的时候，可能会导致文件描述符耗尽等情况。")]),t._v(" "),n("h3",{attrs:{id:"_3-26-什么是-websocket-以及-nginx-实现-ws-代理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-26-什么是-websocket-以及-nginx-实现-ws-代理"}},[t._v("#")]),t._v(" 3-26 什么是 Websocket 以及 Nginx 实现 ws 代理")]),t._v(" "),n("h3",{attrs:{id:"_3-27-基于-nodejs-实现-websocket-代理场景配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-27-基于-nodejs-实现-websocket-代理场景配置演示"}},[t._v("#")]),t._v(" 3-27 基于 nodejs 实现 websocket 代理场景配置演示")]),t._v(" "),n("h3",{attrs:{id:"_3-28-什么是-fastcgi-代理及配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-28-什么是-fastcgi-代理及配置语法"}},[t._v("#")]),t._v(" 3-28 什么是 fastcgi 代理及配置语法")]),t._v(" "),n("h3",{attrs:{id:"_3-29-lnmp-基础环境安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-29-lnmp-基础环境安装"}},[t._v("#")]),t._v(" 3-29 LNMP 基础环境安装")]),t._v(" "),n("h3",{attrs:{id:"_3-30-fastcgi-代理配置演示及测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-30-fastcgi-代理配置演示及测试"}},[t._v("#")]),t._v(" 3-30 Fastcgi 代理配置演示及测试")]),t._v(" "),n("h3",{attrs:{id:"_3-31-lnmp-配置演示-1-搭建-wordpress-博客系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-31-lnmp-配置演示-1-搭建-wordpress-博客系统"}},[t._v("#")]),t._v(" 3-31 LNMP 配置演示 1-搭建 wordpress 博客系统")]),t._v(" "),n("h3",{attrs:{id:"_3-32-lnmp-配置演示-2-搭建-wordpress-博客系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-32-lnmp-配置演示-2-搭建-wordpress-博客系统"}},[t._v("#")]),t._v(" 3-32 LNMP 配置演示 2-搭建 wordpress 博客系统")]),t._v(" "),n("h3",{attrs:{id:"_3-33-fastcgi-缓存配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-33-fastcgi-缓存配置演示"}},[t._v("#")]),t._v(" 3-33 Fastcgi 缓存配置演示")]),t._v(" "),n("h3",{attrs:{id:"_3-34-场景演示-后端服务添加-no-cache-头对于-nginx-代理缓存的影响"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-34-场景演示-后端服务添加-no-cache-头对于-nginx-代理缓存的影响"}},[t._v("#")]),t._v(" 3-34 场景演示：后端服务添加 no-cache 头对于 Nginx 代理缓存的影响")]),t._v(" "),n("h3",{attrs:{id:"_3-35-场景演示-设置缓存维度-fastcgi-cache-key-设置的影响"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-35-场景演示-设置缓存维度-fastcgi-cache-key-设置的影响"}},[t._v("#")]),t._v(" 3-35 场景演示：设置缓存维度 fastcgi_cache_key 设置的影响")]),t._v(" "),n("h3",{attrs:{id:"_3-36-uwsgi-反向代理模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-36-uwsgi-反向代理模式"}},[t._v("#")]),t._v(" 3-36 Uwsgi 反向代理模式")]),t._v(" "),n("h3",{attrs:{id:"_3-37-基于-django-框架-uwsgi-反向代理配置演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-37-基于-django-框架-uwsgi-反向代理配置演示"}},[t._v("#")]),t._v(" 3-37 基于 Django 框架 Uwsgi 反向代理配置演示")]),t._v(" "),n("h3",{attrs:{id:"_3-38-nginx-作为负载均衡服务-负载均衡与-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-38-nginx-作为负载均衡服务-负载均衡与-nginx"}},[t._v("#")]),t._v(" 3-38 Nginx 作为负载均衡服务_负载均衡与 Nginx")]),t._v(" "),n("p",[t._v("Nginx 负载均衡：")]),t._v(" "),n("ul",[n("li",[t._v("GSLB：Global Server Load Balance(全局负载均衡)")]),t._v(" "),n("li",[t._v("SLB：Server Load Balancing(服务器负载均衡)")])]),t._v(" "),n("p",[t._v("四层负载均衡和七层负载均衡")]),t._v(" "),n("p",[t._v("Nginx 实现负载均衡原理：proxy_pass——>upstream server\n配置语法：")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：upstream name {...};")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http")])]),t._v(" "),n("h3",{attrs:{id:"_3-39-nginx-作为负载均衡服务-配置场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-39-nginx-作为负载均衡服务-配置场景"}},[t._v("#")]),t._v(" 3-39 Nginx 作为负载均衡服务_配置场景")]),t._v(" "),n("p",[t._v("和我平常部署 Django、Flask、Tornado 的做法差不多。")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("upstream imooc {\n    server 116.62.103.228:8001;\n    server 116.62.103.228:8002;\n    server 116.62.103.228:8003;\n}\n\nserver {\n    ...\n    location / {\n        proxy_pass http://imooc;\n        include proxy_params;\n    }\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br")])]),n("h3",{attrs:{id:"_3-40-nginx-作为负载均衡服务-backup-状态演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-40-nginx-作为负载均衡服务-backup-状态演示"}},[t._v("#")]),t._v(" 3-40 Nginx 作为负载均衡服务_backup 状态演示")]),t._v(" "),n("h4",{attrs:{id:"upstream-举例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#upstream-举例"}},[t._v("#")]),t._v(" upstream 举例")]),t._v(" "),n("p",[t._v("backup 表示备份节点：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("upstream backend {\n    server backend1.example.com weight=5;\n    server backend2.example.com:8080;\n    server unix:/tmp/backend3;\n\n    server backup1.example.com:8080 backup;\n    server backup2.example.com:8080 backup;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("h4",{attrs:{id:"后端服务器在负载均衡调度中的状态"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#后端服务器在负载均衡调度中的状态"}},[t._v("#")]),t._v(" 后端服务器在负载均衡调度中的状态")]),t._v(" "),n("p",[t._v("down：当前的 server 暂时不参与负载均衡\nbackup：预留的备份服务器\nmax_fails：允许请求失败的次数\nfail_timeout：经过 max_fails 失败后，服务暂停的时间\nmax_conns：限制最大的接收的连接数")]),t._v(" "),n("h4",{attrs:{id:"backup-配置例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#backup-配置例子"}},[t._v("#")]),t._v(" backup 配置例子")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("upstream imooc {\n    server 116.62.103.228:8001 down;\n    server 116.62.103.228:8002 backup;\n    server 116.62.103.228:8003 max_fails=1 fail_timeout=10s;\n}\n...\nserver {\n    location / {\n        proxy_pass http://imooc;\n        include proxy_params;\n    }\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br")])]),n("h3",{attrs:{id:"_3-41-nginx-作为负载均衡服务-轮询策略与加权轮询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-41-nginx-作为负载均衡服务-轮询策略与加权轮询"}},[t._v("#")]),t._v(" 3-41 Nginx 作为负载均衡服务_轮询策略与加权轮询")]),t._v(" "),n("h4",{attrs:{id:"负载均衡调度算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡调度算法"}},[t._v("#")]),t._v(" 负载均衡调度算法")]),t._v(" "),n("p",[t._v("轮询：按时间顺序逐一分配到不同的后端服务器\n加权轮询：weight 值越大，分配到的访问几率越高\nip_hash：每个请求按访问 IP 的 hash 结果分配，这样来自同一个 IP 的固定访问一个后端服务器\n最小连接数(least_conn)：最小链接数，那个机器连接数少就分发\nurl_hash：按照访问的 URL 的 hash 结果来分配请求，是每个 URL 定向到同一个后端服务器\nhash 关键数值：hash 自定义的 key\n随机：...\n加权随机：...")]),t._v(" "),n("h4",{attrs:{id:"nginx-配置-ip-hash"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-配置-ip-hash"}},[t._v("#")]),t._v(" Nginx 配置 ip_hash")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("upstream imooc {\n    ip_hash;    # 只需要加这一句就行\n    server 116.62.103.228:8001;\n    server 116.62.103.228:8002;\n    server 116.62.103.228:8003;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("h3",{attrs:{id:"_3-42-nginx-作为负载均衡服务-负载均衡策略-ip-hash-方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-42-nginx-作为负载均衡服务-负载均衡策略-ip-hash-方式"}},[t._v("#")]),t._v(" 3-42 Nginx 作为负载均衡服务_负载均衡策略 ip_hash 方式")]),t._v(" "),n("p",[t._v("上一节就讲了...")]),t._v(" "),n("h3",{attrs:{id:"_3-43-nginx-作为负载均衡服务-负载均衡策略-url-hash-策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-43-nginx-作为负载均衡服务-负载均衡策略-url-hash-策略"}},[t._v("#")]),t._v(" 3-43 Nginx 作为负载均衡服务_负载均衡策略 url_hash 策略")]),t._v(" "),n("h4",{attrs:{id:"hash-key"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#hash-key"}},[t._v("#")]),t._v(" hash key")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：hash key [consistent];")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：upstream")]),t._v(" "),n("li",[t._v("This directive appeared in version 1.7.2.")])]),t._v(" "),n("h4",{attrs:{id:"nginx-配置-url-hash"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-配置-url-hash"}},[t._v("#")]),t._v(" Nginx 配置 url_hash")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("upstream imooc {\n    hash $request_uri;    # 只需要加这一句就行\n    server 116.62.103.228:8001;\n    server 116.62.103.228:8002;\n    server 116.62.103.228:8003;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("h2",{attrs:{id:"第-4-章-深度学习篇"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-4-章-深度学习篇"}},[t._v("#")]),t._v(" 第 4 章 深度学习篇")]),t._v(" "),n("p",[t._v("Nginx 常用配置模块,rewirte 的配置语法和规则，配置基于指定地域的规则访问,geoip 模块、https 的实现原理，配置 nginx 的 https 服务,secure_link_module 的防盗链实现，讲解，讲解 Lua 的开发语法、配合 Nginx 实现高效的认证系统和其他场景。")]),t._v(" "),n("h3",{attrs:{id:"_4-1-nginx-动静分离-动静分离场景演示-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-nginx-动静分离-动静分离场景演示-1"}},[t._v("#")]),t._v(" 4-1 Nginx 动静分离_动静分离场景演示(1)")]),t._v(" "),n("p",[t._v("和下一节合并")]),t._v(" "),n("h3",{attrs:{id:"_4-2-nginx-动静分离-动静分离场景演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-nginx-动静分离-动静分离场景演示"}},[t._v("#")]),t._v(" 4-2 Nginx 动静分离_动静分离场景演示")]),t._v(" "),n("p",[t._v("和下一节合并")]),t._v(" "),n("h3",{attrs:{id:"_4-3-nginx-动静分离-动静分离场景演示-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-nginx-动静分离-动静分离场景演示-2"}},[t._v("#")]),t._v(" 4-3 Nginx 动静分离_动静分离场景演示(2)")]),t._v(" "),n("p",[t._v("动静分离(比如 django 的 static 分离)：")]),t._v(" "),n("ul",[n("li",[t._v("通过中间件将动态请求和静态请求分离")]),t._v(" "),n("li",[t._v("分离资源，减少不必要的请求消耗，减少请求延时")])]),t._v(" "),n("p",[t._v("配置例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("upstream java_api{\n    server 127.0.0.1:8080;\n}\nserver {\n    listen       80;\n    server_name  localhost;\n    access_log  /var/log/nginx/log/host.access.log  main;\n    root /opt/app/code;\n\n    location ~ \\.jsp$ {\n        proxy_pass http://java_api;\n        index  index.html index.htm;\n    }\n\n    location ~ \\.(jpg|png|gif)$ {\n        expires 1h;\n        gzip on;\n    }\n\n    location /{\n        index  index.html index.htm;\n    }\n\n    error_page   500 502 503 504 404  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n\n    scripts$fastcgi_script_name;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br")])]),n("h3",{attrs:{id:"_4-4-rewrite-规则-rewrite-规则作用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-rewrite-规则-rewrite-规则作用"}},[t._v("#")]),t._v(" 4-4 Rewrite 规则_rewrite 规则作用")]),t._v(" "),n("p",[t._v("Nginx 的 rewrite 规则：")]),t._v(" "),n("ul",[n("li",[t._v("作用：实现 url 重写以及重定向")]),t._v(" "),n("li",[t._v("场景：\n1)URL 访问跳转，支持开发设计：页面跳转、兼容性支持、展示效果等\n2)SEO 优化 3)维护：后台维护、流量转发等 4)安全")])]),t._v(" "),n("h3",{attrs:{id:"_4-5-rewrite-规则-rewrite-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-rewrite-规则-rewrite-配置语法"}},[t._v("#")]),t._v(" 4-5 Rewrite 规则_rewrite 配置语法")]),t._v(" "),n("h4",{attrs:{id:"rewrite-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rewrite-配置语法"}},[t._v("#")]),t._v(" rewrite 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：rewrite regex replacement [flag];")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：server,location,if")]),t._v(" "),n("li",[t._v("例子：rewrite ^(.*)$ /pages/weihuyemian.html break; # 把所有请求都重定向到维护页面")])]),t._v(" "),n("h3",{attrs:{id:"_4-6-rewrite-规则-rewrite-正则表达式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-rewrite-规则-rewrite-正则表达式"}},[t._v("#")]),t._v(" 4-6 Rewrite 规则_rewrite 正则表达式")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("符号")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v(".")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("匹配除换行符以外的任意字符")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("?")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("重复 0 次或 1 次")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("+")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("重复 1 次或更多次")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("*")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("重复任意次")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("\\d")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("匹配数字")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("^")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("匹配字符串的开始")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("$")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("匹配字符串的介绍")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("{n}")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("重复 n 次")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("{n,}")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("重复 n 次或更多次")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("[c]")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("匹配单个字符 c")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("[a-z]")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("匹配 a-z 小写字母的任意一个")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("|转义字符")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}})])])]),t._v(" "),n("p",[t._v("tips——()用于匹配括号之间的内容，通过$1、$2 调用，例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("if($http_user_agent~MSIE){\n    rewrite ^(.*)$ /msie/$1 break;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("tips——终端测试正则：pcretest")]),t._v(" "),n("h3",{attrs:{id:"_4-7-rewrite-规则-rewrite-规则中的-flag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-rewrite-规则-rewrite-规则中的-flag"}},[t._v("#")]),t._v(" 4-7 Rewrite 规则_rewrite 规则中的 flag")]),t._v(" "),n("h4",{attrs:{id:"rewrite-规则中的-flag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rewrite-规则中的-flag"}},[t._v("#")]),t._v(" rewrite 规则中的 flag")]),t._v(" "),n("ul",[n("li",[t._v("last：停止 rewrite 检测")]),t._v(" "),n("li",[t._v("break：停止 rewrite 检测")]),t._v(" "),n("li",[t._v("redirect：返回 302 临时重定向(仅当前有效,浏览器不会缓存)，地址栏会显示跳转后的地址")]),t._v(" "),n("li",[t._v("permanent：返回 301 永久重定向(浏览器会缓存)，地址栏会显示跳转后的地址")])]),t._v(" "),n("p",[t._v("本节示例配置文件见源码"),n("code",[t._v("4-7")])]),t._v(" "),n("h3",{attrs:{id:"_4-8-rewrite-规则-redirect-和-permanent-区别"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-rewrite-规则-redirect-和-permanent-区别"}},[t._v("#")]),t._v(" 4-8 Rewrite 规则_redirect 和 permanent 区别")]),t._v(" "),n("p",[t._v("本节示例配置文件见源码"),n("code",[t._v("4-8")]),t._v("\npermanent：客户端会永久保留重定向结果，之后访问时会直接访问重定向后的地址。")]),t._v(" "),n("h3",{attrs:{id:"_4-9-rewrite-规则-rewrite-规则场景-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-rewrite-规则-rewrite-规则场景-1"}},[t._v("#")]),t._v(" 4-9 Rewrite 规则_rewrite 规则场景(1)")]),t._v(" "),n("p",[t._v("合并到下一节")]),t._v(" "),n("h3",{attrs:{id:"_4-10-rewrite-规则-rewrite-规则场景-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-10-rewrite-规则-rewrite-规则场景-2"}},[t._v("#")]),t._v(" 4-10 Rewrite 规则_rewrite 规则场景(2)")]),t._v(" "),n("p",[t._v("本节示例配置文件见源码"),n("code",[t._v("4-9")])]),t._v(" "),n("h3",{attrs:{id:"_4-11-rewrite-规则-rewrite-规则书写"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-11-rewrite-规则-rewrite-规则书写"}},[t._v("#")]),t._v(" 4-11 Rewrite 规则_rewrite 规则书写")]),t._v(" "),n("p",[t._v("Rewrite 规则优先级：")]),t._v(" "),n("ul",[n("li",[t._v("执行 server 块的 rewrite 命令")]),t._v(" "),n("li",[t._v("执行 location 匹配")])]),t._v(" "),n("p",[t._v("优雅的 Rewrite 规则书写\nApache：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("- RewriteCond %{HTTP_HOST} nginx.org\n- RewriteRule (.*)\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("Nginx：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("server {\n    listen 80;\n    server_name www.nginx.org nginx.org;\n    if ($http_host=nginx.org){\n        rewrite (.*) http://www.nginx.org$1;\n    }\n    ...\n}\n更优雅的写法：\nserver {\n    listen 80;\n    server_name nginx.org;\n    rewrite ^ http://www.nginx.org$request_uri?;\n}\nserver {\n    listen 80;\n    server_name www.nginx.org;\n    ...\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])]),n("h3",{attrs:{id:"_4-12-nginx-进阶高级模块-secure-link-模块作用原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-12-nginx-进阶高级模块-secure-link-模块作用原理"}},[t._v("#")]),t._v(" 4-12 Nginx 进阶高级模块_secure_link 模块作用原理")]),t._v(" "),n("p",[t._v("secure_link_module 模块：")]),t._v(" "),n("ul",[n("li",[t._v("一、指定并允许检查请求的链接的真实性以及保护资源免遭未经授权的访问")]),t._v(" "),n("li",[t._v("二、限制链接生效周期")])]),t._v(" "),n("h4",{attrs:{id:"secure-link-module-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#secure-link-module-配置语法"}},[t._v("#")]),t._v(" secure_link_module 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：secure_link expression;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")]),t._v(" "),n("li",[t._v("----分割线----")]),t._v(" "),n("li",[t._v("Syntax：secure_link_md5 expression;")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server,location")])]),t._v(" "),n("h4",{attrs:{id:"secure-link-module-验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#secure-link-module-验证"}},[t._v("#")]),t._v(" secure_link_module 验证")]),t._v(" "),n("p",[n("code",[t._v("/download?md5=e4Nc3Rm01TBBNYw&expires=1539792000")]),t._v("：加密验证和过期校验")]),t._v(" "),n("h3",{attrs:{id:"_4-13-nginx-进阶高级模块-secure-link-模块实现请求资源验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-13-nginx-进阶高级模块-secure-link-模块实现请求资源验证"}},[t._v("#")]),t._v(" 4-13 Nginx 进阶高级模块_secure_link 模块实现请求资源验证")]),t._v(" "),n("p",[t._v("本节示例配置文件见源码"),n("code",[t._v("4-13")]),t._v("\nmd5url.sh：用来生成 url，执行"),n("code",[t._v("sh md5url.sh")])]),t._v(" "),n("h3",{attrs:{id:"_4-14-nginx-进阶高级模块-geoip-读取地域信息模块介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-14-nginx-进阶高级模块-geoip-读取地域信息模块介绍"}},[t._v("#")]),t._v(" 4-14 Nginx 进阶高级模块_Geoip 读取地域信息模块介绍")]),t._v(" "),n("p",[t._v("geoip_module 模块")]),t._v(" "),n("ul",[n("li",[t._v("基于 IP 地址匹配 MaxMind GeoIP 二进制文件，读取 IP 所在地域信息")]),t._v(" "),n("li",[t._v("需要安装："),n("code",[t._v("yum install nginx-module-geoip")])]),t._v(" "),n("li",[t._v("使用场景：\n"),n("ul",[n("li",[t._v("区别国内外作 HTTP 访问规则")]),t._v(" "),n("li",[t._v("区别国内城市地域作 HTTP 访问规则")])])])]),t._v(" "),n("h3",{attrs:{id:"_4-15-nginx-进阶高级模块-geoip-读取地域信息场景展示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-15-nginx-进阶高级模块-geoip-读取地域信息场景展示"}},[t._v("#")]),t._v(" 4-15 Nginx 进阶高级模块_Geoip 读取地域信息场景展示")]),t._v(" "),n("p",[t._v("本节示例 nginx 配置文件见"),n("code",[t._v("4-15")]),t._v("\n需要先下载两个文件，写在 bash 文件里，执行该 bash 文件即可")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("#!/bin/sh\nwget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz\nwget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd geoip/\ngunzip  # 直接解压上面两个文件\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("例子——禁止非中国 ip 访问：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("geoip_country /etc/nginx/geoip/GeoIP.dat;\ngeoip_city /etc/nginx/geoip/GeoLiteCity.dat;\n...\nlocation / {\n    if ($geoip_country_code != CN) { # 只允许中国访问\n        return 403;\n    }\n    root   /usr/share/nginx/html;\n    index  index.html index.htm;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])]),n("h3",{attrs:{id:"_4-16-基于-nginx-的-https-服务-https-原理和作用-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-16-基于-nginx-的-https-服务-https-原理和作用-1"}},[t._v("#")]),t._v(" 4-16 基于 Nginx 的 HTTPS 服务_HTTPS 原理和作用 1")]),t._v(" "),n("p",[t._v("为什么需要 HTTPS？")]),t._v(" "),n("ul",[n("li",[t._v("原因：HTTP 不安全\n"),n("ol",[n("li",[t._v("传输数据被中间人盗用、信息泄露")]),t._v(" "),n("li",[t._v("数据内容劫持、篡改")])])])]),t._v(" "),n("p",[t._v("HTTPS 协议的实现：对传输内容进行加密以及身份验证\n对称加密和非对称加密：对称加密的加密秘钥和解密秘钥相同；\nHTTPS 加密协议原理：")]),t._v(" "),n("ol",[n("li",[t._v("客户端发起 SSL 连接")]),t._v(" "),n("li",[t._v("服务端发送公钥(服务端保管唯一私钥)")]),t._v(" "),n("li",[t._v("客户端发送对称密码(发送对称密码利用公钥加密)")]),t._v(" "),n("li",[t._v("客户端和服务端利用对称加密传输数据")])]),t._v(" "),n("h3",{attrs:{id:"_4-17-基于-nginx-的-https-服务-https-原理和作用-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-17-基于-nginx-的-https-服务-https-原理和作用-2"}},[t._v("#")]),t._v(" 4-17 基于 Nginx 的 HTTPS 服务_HTTPS 原理和作用 2")]),t._v(" "),n("p",[t._v("对抗中间人同时伪造客户端和服务端：CA 证书\n将上一节第 1 步改为发送 CA 证书(内容包含公钥)")]),t._v(" "),n("h3",{attrs:{id:"_4-18-基于-nginx-的-https-服务-证书签名生成-ca-证书"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-18-基于-nginx-的-https-服务-证书签名生成-ca-证书"}},[t._v("#")]),t._v(" 4-18 基于 Nginx 的 HTTPS 服务_证书签名生成 CA 证书")]),t._v(" "),n("p",[t._v("查看 openssl 版本：openssl version")]),t._v(" "),n("h3",{attrs:{id:"_4-19-基于-nginx-的-https-服务-证书签名生成和-nginx-的-https-服务场景演示-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-19-基于-nginx-的-https-服务-证书签名生成和-nginx-的-https-服务场景演示-1"}},[t._v("#")]),t._v(" 4-19 基于 Nginx 的 HTTPS 服务_证书签名生成和 Nginx 的 HTTPS 服务场景演示 1")]),t._v(" "),n("p",[t._v("合并到下一节")]),t._v(" "),n("h3",{attrs:{id:"_4-20-基于-nginx-的-https-服务-证书签名生成和-nginx-的-https-服务场景演示-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-20-基于-nginx-的-https-服务-证书签名生成和-nginx-的-https-服务场景演示-2"}},[t._v("#")]),t._v(" 4-20 基于 Nginx 的 HTTPS 服务_证书签名生成和 Nginx 的 HTTPS 服务场景演示 2")]),t._v(" "),n("p",[t._v("生成密钥和 CA 证书：")]),t._v(" "),n("ol",[n("li",[t._v("步骤一、生成 key 密钥")]),t._v(" "),n("li",[t._v("步骤二、生成证书签名请求文件(csr 文件)")]),t._v(" "),n("li",[t._v("步骤三、生成证书签名文件(CA 文件)")])]),t._v(" "),n("h4",{attrs:{id:"自签证书流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自签证书流程"}},[t._v("#")]),t._v(" 自签证书流程")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd /etc/nginx/\nmkdir ssl_key\nopenssl genrsa -idea -out jesonc.key 1024 # 生成key\n接下来会要求输入两次密码(记为A)\nopenssl req -new -key jesonc.key -out jesonc.csr # 根据key文件生成csr\n这里会要求输入一下密码(A)，然后就是填写国家、公司等相关信息，还有一个新密码(更改证书信息时要用，记为B，不严格的话可以为空)\n# 一般情况下，需要将以上两个key和csr文件发送给证书签发机构生成CA文件，这里我们自己签一下\nopenssl x509 -req -days 3650(过期天数) -in jesonc.csr -signkey jesonc.key -out jesonc.crt\n这里会要求输入一下密码A\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])]),n("h4",{attrs:{id:"nginx-的-https-配置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-的-https-配置语法"}},[t._v("#")]),t._v(" Nginx 的 HTTPS 配置语法")]),t._v(" "),n("ul",[n("li",[t._v("Syntax：ssl on|off; # 表示开启 ssl")]),t._v(" "),n("li",[t._v("Default：ssl off;")]),t._v(" "),n("li",[t._v("Context：http,server")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：ssl_certificate file; # ssl 证书文件位置")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server")]),t._v(" "),n("li",[t._v("----分隔线----")]),t._v(" "),n("li",[t._v("Syntax：ssl_certificate_key file; # ssl 密码文件位置")]),t._v(" "),n("li",[t._v("Default：-")]),t._v(" "),n("li",[t._v("Context：http,server")])]),t._v(" "),n("p",[t._v("配置文件示例见"),n("code",[t._v("4-19")])]),t._v(" "),n("h3",{attrs:{id:"_4-21-基于-nginx-的-https-服务-实战场景配置苹果要求的-openssl-后台-https-服务-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-21-基于-nginx-的-https-服务-实战场景配置苹果要求的-openssl-后台-https-服务-1"}},[t._v("#")]),t._v(" 4-21 基于 Nginx 的 HTTPS 服务_实战场景配置苹果要求的 openssl 后台 HTTPS 服务 1")]),t._v(" "),n("p",[t._v("问题 1：配置了 ssl 证书之后，每次 nginx -s reload 都需要输入密钥\n问题 2：通过 key 直接生成自签 CA 证书，跳过 csr 文件生成")]),t._v(" "),n("p",[t._v("苹果要求的证书：\na、服务器所有连接石油 TLS1.2 以上版本(openssl>1.0.2)\nb、HTTPS 证书必须使用 SHA256 以上哈希算法签名\nc、HTTPS 证书必须使用 RSA 2048 位或 ECC 256 位以上公钥算法\nd、使用前向加密技术")]),t._v(" "),n("p",[t._v("3 分 27 秒有更新 openssl 的 shell 脚本，截图如下：")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:s(884)}})]),t._v(" "),n("h3",{attrs:{id:"_4-22-基于-nginx-的-https-服务-实战场景配置苹果要求的-openssl-后台-https-服务-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-22-基于-nginx-的-https-服务-实战场景配置苹果要求的-openssl-后台-https-服务-2"}},[t._v("#")]),t._v(" 4-22 基于 Nginx 的 HTTPS 服务_实战场景配置苹果要求的 openssl 后台 HTTPS 服务 2")]),t._v(" "),n("p",[t._v("生成苹果要求的自签证书：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("openssl req -days 36500 -x509 -sha256 -nodes -newkey rsa:2048 -keyout jesonc.key -out jesonc_apple.crt\n会要求填一些信息\n修改nginx配置后重启即可\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"_4-23-基于-nginx-的-https-服务-实战场景配置苹果要求的-openssl-后台-https-服务-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-23-基于-nginx-的-https-服务-实战场景配置苹果要求的-openssl-后台-https-服务-3"}},[t._v("#")]),t._v(" 4-23 基于 Nginx 的 HTTPS 服务_实战场景配置苹果要求的 openssl 后台 HTTPS 服务 3")]),t._v(" "),n("p",[t._v("去掉 key 文件的保护码：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("openssl rsa -in ./jesoncold.key -out ./jesoncou_nopas.key\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("这样在签证书，重启 nginx 时就都不需要密码了。")]),t._v(" "),n("h3",{attrs:{id:"_4-24-基于-nginx-的-https-服务-https-服务优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-24-基于-nginx-的-https-服务-https-服务优化"}},[t._v("#")]),t._v(" 4-24 基于 Nginx 的 HTTPS 服务_HTTPS 服务优化")]),t._v(" "),n("p",[t._v("方法一、激活 keepalive 长连接\n方法二、设置 ssl session 缓存")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("server {\n    ...\n    keepalive_timeout 100;\n\n    ssl on;\n    ssl_session_cache shared:SSL:10m; # 开启10MB的缓存,可以存储8k到10k个会话\n    ssl_session_timeout 10m; # 10分钟session国企\n    ...\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])]),n("p",[t._v("检查配置文件语法：nginx -tc /etc/nginx/nginx.conf\n重启：nginx -s reload -c /etc/nginx/nginx.conf")]),t._v(" "),n("h3",{attrs:{id:"_4-25-nginx-与-lua-的开发-nginx-与-lua-特性与优势"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-25-nginx-与-lua-的开发-nginx-与-lua-特性与优势"}},[t._v("#")]),t._v(" 4-25 Nginx 与 Lua 的开发_Nginx 与 Lua 特性与优势")]),t._v(" "),n("p",[t._v("Nginx 与 Lua 开发：")]),t._v(" "),n("ul",[n("li",[t._v("Lua 基础语法")]),t._v(" "),n("li",[t._v("Nginx 与 Lua 环境")]),t._v(" "),n("li",[t._v("场景：用 Nginx 结合 Lua 实现代码的灰度发布")])]),t._v(" "),n("p",[t._v("Lua：")]),t._v(" "),n("ul",[n("li",[t._v("是一个简洁、轻量、可扩展的脚本语言")])]),t._v(" "),n("p",[t._v("Nginx+Lua 优势")]),t._v(" "),n("ul",[n("li",[t._v("充分结合 Nginx 的并发处理 epoll 优势和 Lua 的轻量实现简单的功能且高并发的场景")])]),t._v(" "),n("h3",{attrs:{id:"_4-26-nginx-与-lua-的开发-lua-基础开发语法-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-26-nginx-与-lua-的开发-lua-基础开发语法-1"}},[t._v("#")]),t._v(" 4-26 Nginx 与 Lua 的开发_Lua 基础开发语法 1")]),t._v(" "),n("p",[t._v("安装：CentOS："),n("code",[t._v("yum install lua")]),t._v(" MacOS："),n("code",[t._v("brew install lua")]),t._v("\n进入命令行交互：lua\n脚本文件运行例子：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('# test.lua文件内容\n#!/usr/bin/lua\nprint("Hello, Lua")\n\n# 赋予可执行权限\nchmod a+rx ./text.lua\n# 直接执行\n./test.lua\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("h4",{attrs:{id:"lua-基础语法-注释"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lua-基础语法-注释"}},[t._v("#")]),t._v(" Lua 基础语法——注释")]),t._v(" "),n("p",[t._v("行注释：--\n块注释：--[[块注释]]--")]),t._v(" "),n("h3",{attrs:{id:"_4-27-nginx-与-lua-的开发-lua-基础开发语法-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-27-nginx-与-lua-的开发-lua-基础开发语法-2"}},[t._v("#")]),t._v(" 4-27 Nginx 与 Lua 的开发_Lua 基础开发语法 2")]),t._v(" "),n("h4",{attrs:{id:"lua-基础语法-变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lua-基础语法-变量"}},[t._v("#")]),t._v(" Lua 基础语法——变量")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("a = 'alo\\n123'\na = 'alo\\n123\\\"'\na = '\\97lo\\10\\04923\"'\na = [[alo\n123\"]]\n注意：布尔类型只有nil和false是false，数字0，''，空字符串('\\0')都是true\n注意：lua中的变量如果没有特殊说明，全是全局变量，局部变量加local\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h4",{attrs:{id:"lua-基础语法-循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lua-基础语法-循环"}},[t._v("#")]),t._v(" Lua 基础语法——循环")]),t._v(" "),n("ul",[n("li",[t._v("while")])]),t._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[t._v("sum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nnum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" num "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n    sum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" num\n    num "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" num "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sum ="')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 注意：lua没有++或者+=这种操作")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("ul",[n("li",[t._v("for")])]),t._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[t._v("sum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n    sum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" i\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h4",{attrs:{id:"lua-基础语法-if-else-判断语句"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lua-基础语法-if-else-判断语句"}},[t._v("#")]),t._v(" Lua 基础语法——if-else 判断语句")]),t._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" age "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" sex "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Male"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"大于40岁的男人"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elseif")]),t._v(" age "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" sex "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Female"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v('"大于'),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("岁且非女人"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" age "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" io"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Your age is"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("age"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('-- 注意：~=是不等于，字符串拼接操作符".."，io库分别从stdin和stdout读写的read和write函数')]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])]),n("h3",{attrs:{id:"_4-28-nginx-与-lua-的开发-nginx-与-lua-的开发环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-28-nginx-与-lua-的开发-nginx-与-lua-的开发环境"}},[t._v("#")]),t._v(" 4-28 Nginx 与 Lua 的开发_Nginx 与 Lua 的开发环境")]),t._v(" "),n("h4",{attrs:{id:"nginx-与-lua-的开发环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-与-lua-的开发环境"}},[t._v("#")]),t._v(" Nginx 与 Lua 的开发环境")]),t._v(" "),n("ol",[n("li",[t._v("LuaJIT：一个解释器，比 lua 解释器更高效")]),t._v(" "),n("li",[t._v("ngx_devel_kit 和 lua-nginx-module")]),t._v(" "),n("li",[t._v("重新编译 Nginx\n参考手记：http://www.imooc.com/article/19597")])]),t._v(" "),n("h3",{attrs:{id:"_4-29-nginx-与-lua-的开发-nginx-调用-lua-的指令及-nginx-的-luaapi-接口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-29-nginx-与-lua-的开发-nginx-调用-lua-的指令及-nginx-的-luaapi-接口"}},[t._v("#")]),t._v(" 4-29 Nginx 与 Lua 的开发_Nginx 调用 Lua 的指令及 Nginx 的 Luaapi 接口")]),t._v(" "),n("h4",{attrs:{id:"nginx-调用-lua-的指令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-调用-lua-的指令"}},[t._v("#")]),t._v(" Nginx 调用 Lua 的指令")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("Nginx 的可插拔模块化加载执行，共 11 个处理阶段")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("指令")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("set_by_lua"),n("br"),t._v("set_by—_lua_file")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("设置 nginx 遍历,可以实现复杂的赋值逻辑")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("access_by_lua"),n("br"),t._v("access_by_lua_file")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("请求访问阶段处理,用于访问控制")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("content_by_lua"),n("br"),t._v("content_by_lua_file")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("内容处理器,接收请求处理并输出响应")])])])])]),t._v(" "),n("li",[n("p",[t._v("Nginx Lua API")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("API")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.var")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("nginx 变量")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.req.get_headers")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("获取请求头")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.req.get_uri_args")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("获取 url 请求参数")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.redirect")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("重定向")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.print")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("输出响应内容体")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.say")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("通过 ngx.print,但是会最后输出一个换行符")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("ngx.header")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("输出响应头")])])])])])]),t._v(" "),n("h3",{attrs:{id:"_4-30-nginx-与-lua-的开发-实战场景灰度发布"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-30-nginx-与-lua-的开发-实战场景灰度发布"}},[t._v("#")]),t._v(" 4-30 Nginx 与 Lua 的开发_实战场景灰度发布")]),t._v(" "),n("p",[t._v("灰度发布：按照一定的关系区别，分部分的代码进行上线，使代码的发布能平滑过渡上线")]),t._v(" "),n("ol",[n("li",[t._v("用户信息 cookie 等信息的区别")]),t._v(" "),n("li",[t._v("根据用户的 ip 地址")])]),t._v(" "),n("p",[t._v("实战场景说明：nginx——>lua，lua 根据用户不同 ip，去 memcached 匹配返回用户需要访问哪个服务")]),t._v(" "),n("h3",{attrs:{id:"_4-31-nginx-与-lua-的开发-实战场景灰度发布场景演示-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-31-nginx-与-lua-的开发-实战场景灰度发布场景演示-1"}},[t._v("#")]),t._v(" 4-31 Nginx 与 Lua 的开发_实战场景灰度发布场景演示 1")]),t._v(" "),n("p",[t._v("安装 memcached："),n("code",[t._v("yum install memcached")]),t._v("\n启动两套 web 服务，讲师用的是 tomcat")]),t._v(" "),n("h3",{attrs:{id:"_4-32-nginx-与-lua-的开发-实战场景灰度发布场景演示-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-32-nginx-与-lua-的开发-实战场景灰度发布场景演示-2"}},[t._v("#")]),t._v(" 4-32 Nginx 与 Lua 的开发_实战场景灰度发布场景演示 2")]),t._v(" "),n("p",[t._v("启动 memcached：memcached -p11211 -u nobody -d # -p 端口,-u 启动用户,-d 守护进程\n查看：ps -aux|grep mem 或者 netstat -luntp|grep 11211\n本节配置文件见"),n("code",[t._v("4-31")])]),t._v(" "),n("h4",{attrs:{id:"nginx-测试-lua"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-测试-lua"}},[t._v("#")]),t._v(" Nginx 测试 lua")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('location /hello {   # 测试location\n    default_type \'text/plain\';\n    content_by_lua \'ngx.say("hello, lua")\'; # 在浏览器直接显示"hello, lua"\n}\n\nlocation /myip {\n    default_type \'text/plain\';\n    content_by_lua \'\n        clientIP = ngx.req.get_headers()["x_forwarded_for"]\n        ngx.say("IP:",clientIP)\n        \';\n}\n\nlocation / {\n    default_type "text/html";\n    content_by_lua_file /opt/app/lua/dep.lua; # 执行lua文件\n    #add_after_body "$http_x_forwarded_for";\n}\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br")])]),n("p",[t._v("lua 使用 memcached 需要安装模块"),n("code",[t._v("resty.memcached")]),t._v("：大致流程见 install_memcache_lua.sh")]),t._v(" "),n("h4",{attrs:{id:"ngx-exec"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ngx-exec"}},[t._v("#")]),t._v(" ngx.exec")]),t._v(" "),n("p",[t._v('ngx.exec("@server")：告诉 nginx，proxy_pass 到名为 server 的服务')]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location @server{\n    proxy_pass http://127.0.0.1:9090;\n}\n\nlocation @server_test{\n    proxy_pass http://127.0.0.1:8080;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h4",{attrs:{id:"操作-memcached"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#操作-memcached"}},[t._v("#")]),t._v(" 操作 memcached")]),t._v(" "),n("p",[t._v("菜鸟教程：http://www.runoob.com/memcached/memcached-tutorial.html")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("set 命令的基本语法格式如下：\n    set key flags exptime bytes [noreply]\n    value\n参数说明如下：\nkey：键值 key-value 结构中的 key，用于查找缓存值。\nflags：可以包括键值对的整型参数，客户机使用它存储关于键值对的额外信息 。\nexptime：在缓存中保存键值对的时间长度（以秒为单位，0 表示永远）\nbytes：在缓存中存储的字节数\nnoreply（可选）： 该参数告知服务器不需要返回数据\nvalue：存储的值（始终位于第二行）（可直接理解为key-value结构中的value）\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("telnet 127.0.0.1 11211  # 连接\nget 103.215.191.72\n...\nset 103.215.191.72 0 0 1\n1\n...\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("h3",{attrs:{id:"_4-33-nginx-与-lua-的开发-实战场景灰度发布场景演示-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-33-nginx-与-lua-的开发-实战场景灰度发布场景演示-3"}},[t._v("#")]),t._v(" 4-33 Nginx 与 Lua 的开发_实战场景灰度发布场景演示 3")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("nginx -tc /etc/nginx/nginx.conf\nnginx -s reload -c /etc/nginx/nginx.conf\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("h3",{attrs:{id:"_4-34-nginx-与-lua-的开发-实战场景灰度发布场景演示-4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-34-nginx-与-lua-的开发-实战场景灰度发布场景演示-4"}},[t._v("#")]),t._v(" 4-34 Nginx 与 Lua 的开发_实战场景灰度发布场景演示 4")]),t._v(" "),n("p",[t._v("测试效果")]),t._v(" "),n("h2",{attrs:{id:"第-5-章-nginx-架构篇"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-5-章-nginx-架构篇"}},[t._v("#")]),t._v(" 第 5 章 Nginx 架构篇")]),t._v(" "),n("p",[t._v("Nginx 常见问题和排错经验，实践应用场景中的方法处理 Nginx 安全，常见的应用层安全隐患，复杂访问控制，Nignx 的 sql 防注入安全策略,Nginx 的整体配置，搭建合理 Nginx 中间件架构配置步骤、策略 Nginx 性能优化:架构优化，操作系统优化、Nginx 优化等...")]),t._v(" "),n("h3",{attrs:{id:"_5-1-nginx-常见问题-架构篇介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-nginx-常见问题-架构篇介绍"}},[t._v("#")]),t._v(" 5-1 Nginx 常见问题_架构篇介绍")]),t._v(" "),n("p",[t._v("Nginx 常见问题：")]),t._v(" "),n("ol",[n("li",[t._v("相同 server_name 多个虚拟主机优先级访问")]),t._v(" "),n("li",[t._v("location 匹配优先级")]),t._v(" "),n("li",[t._v("tyr_files 使用")]),t._v(" "),n("li",[t._v("Nginx 的 alias 和 root 的区别")]),t._v(" "),n("li",[t._v("用什么方法传递用户的真实 IP")])]),t._v(" "),n("h3",{attrs:{id:"_5-2-nginx-常见问题-多个-server-name-中虚拟主机读取的优先级"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-nginx-常见问题-多个-server-name-中虚拟主机读取的优先级"}},[t._v("#")]),t._v(" 5-2 Nginx 常见问题__多个 server_name 中虚拟主机读取的优先级")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("# test_server1.conf\nserver {\n    listen       80;\n    server_name  testserver1 jeson.t.imoocc.io;\n    location / {\n        root   /opt/app/code1;\n        index  index.html index.htm;\n    }\n}\n\n# test_server2.conf\nserver {\n    listen       80;\n    server_name  testserver2 jeson.t.imoocc.io;\n    location / {\n        root   /opt/app/code2;\n        index  index.html index.htm;\n    }\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])]),n("p",[t._v("以上配置文件启动时，Nginx 仅仅是 warning，照样会启动。相同 server_name 的话，看谁先被读取(test_server1.conf>test_server2.conf>test_server5.conf)。")]),t._v(" "),n("h3",{attrs:{id:"_5-3-nginx-常见问题-多个-location-匹配的优先级-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-nginx-常见问题-多个-location-匹配的优先级-1"}},[t._v("#")]),t._v(" 5-3 Nginx 常见问题_多个 location 匹配的优先级 1")]),t._v(" "),n("p",[t._v("和下一节合并")]),t._v(" "),n("h3",{attrs:{id:"_5-4-nginx-常见问题-多个-location-匹配的优先级-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-nginx-常见问题-多个-location-匹配的优先级-2"}},[t._v("#")]),t._v(" 5-4 Nginx 常见问题_多个 location 匹配的优先级 2")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("=：进行普通字符精确匹配，也就是完全匹配\n^~：表示普通字符匹配，使用前缀匹配\n~ \\~*：表示执行一个正则匹配\n配置文件示例见`5-3`\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"_5-5-nginx-常见问题-try-files-使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-nginx-常见问题-try-files-使用"}},[t._v("#")]),t._v(" 5-5 Nginx 常见问题_try_files 使用")]),t._v(" "),n("p",[t._v("try_files：\n按顺序检查文件是否存在")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location / {\n    try_files $uri $uri/ /index.php;\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"_5-6-nginx-常见问题-alias-和-root-的使用区别"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-nginx-常见问题-alias-和-root-的使用区别"}},[t._v("#")]),t._v(" 5-6 Nginx 常见问题_alias 和 root 的使用区别")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location /requests_path-image/ {\n    root /local_path/image/;\n}\n存在的问题：\n请求：http://www.imooc.com/request_path/image/cat.png\nnginx会去找：/local_path/image/request_path/image/cat.png\n不符合实际需求。\n\nlocation /requests_path-image/ {\n    alias /local_path/image/;\n}\n实际情况：\n请求：http://www.imooc.com/request_path/image/cat.png\nnginx会去找：/local_path/image/cat.png\n符合实际需求。\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("p",[t._v("我的一句话总结：root 会拼接 path，alias 不会。")]),t._v(" "),n("h3",{attrs:{id:"_5-7-nginx-常见问题-如何获取用户真实的-ip-信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-nginx-常见问题-如何获取用户真实的-ip-信息"}},[t._v("#")]),t._v(" 5-7 Nginx 常见问题_如何获取用户真实的 ip 信息")]),t._v(" "),n("p",[t._v("最接近用户的那台服务器：set x_real_ip = $remote_addr，然后逐级传递")]),t._v(" "),n("h3",{attrs:{id:"_5-8-nginx-常见问题-nginx-中常见错误码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-8-nginx-常见问题-nginx-中常见错误码"}},[t._v("#")]),t._v(" 5-8 Nginx 常见问题_Nginx 中常见错误码")]),t._v(" "),n("ul",[n("li",[t._v("413 Request Entity Too Large\n——用户上传文件限制 client_max_body_size")]),t._v(" "),n("li",[t._v("502 bad gateway\n——后端服务无响应")]),t._v(" "),n("li",[t._v("504 Gateway Time-out\n——后端服务执行超时(Nginx 默认超时为 60 秒)")])]),t._v(" "),n("h3",{attrs:{id:"_5-9-nginx-的性能优化-内容介绍及性能优化考虑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-nginx-的性能优化-内容介绍及性能优化考虑"}},[t._v("#")]),t._v(" 5-9 Nginx 的性能优化_内容介绍及性能优化考虑")]),t._v(" "),n("ol",[n("li",[t._v("性能优化考虑点\n"),n("ol",[n("li",[t._v("当前系统结构瓶颈\n"),n("ul",[n("li",[t._v("观察指标、压力测试")])])]),t._v(" "),n("li",[t._v("了解业务模式\n"),n("ul",[n("li",[t._v("接口业务类型、系统层次化结构")])])]),t._v(" "),n("li",[t._v("性能与安全")])])]),t._v(" "),n("li",[t._v("压测工具 ab")]),t._v(" "),n("li",[t._v("系统与 Nginx 性能优化")])]),t._v(" "),n("h3",{attrs:{id:"_5-10-nginx-的性能优化-ab-压测工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-10-nginx-的性能优化-ab-压测工具"}},[t._v("#")]),t._v(" 5-10 Nginx 的性能优化_ab 压测工具")]),t._v(" "),n("p",[t._v("合并到下一节")]),t._v(" "),n("h3",{attrs:{id:"_5-11-nginx-的性能优化-ab-压测工具-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-11-nginx-的性能优化-ab-压测工具-1"}},[t._v("#")]),t._v(" 5-11 Nginx 的性能优化_ab 压测工具 1")]),t._v(" "),n("p",[t._v("安装："),n("code",[t._v("yum install httpd-tools")]),t._v("\n使用：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("ab -n 2000 -c 2 http://127.0.0.1/\n-n：总的请求数\n-c：并发数\n-k：是否开启长连接\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"_5-12-nginx-的性能优化-ab-压测工具-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-12-nginx-的性能优化-ab-压测工具-2"}},[t._v("#")]),t._v(" 5-12 Nginx 的性能优化_ab 压测工具 2")]),t._v(" "),n("p",[t._v("请求动态接口(sleepjava.jsp 里 sleep 了 5 秒)：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("ab -n 2000 -c 10 http://127.0.0.1/sleepjava.jsp\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("h3",{attrs:{id:"_5-13-nginx-的性能优化-ab-压测工具-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-13-nginx-的性能优化-ab-压测工具-3"}},[t._v("#")]),t._v(" 5-13 Nginx 的性能优化_ab 压测工具 3")]),t._v(" "),n("p",[t._v("将静态文件交给 Nginx：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("ab -n 2000 -c 10 http://127.0.0.1/jesonc.html\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("Nginx 处理静态资源非常快，所以要动静分离")]),t._v(" "),n("h3",{attrs:{id:"_5-14-nginx-的性能优化-系统与-nginx-性能优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-14-nginx-的性能优化-系统与-nginx-性能优化"}},[t._v("#")]),t._v(" 5-14 Nginx 的性能优化_系统与 Nginx 性能优化")]),t._v(" "),n("p",[t._v("系统与 Nginx 性能优化")]),t._v(" "),n("ul",[n("li",[t._v("网络")]),t._v(" "),n("li",[t._v("★ 系统：硬件")]),t._v(" "),n("li",[t._v("★ 服务：Nginx 本身")]),t._v(" "),n("li",[t._v("程序：Python、Java、PHP")]),t._v(" "),n("li",[t._v("数据库、底层服务")])]),t._v(" "),n("h3",{attrs:{id:"_5-15-nginx-的性能优化-文件句柄设置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-15-nginx-的性能优化-文件句柄设置"}},[t._v("#")]),t._v(" 5-15 Nginx 的性能优化_文件句柄设置")]),t._v(" "),n("p",[t._v("文件句柄：linux\\Unix 一切皆文件，文件句柄就是一个索引，用户每来一个请求，就会产生一个文件句柄。\n设置方式：系统全局性修改、用户局部性修改、进程局部性修改")]),t._v(" "),n("ul",[n("li",[t._v("系统全局修改和用户局部修改文件句柄数："),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim /etc/security/limits.conf\n# 在文件尾部添加\nroot soft nofile 65535  # 其实一般小设置10000就差不多了\nroot hard nofile 65535\n* soft nofile 25535 # *：所有用户\n* hard nofile 25535\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])])]),t._v(" "),n("li",[t._v("单独修改 Nginx 文件句柄数："),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim /etc/nginx/nginx.conf\n# 找到设置项：worker_rlimit_nofile;\nworker_rlimit_nofile = 65535;\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])])])]),t._v(" "),n("h3",{attrs:{id:"_5-16-nginx-的性能优化-cpu-亲和配置-1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-16-nginx-的性能优化-cpu-亲和配置-1"}},[t._v("#")]),t._v(" 5-16 Nginx 的性能优化_CPU 亲和配置 1")]),t._v(" "),n("p",[t._v('CPU 亲和：把进程通常不会在处理器之间频繁迁移的进程绑定到不同的 CPU 上，减少性能损耗\n查看有多少个 CPU：cat /proc/cpuinfo|grep "physical id"|sort|uniq|wc -l\n查看一个 CPU 有多少核：cat /proc/cpuinfo|grep "cpu cores"|uniq cpu cores\n查看 CPU 使用状况：top\n设置 Nginx 绑定 CPU：')]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim /etc/nginx/ningx.conf\n# 开始配置\nworker_processes 16; # 工作进程数，推荐和CPU核数相同\nworker_cpu_affinity 0000000000000001 0000000000000010 ... 1000000000000000; # 分别绑定0-15号CPU\n# 配置完成，重启\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("h3",{attrs:{id:"_5-17-nginx-的性能优化-cpu-亲和配置-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-17-nginx-的性能优化-cpu-亲和配置-2"}},[t._v("#")]),t._v(" 5-17 Nginx 的性能优化_CPU 亲和配置 2")]),t._v(" "),n("p",[t._v("查看 Nginx 使用的 CPU：ps -eo pid,args,psr | grep [n]ginx\n如果把 0000000000000001 改成 0000000000000010，那么第一个工作进程将会和第二个工作进程使用同一个 CPU 核心。")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("worker_processes 2;\nworker_cpu_affinity 1010101010101010 0101010101010101; # 分别使用偶数和奇数的CPU\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("worker_cpu_affinity auto; # Nginx1.9之后支持，自动分配\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("h3",{attrs:{id:"_5-18-nginx-的性能优化-nginx-通用配置优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-18-nginx-的性能优化-nginx-通用配置优化"}},[t._v("#")]),t._v(" 5-18 Nginx 的性能优化_Nginx 通用配置优化")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('user nginx; # 普通用户\nworker_processes 16;    # 和CPU核心一致\n\nerror_log  /var/log/nginx/error.log warn; # 日志等级,warn即可\npid        /var/run/nginx.pid;  # nginx管理启动文件\n\nworker_rlimit_nofile 35535; # 文件句柄数\n\nevents {\n    use epoll;  # 使用epoll\n    worker_connections  1024; # 限制每个woker能够处理的连接,防止内存泄漏\n}\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    charset utf-8;  # utf-8字符集\n    log_format  main ... # 日志格式\n    # access_log  /var/log/nginx/access.log  main;\n    access_log  off;    # 可以关闭日志,建议设置在server一级\n\n    sendfile        on; # 静态文件直接发送\n    keepalive_timeout  65;\n\n    gzip  on;\n    gzip_disable "MSIE [1-6]\\.";  # IE6不支持gzip\n    gzip_http_version 1.1;\n\n    ########\n    #Virtal Server\n    include /etc/nginx/conf.d/*.conf;\n}\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br")])]),n("h3",{attrs:{id:"_5-19-nginx-安全-基于-nginx-的安全章节内容介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-19-nginx-安全-基于-nginx-的安全章节内容介绍"}},[t._v("#")]),t._v(" 5-19 Nginx 安全_基于 Nginx 的安全章节内容介绍")]),t._v(" "),n("p",[t._v("基于 Nginx 架构的安全篇")]),t._v(" "),n("ol",[n("li",[t._v("常见的恶意行为")]),t._v(" "),n("li",[t._v("常见的应用层攻击手段")]),t._v(" "),n("li",[t._v("Nginx 防攻击策略")]),t._v(" "),n("li",[t._v("常见：Nginx+Lua 的安全 waf 防火墙")])]),t._v(" "),n("h3",{attrs:{id:"_5-20-nginx-安全-恶意行为控制手段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-20-nginx-安全-恶意行为控制手段"}},[t._v("#")]),t._v(" 5-20 Nginx 安全_恶意行为控制手段")]),t._v(" "),n("h4",{attrs:{id:"常见的恶意行为"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#常见的恶意行为"}},[t._v("#")]),t._v(" 常见的恶意行为")]),t._v(" "),n("ul",[n("li",[t._v("爬虫行为和恶意抓取、资源盗用")]),t._v(" "),n("li",[t._v("基础防盗链功能-不让恶意用户能轻易的爬取网站对外数据")]),t._v(" "),n("li",[t._v("secure_link_module-对手安全性提高加密验证和失效性，适合如核心重要数据")]),t._v(" "),n("li",[t._v("access_module-对后台、部分用户服务的数据提供 IP 防控")])]),t._v(" "),n("h3",{attrs:{id:"_5-21-nginx-安全-攻击手段之暴力破解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-21-nginx-安全-攻击手段之暴力破解"}},[t._v("#")]),t._v(" 5-21 Nginx 安全_攻击手段之暴力破解")]),t._v(" "),n("ul",[n("li",[t._v("后台密码撞库-通过猜测密码字典不断对后台系统登录性尝试，获取后台登录密码\n"),n("ul",[n("li",[t._v("方法一、后台登录密码复杂度")]),t._v(" "),n("li",[t._v("方法二、access_module-对后台提供 IP 防控")]),t._v(" "),n("li",[t._v("方法三、预警机制")])])])]),t._v(" "),n("h3",{attrs:{id:"_5-22-nginx-安全-文件上传漏洞"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-22-nginx-安全-文件上传漏洞"}},[t._v("#")]),t._v(" 5-22 Nginx 安全_文件上传漏洞")]),t._v(" "),n("ul",[n("li",[t._v("文件上传漏洞-利用可以上传文件的接口将恶意代码植入到服务器，再通过 url 去访问以执行代码\n"),n("ul",[n("li",[t._v("例子：http://www.imooc.com/upload/1.jpg/1.php Nginx 将 1.jpg 作为 php 代码执行")]),t._v(" "),n("li",[t._v("防止：")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("location ^~ /upload{\n    root /opt/app/images;\n    if($request_filename ~*(.*)\\.php){\n        return 403;\n    }\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])])])]),t._v(" "),n("h3",{attrs:{id:"_5-23-nginx-安全-sql-注入"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-23-nginx-安全-sql-注入"}},[t._v("#")]),t._v(" 5-23 Nginx 安全_SQL 注入")]),t._v(" "),n("p",[t._v("SQL 注入：利用未过滤/未审核用户输入的攻击方法，让应用运行本不应该运行的 SQL 代码")]),t._v(" "),n("h3",{attrs:{id:"_5-24-nginx-安全-sql-注入场景说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-24-nginx-安全-sql-注入场景说明"}},[t._v("#")]),t._v(" 5-24 Nginx 安全_SQL 注入场景说明")]),t._v(" "),n("p",[t._v("用户—http—>Nginx+Lua—Fastcgi—>PHP—SQL—>MariaDB")]),t._v(" "),n("h3",{attrs:{id:"_5-25-nginx-安全-场景准备-mariadb-和-lnmp-环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-25-nginx-安全-场景准备-mariadb-和-lnmp-环境"}},[t._v("#")]),t._v(" 5-25 Nginx 安全_场景准备 mariadb 和 lnmp 环境")]),t._v(" "),n("p",[t._v("安装流程："),n("code",[t._v("5-25/sql_show_txt")]),t._v("\n启动 mariadb：systemctl start mariadb\n连接 mariadb：mysql -uroot -p")]),t._v(" "),n("h3",{attrs:{id:"_5-26-nginx-安全-模拟-sql-注入场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-26-nginx-安全-模拟-sql-注入场景"}},[t._v("#")]),t._v(" 5-26 Nginx 安全_模拟 SQL 注入场景")]),t._v(" "),n("p",[t._v("php 代码文件见"),n("code",[t._v("5-26")]),t._v("\nusername=' or 1=1#"),n("br"),t._v("\n'#'在 mysql 中是注释的意思")]),t._v(" "),n("h3",{attrs:{id:"_5-27-nginx-安全-nginx-lua-防火墙功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-27-nginx-安全-nginx-lua-防火墙功能"}},[t._v("#")]),t._v(" 5-27 Nginx 安全_Nginx+LUA 防火墙功能")]),t._v(" "),n("p",[t._v("Nginx+Lua(WAF)：")]),t._v(" "),n("ul",[n("li",[t._v("拦截 Cookie 类型攻击")]),t._v(" "),n("li",[t._v("拦截异常 post 请求")]),t._v(" "),n("li",[t._v("拦截 cc 攻击(DDOS+伪装)")]),t._v(" "),n("li",[t._v("拦截 URL")]),t._v(" "),n("li",[t._v("拦截 arg")])]),t._v(" "),n("h3",{attrs:{id:"_5-28-nginx-安全-nginx-lua-防火墙防-sql-注入场景演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-28-nginx-安全-nginx-lua-防火墙防-sql-注入场景演示"}},[t._v("#")]),t._v(" 5-28 Nginx 安全_Nginx+LUA 防火墙防 sql 注入场景演示")]),t._v(" "),n("p",[t._v("合并到下一节")]),t._v(" "),n("h3",{attrs:{id:"_5-29-nginx-安全-复杂的访问攻击中-cc-攻击方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-29-nginx-安全-复杂的访问攻击中-cc-攻击方式"}},[t._v("#")]),t._v(" 5-29 Nginx 安全_复杂的访问攻击中 CC 攻击方式")]),t._v(" "),n("p",[t._v("lua 防火墙代码地址：https://github.com/loveshell/ngx_lua_waf")]),t._v(" "),n("p",[t._v("讲师操作：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd /opt/download/\n# yum install git\ngit clone https://github.com/loveshell/ngx_lua_waf.git\ncd ngx_lua_waf\nll\ncd /etc/nginx\nmv /opt/download/ngx_lua_waf/ ./waf/\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('# 文件：ngx_lua_waf/config.lua\nRulePath：规则路径,讲师改成了/etc/nginx/waf/wafconf/\nblack_fileExt：禁止上传文件类型\nCCDeny="off"：打开CC防御-on\nCCrate="100/60"：每分钟达到100次就屏蔽\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("h3",{attrs:{id:"_5-30-nginx-安全-nginx-版本更新和本身漏洞"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-30-nginx-安全-nginx-版本更新和本身漏洞"}},[t._v("#")]),t._v(" 5-30 Nginx 安全_Nginx 版本更新和本身漏洞")]),t._v(" "),n("p",[t._v("在官网可以看到更新：http://nginx.org/")]),t._v(" "),n("h3",{attrs:{id:"_5-31-nginx-架构总结-静态资源服务的功能设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-31-nginx-架构总结-静态资源服务的功能设计"}},[t._v("#")]),t._v(" 5-31 Nginx 架构总结_静态资源服务的功能设计")]),t._v(" "),n("p",[t._v("和下一节合并")]),t._v(" "),n("h3",{attrs:{id:"_5-32-nginx-架构总结-nginx-作为代理服务的需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-32-nginx-架构总结-nginx-作为代理服务的需求"}},[t._v("#")]),t._v(" 5-32 Nginx 架构总结_Nginx 作为代理服务的需求")]),t._v(" "),n("p",[t._v("和下一节合并")]),t._v(" "),n("h3",{attrs:{id:"_5-33-nginx-架构总结-需求设计评估"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-33-nginx-架构总结-需求设计评估"}},[t._v("#")]),t._v(" 5-33 Nginx 架构总结_需求设计评估")]),t._v(" "),n("p",[t._v("基于 Nginx 的中间件架构")]),t._v(" "),n("ol",[n("li",[t._v("了解需求\n"),n("ol",[n("li",[t._v("定义 Nginx 在服务体系中的角色：静态资源服务、代理服务、动静分离")]),t._v(" "),n("li",[t._v("静态资源服务的功能设计：浏览器缓存、类型分类、防盗链、流量限制、防资源盗用、压缩")]),t._v(" "),n("li",[t._v("代理服务：协议类型、正向代理、反向代理、负载均衡、代理缓存、头信息处理、分片请求、ProxyPass、LNMP")])])]),t._v(" "),n("li",[t._v("设计评估\n"),n("ol",[n("li",[t._v("硬件：CPU、内存、硬盘")]),t._v(" "),n("li",[t._v("系统：用户权限、日志目录存放")]),t._v(" "),n("li",[t._v("关联服务：LVS、keepalive、syslog、Fastcgi")])])]),t._v(" "),n("li",[t._v("配置注意事项\n合理配置\n了解原理\n关注日志")])]),t._v(" "),n("h2",{attrs:{id:"第-6-章-新特性篇"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-6-章-新特性篇"}},[t._v("#")]),t._v(" 第 6 章 新特性篇")]),t._v(" "),n("p",[t._v("本章节结合当前主流最新应用场景，或者基于 Nginx 版本更新带来的最新重要特性，讲解:Nginx 版本平滑升级、HTTP2.0 协议、gRPC 应用网关场景等等，作为新特性篇后续本章的内容将持续更新…")]),t._v(" "),n("h3",{attrs:{id:"_6-1-nginx-平滑升级实现和原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-nginx-平滑升级实现和原理"}},[t._v("#")]),t._v(" 6-1 Nginx 平滑升级实现和原理")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_6-2-nginx-进行版本平滑升级演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-nginx-进行版本平滑升级演示"}},[t._v("#")]),t._v(" 6-2 Nginx 进行版本平滑升级演示")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_6-3-http-协议版本及-http2-0-协议特性-grpc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-http-协议版本及-http2-0-协议特性-grpc"}},[t._v("#")]),t._v(" 6-3 HTTP 协议版本及 HTTP2.0 协议特性 gRPC")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_6-4-go-及-grpc-测试用例环境安装准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-go-及-grpc-测试用例环境安装准备"}},[t._v("#")]),t._v(" 6-4 GO 及 gRPC 测试用例环境安装准备")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_6-5-nginx-作为-grpc-应用网关配置案例演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-nginx-作为-grpc-应用网关配置案例演示"}},[t._v("#")]),t._v(" 6-5 Nginx 作为 gRPC 应用网关配置案例演示")]),t._v(" "),n("p",[t._v("缺")]),t._v(" "),n("h3",{attrs:{id:"_6-6-完结散花"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-完结散花"}},[t._v("#")]),t._v(" 6-6 完结散花")]),t._v(" "),n("p",[t._v("完结撒花...")])],1)}),[],!1,null,null,null);a.default=e.exports},883:function(t,a,s){t.exports=s.p+"assets/img/2-24HTTP连接和请求.86bbbc3b.jpg"},884:function(t,a,s){t.exports=s.p+"assets/img/4-21更新openssl的shell脚本.8f2b5cd4.jpg"}}]);