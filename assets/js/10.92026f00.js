(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{1015:function(s,t,a){"use strict";a.r(t);var v=a(12),r=Object(v.a)({},(function(){var s=this,t=s.$createElement,v=s._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"title"}),v("p",[s._v("视频名称：马哥Linux教程-2019全新LVS负载均衡实战"),v("br"),s._v("\n视频地址：https://www.bilibili.com/video/av33613512"),v("br"),s._v("\n我的评价：★★★★★")])]),s._v(" "),v("p",[s._v("[TOC]")]),s._v(" "),v("h2",{attrs:{id:"集群概念"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#集群概念"}},[s._v("#")]),s._v(" 集群概念")]),s._v(" "),v("ul",[v("li",[s._v("系统扩展方式：\n"),v("ul",[v("li",[s._v("Scale Up：向上扩展，增强")]),s._v(" "),v("li",[s._v("Scale Out：向外扩展，增加设备，调度分配问题，Cluster")])])]),s._v(" "),v("li",[s._v("Cluster：集群，为解决某个特定问题将多台计算机组合起来形成的单个系统")]),s._v(" "),v("li",[s._v("Linux Cluster类型：\n"),v("ul",[v("li",[s._v("LB：Load Blancing，负载均衡")]),s._v(" "),v("li",[s._v("HA：High Availiablity，高可用，SPOF(Single Point of Failure，单点失败问题)\n"),v("ul",[v("li",[s._v("MTBF：Mean Time Between Failure 平均无故障时间")]),s._v(" "),v("li",[s._v("MTTR：Mean Time To Restoration(repair)平均恢复前时间")]),s._v(" "),v("li",[s._v("A=MTBF/(MTBF+MTTR)：99% 99.5% 99.9% 99.99% 99.999%")])])]),s._v(" "),v("li",[s._v("HPC：High-performance computing，高性能 www.top500.org")])])]),s._v(" "),v("li",[s._v("分布式系统：\n"),v("ul",[v("li",[s._v("分布式存储：云盘")]),s._v(" "),v("li",[s._v("分布式计算：hadoop，spark")])])])]),s._v(" "),v("p",[s._v("集群和分布式：")]),s._v(" "),v("ul",[v("li",[s._v("单机结构：全栈老实人——累如狗")]),s._v(" "),v("li",[s._v("集群结构：一堆全栈老实人——凑合过")]),s._v(" "),v("li",[s._v("分布式：前端工程师+后端工程师——舒服")])]),s._v(" "),v("h3",{attrs:{id:"cluster分类"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#cluster分类"}},[s._v("#")]),s._v(" Cluster分类")]),s._v(" "),v("h4",{attrs:{id:"lb-cluster的实现"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lb-cluster的实现"}},[s._v("#")]),s._v(" LB Cluster的实现")]),s._v(" "),v("ul",[v("li",[s._v("硬件：\n"),v("ul",[v("li",[s._v("F5 Big-IP")]),s._v(" "),v("li",[s._v("Citrix Netscaler")]),s._v(" "),v("li",[s._v("A10 A10")])])]),s._v(" "),v("li",[s._v("软件：\n"),v("ul",[v("li",[s._v("lvs：Linux Virtual Server")]),s._v(" "),v("li",[s._v("nginx：支持七层调度")]),s._v(" "),v("li",[s._v("haproxy：支持七层调度")]),s._v(" "),v("li",[s._v("ats：apache traffic server，Yahoo捐助")]),s._v(" "),v("li",[s._v("perlbal：Perl 编写")]),s._v(" "),v("li",[s._v("pound")])])])]),s._v(" "),v("h4",{attrs:{id:"基于工作的协议层次划分"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#基于工作的协议层次划分"}},[s._v("#")]),s._v(" 基于工作的协议层次划分")]),s._v(" "),v("ul",[v("li",[s._v("传输层(通用)：DPORT\n"),v("ul",[v("li",[s._v("LVS：")]),s._v(" "),v("li",[s._v("nginx：stream")]),s._v(" "),v("li",[s._v("haproxy：mode tcp")])])]),s._v(" "),v("li",[s._v("应用层(专用)：针对特定协议，自定义的请求模型分类\n"),v("ul",[v("li",[s._v("proxy server：\n"),v("ul",[v("li",[s._v("http：nginx，httpd，haproxy(mode http)，...")]),s._v(" "),v("li",[s._v("fastcgi：nginx，httpd")]),s._v(" "),v("li",[s._v("mysql：mysql-proxy")])])])])])]),s._v(" "),v("h3",{attrs:{id:"cluster相关"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#cluster相关"}},[s._v("#")]),s._v(" Cluster相关")]),s._v(" "),v("ul",[v("li",[s._v("会话保持：负载均衡\n"),v("ul",[v("li",[s._v("(1)session sticky：同一用户调度固定服务器\n"),v("ul",[v("li",[s._v("Source IP：LVS sh算法(对某一特定服务而言)")]),s._v(" "),v("li",[s._v("Cookie")])])]),s._v(" "),v("li",[s._v("(2)session replication：每台服务器拥有全部session\n"),v("ul",[v("li",[s._v("session multicast cluster")])])]),s._v(" "),v("li",[s._v("(3)session server：专门的session服务器\n"),v("ul",[v("li",[s._v("Memcached，Redis")])])])])]),s._v(" "),v("li",[s._v("HA集群实现方案\n"),v("ul",[v("li",[s._v("keep alived：vrrp协议")]),s._v(" "),v("li",[s._v("ais：应用接口规范\n"),v("ul",[v("li",[s._v("heart beet")]),s._v(" "),v("li",[s._v("cman+rgmanager(RHCS)")]),s._v(" "),v("li",[s._v("coresync_pacemaker")])])])])])]),s._v(" "),v("h2",{attrs:{id:"lvs介绍"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs介绍"}},[s._v("#")]),s._v(" LVS介绍")]),s._v(" "),v("ul",[v("li",[s._v("LVS：Linux Virtual Server，负载调度器，集成在Linux内核，章文嵩\n"),v("ul",[v("li",[s._v("官网：http://www.linuxvirtualserver.org/ ，已经年久失修的官网")]),s._v(" "),v("li",[s._v("VS：Virtual Server，负责调度")]),s._v(" "),v("li",[s._v("RS：Real Server，负责真正提供服务")]),s._v(" "),v("li",[s._v("L4：四层路由器或交换机")])])]),s._v(" "),v("li",[s._v("工作原理：VS根据请求报文的目标IP和目标协议及端口将其调度转发至某RS，根据调度算法来挑选RS")]),s._v(" "),v("li",[s._v("iptables/netfilter：\n"),v("ul",[v("li",[s._v("iptables：用户空间的管理工具")]),s._v(" "),v("li",[s._v("netfilter：内核空间上的框架")]),s._v(" "),v("li",[s._v("流入：PREROUTING——>INPUT")]),s._v(" "),v("li",[s._v("流出：OUTPUT——>POSTROUTING")]),s._v(" "),v("li",[s._v("转发：PREROUTING——>FORWARD——>POSTROUTING")]),s._v(" "),v("li",[s._v("DNAT：目标地址转换；PREROUTING")])])])]),s._v(" "),v("h3",{attrs:{id:"lvs集群类型中的术语"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs集群类型中的术语"}},[s._v("#")]),s._v(" LVS集群类型中的术语")]),s._v(" "),v("ul",[v("li",[s._v("VS：Virtual Server，Director Server(DS)，Dispatcher(调度器)，Load Balancer")]),s._v(" "),v("li",[s._v("RS：Real Server(lvs)，upstream server(nginx)，backend server(haproxy)")]),s._v(" "),v("li",[s._v("CIP：Client IP")]),s._v(" "),v("li",[s._v("VIP：Virtual Server IP，VS外网的IP")]),s._v(" "),v("li",[s._v("DIP：Director IP，VS内网的IP")]),s._v(" "),v("li",[s._v("RIP：Real Server IP")]),s._v(" "),v("li",[s._v("访问流程：CIP<——>VIP==DIP<--\x3eRIP")])]),s._v(" "),v("h3",{attrs:{id:"lvs集群的类型"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs集群的类型"}},[s._v("#")]),s._v(" LVS集群的类型")]),s._v(" "),v("ul",[v("li",[s._v("lvs：ipvsadm/ipvs\n"),v("ul",[v("li",[s._v("ipvsadm：用户空间的命令行工具，规则管理器，用于管理集群服务及RealServer")]),s._v(" "),v("li",[s._v("ipvs：工作于内核空间netfiler的input钩子上的框架")])])]),s._v(" "),v("li",[s._v("lvs集群的类型：\n"),v("ul",[v("li",[s._v("lvs-nat：修改请求报文的目标IP，多目标IP的DNAT")]),s._v(" "),v("li",[s._v("lvs-dr：操纵封装新的MAC地址")]),s._v(" "),v("li",[s._v("lvs-tun：在原请求IP报文之外新加一个IP首部")]),s._v(" "),v("li",[s._v("lvs-fullnat：修改请求报文的源和目标IP")])])])]),s._v(" "),v("h4",{attrs:{id:"lvs-nat"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-nat"}},[s._v("#")]),s._v(" lvs-nat")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(888)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(889)}})]),s._v(" "),v("h4",{attrs:{id:"lvs-dr"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-dr"}},[s._v("#")]),s._v(" lvs-dr")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(890)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(891)}})]),s._v(" "),v("p",[s._v("两台LVS——>多个Nginx、多个haproxy——>然后才到应用服务器")]),s._v(" "),v("h4",{attrs:{id:"lvs-dr解决地址冲突"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-dr解决地址冲突"}},[s._v("#")]),s._v(" lvs-dr解决地址冲突")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(892)}})]),s._v(" "),v("h4",{attrs:{id:"lvs-tun"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-tun"}},[s._v("#")]),s._v(" lvs-tun")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(893)}})]),s._v(" "),v("h4",{attrs:{id:"lvs-fullnat"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-fullnat"}},[s._v("#")]),s._v(" lvs-fullnat")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(894)}})]),s._v(" "),v("h4",{attrs:{id:"lvs工作模式总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs工作模式总结"}},[s._v("#")]),s._v(" lvs工作模式总结")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(895)}})]),s._v(" "),v("h3",{attrs:{id:"ipvs-scheduler"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#ipvs-scheduler"}},[s._v("#")]),s._v(" ipvs scheduler")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(896)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(897)}})]),s._v(" "),v("h2",{attrs:{id:"lvs实现"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs实现"}},[s._v("#")]),s._v(" LVS实现")]),s._v(" "),v("p",[s._v("...")]),s._v(" "),v("h2",{attrs:{id:"ldirectord"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#ldirectord"}},[s._v("#")]),s._v(" ldirectord")]),s._v(" "),v("p",[s._v("...")]),s._v(" "),v("h2",{attrs:{id:"ipvs使用"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#ipvs使用"}},[s._v("#")]),s._v(" ipvs使用")]),s._v(" "),v("p",[s._v("注：lvs功能在linux内核中叫ipvs"),v("br"),s._v(" "),v("code",[s._v("yum install ipvsadm")])]),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(898)}})]),v("p"),s._v(" "),v("h3",{attrs:{id:"ipvsadm命令"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#ipvsadm命令"}},[s._v("#")]),s._v(" ipvsadm命令")]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(899)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(900)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(901)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(902)}})]),s._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{width:"640",src:a(903)}})]),s._v(" "),v("p",[s._v("保存规则的命令，应当写成"),v("code",[s._v("ipvsadm -Sn")]),s._v("，不加n的话，本机地址会被解析成127.0.0.1"),v("br"),s._v("\n看一下ipvsadm的service文件："),v("code",[s._v("cat /usr/lib/systemd/system/ipvsadm.service")])]),s._v(" "),v("h3",{attrs:{id:"lvs-nat案例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-nat案例"}},[s._v("#")]),s._v(" lvs-nat案例")]),s._v(" "),v("p",[s._v("lvs主机：172.20.0.200   192.168.30.200"),v("br"),s._v("\nweb1：192.168.30.27"),v("br"),s._v("\nweb2：192.168.30.17")]),s._v(" "),v("p",[s._v("lvs主机上执行：")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("yum install ipvsadm \nipvsadm -A -t 172.20.0.200:80 -s rr # rr指定调度算法为轮询\nipvsadm -Ln # 看一下集群服务\n# 添加rs到集群\nipvsadm -a -t 172.20.0.200:80 -r 192.168.30-17 -m\nipvsadm -a -t 172.20.0.200:80 -r 192.168.30-27 -m\n# 再看一下\nipvsadm -Ln\n# 讲师测试效果\ncurl 172.20.0.200 # 输出RS1\ncurl 172.20.0.200 # 输出RS2\ncurl 172.20.0.200 # 输出RS1\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br"),v("span",{staticClass:"line-number"},[s._v("2")]),v("br"),v("span",{staticClass:"line-number"},[s._v("3")]),v("br"),v("span",{staticClass:"line-number"},[s._v("4")]),v("br"),v("span",{staticClass:"line-number"},[s._v("5")]),v("br"),v("span",{staticClass:"line-number"},[s._v("6")]),v("br"),v("span",{staticClass:"line-number"},[s._v("7")]),v("br"),v("span",{staticClass:"line-number"},[s._v("8")]),v("br"),v("span",{staticClass:"line-number"},[s._v("9")]),v("br"),v("span",{staticClass:"line-number"},[s._v("10")]),v("br"),v("span",{staticClass:"line-number"},[s._v("11")]),v("br"),v("span",{staticClass:"line-number"},[s._v("12")]),v("br")])]),v("p",[s._v("如果要在lvs主机和各个rs之间再加一个路由器，就需要手动配置路由表，麻烦多了。")]),s._v(" "),v("h3",{attrs:{id:"lvs-dr案例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lvs-dr案例"}},[s._v("#")]),s._v(" lvs-dr案例")]),s._v(" "),v("p",[s._v("client：172.20.0.222"),v("br"),s._v("\nrouter：172.20.0.200 192.168.30.200"),v("br"),s._v("\nRS1：192.168.30.17\nRS2：192.168.30.27\nRS3：192.168.30.37")]),s._v(" "),v("p",[s._v("首先关闭三台RS的arp广播和响应，设置相同虚拟ip")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("echo 1 > /proc/sys/net/ipv4/conf/lo/arp_ignore\necho 1 > /proc/sys/net/ipv4/conf/all/arp_ignore\necho 2 > /proc/sys/net/ipv4/conf/lo/arp_annouce\necho 2 > /proc/sys/net/ipv4/conf/all/arp_annouce\nip a a 192.168.30.7/32 dev lo\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br"),v("span",{staticClass:"line-number"},[s._v("2")]),v("br"),v("span",{staticClass:"line-number"},[s._v("3")]),v("br"),v("span",{staticClass:"line-number"},[s._v("4")]),v("br"),v("span",{staticClass:"line-number"},[s._v("5")]),v("br")])]),v("p",[s._v("在lvs主机上进行配置调度")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("yum install ipvsadm\nipvsadm -A -t 192.168.30.7:80 -s rr\nipvsadm -a -t 192.168.30.7:80 -r 192.168.30.17 -g\nipvsadm -a -t 192.168.30.7:80 -r 192.168.30.27 -g\nipvsadm -a -t 192.168.30.7:80 -r 192.168.30.37 -g\nipvsadm -Ln\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br"),v("span",{staticClass:"line-number"},[s._v("2")]),v("br"),v("span",{staticClass:"line-number"},[s._v("3")]),v("br"),v("span",{staticClass:"line-number"},[s._v("4")]),v("br"),v("span",{staticClass:"line-number"},[s._v("5")]),v("br"),v("span",{staticClass:"line-number"},[s._v("6")]),v("br")])])])}),[],!1,null,null,null);t.default=r.exports},888:function(s,t,a){s.exports=a.p+"assets/img/lvs-nat模式.93672324.jpg"},889:function(s,t,a){s.exports=a.p+"assets/img/LVS的NAT工作模式.6ca2d378.jpg"},890:function(s,t,a){s.exports=a.p+"assets/img/lvs-dr模式-1.56e4972b.jpg"},891:function(s,t,a){s.exports=a.p+"assets/img/lvs-dr模式-2.efea3ab9.jpg"},892:function(s,t,a){s.exports=a.p+"assets/img/lvs-dr解决地址冲突.cb975dcb.jpg"},893:function(s,t,a){s.exports=a.p+"assets/img/lvs-tun模式.cc0bc0f4.jpg"},894:function(s,t,a){s.exports=a.p+"assets/img/lvs-funllnat模式.8de172c0.jpg"},895:function(s,t,a){s.exports=a.p+"assets/img/lvs工作模式总结.20c498b1.jpg"},896:function(s,t,a){s.exports=a.p+"assets/img/ipvs-scheduler-1.4cab70e0.jpg"},897:function(s,t,a){s.exports=a.p+"assets/img/ipvs-scheduler-2.b097bb92.jpg"},898:function(s,t,a){s.exports=a.p+"assets/img/ipvs包构成.dc6005ca.jpg"},899:function(s,t,a){s.exports=a.p+"assets/img/ipvsadm命令-1.c3f83816.jpg"},900:function(s,t,a){s.exports=a.p+"assets/img/ipvsadm命令-2.536acd9a.jpg"},901:function(s,t,a){s.exports=a.p+"assets/img/ipvsadm命令-3.7681076e.jpg"},902:function(s,t,a){s.exports=a.p+"assets/img/ipvsadm命令-4.c297acde.jpg"},903:function(s,t,a){s.exports=a.p+"assets/img/ipvsadm保存及重载规则.c8d33d04.jpg"}}]);