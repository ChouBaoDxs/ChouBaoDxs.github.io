(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{553:function(t,s,a){t.exports=a.p+"assets/img/1-1红包秒杀系统架构概览.3266c98a.jpg"},554:function(t,s,a){t.exports=a.p+"assets/img/3-4追溯事件和痕迹-发红包.08d36ced.jpg"},555:function(t,s,a){t.exports=a.p+"assets/img/3-5追溯事件和痕迹-收红包.68b22274.jpg"},556:function(t,s,a){t.exports=a.p+"assets/img/3-5追溯事件和痕迹-红包过期.aec23e6a.jpg"},557:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-挑出核心对象.db269371.jpg"},558:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-建立关系.fe6d6c4e.jpg"},559:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-建立关系2.ce690337.jpg"},560:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-用户规整.6283d739.jpg"},561:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-红包规整.2a70fe81.jpg"},562:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-红包规整后.709e8d9d.jpg"},563:function(t,s,a){t.exports=a.p+"assets/img/3-5骨干模型构建-最终规整.85f2b2fe.jpg"},564:function(t,s,a){t.exports=a.p+"assets/img/3-5寻找和添加参与者-人事物.169a9000.jpg"},565:function(t,s,a){t.exports=a.p+"assets/img/3-5添加角色.2a06c2fd.jpg"},566:function(t,s,a){t.exports=a.p+"assets/img/4-2账户表和流水表结构.34a74f27.jpg"},567:function(t,s,a){t.exports=a.p+"assets/img/4-3红包1比1数据库物理模型.79611f01.jpg"},568:function(t,s,a){t.exports=a.p+"assets/img/4-4优化后的红包物理模型.10c685b3.jpg"},569:function(t,s,a){t.exports=a.p+"assets/img/4-4最终版的红包物理模型.de3b6b4d.jpg"},570:function(t,s,a){t.exports=a.p+"assets/img/4-4红包物理模型概览.83ce9d25.jpg"},571:function(t,s,a){t.exports=a.p+"assets/img/5-2模型回顾.fe72ceb6.jpg"},572:function(t,s,a){t.exports=a.p+"assets/img/5-2红包系统应用架构.7c9348f2.jpg"},573:function(t,s,a){t.exports=a.p+"assets/img/5-4红包系统-本地缓存架构.672d468c.jpg"},574:function(t,s,a){t.exports=a.p+"assets/img/5-4红包系统-异步架构(引入消息队列).a0d672f3.jpg"},575:function(t,s,a){t.exports=a.p+"assets/img/5-4红包系统-数据库分片.a336fee9.jpg"},576:function(t,s,a){t.exports=a.p+"assets/img/5-5架构设计-本课程红包系统架构.65628bc9.jpg"},928:function(t,s,a){"use strict";a.r(s);var n=a(12),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("div",{staticClass:"custom-block danger"},[n("p",{staticClass:"title"}),n("p",[t._v("课程名称：3 小时极简春节抢红包之 Go 的实战"),n("br"),t._v("\n课程地址：http://www.imooc.com/learn/1101"),n("br"),t._v("\n简介：本课程以红包业务场景为背景，从业务需求和用例分析，到业务模型分析，产生核心骨干模型，再进一步架构设计和数据设计，完成红包业务系统的设计，包括各个子系统设计、子系统接口，并使用 golang 语言来实战开发，构建一个完整的红包业务系统。"),n("br"),t._v("\n我的补充：重点看看第 4 章数据库设计和第 5 章总体架构和设计(超卖方案中锁的选择)"),n("br"),t._v("\n别人的代码：https://gitee.com/wendell01/resk-pilot"),n("br"),t._v("\n我的评价：★★★★★")])]),t._v(" "),n("p",[t._v("[TOC]")]),t._v(" "),n("h2",{attrs:{id:"第-1-章-课程介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-1-章-课程介绍"}},[t._v("#")]),t._v(" 第 1 章 课程介绍")]),t._v(" "),n("p",[t._v("介绍本课程特色、每一章的重点和内容、预期目标和收获。以及一些前置知识和开发环境等基础知识。")]),t._v(" "),n("h3",{attrs:{id:"_1-1-课程简介-21-00"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-课程简介-21-00"}},[t._v("#")]),t._v(" 1-1 课程简介 (21:00)")]),t._v(" "),n("p",[t._v("历年春节红包大战")]),t._v(" "),n("ul",[n("li",[t._v("2014 年：微信红包率先点燃战火；除夕到初八；超过 800 万用户参与；超过 4000 万个红包被领取")]),t._v(" "),n("li",[t._v("2015 年：各种红包满天飞；微信、QQ、支付宝钱包、微博、百度、无秘；上百亿元红包；3 月 18 日都市爆笑喜剧电影《红包》")]),t._v(" "),n("li",[t._v("2016 年：红包硝烟越烧越旺；支付宝 2.688 亿，集五福活动；4.2 亿人，80.8 亿个，2015 年的 8 倍；每秒钟 40.9 万个，1.8 亿人参与摇一摇")]),t._v(" "),n("li",[t._v("2017 年：黑科技红包；VR、AR、抢红包成为春节必备")]),t._v(" "),n("li",[t._v("2018 年：京东加入；各显身手；支付宝 5 福瓜分 5 亿；淘宝天天迎红包分 10 亿；微信：黄金红包、话费红包；手机 QQ：2 亿现金+40 亿卡券；新浪微博：让红包飞；京东：福倒了；今日头条：7.5 亿红包雨")]),t._v(" "),n("li",[t._v("2019 年：百度接力春晚，关键词红包，19 亿；好运临门，星想事成，祝福祖国，梦想成真：9 亿，208 亿次；集好运卡、团员红包：10 亿；元宵节 2 亿")]),t._v(" "),n("li",[t._v("未来的 2020 年：今日头条短视频点赞红包？华为？蓝绿厂？刷脸红包？")])]),t._v(" "),n("h4",{attrs:{id:"课程简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#课程简介"}},[t._v("#")]),t._v(" 课程简介")]),t._v(" "),n("ul",[n("li",[t._v("红包业务为背景按照软件研发的流程：需求分析->概要设计->详细设计->开发->测试，后续可能有部署、运维")]),t._v(" "),n("li",[t._v("需求分析方法和用例定义方法")]),t._v(" "),n("li",[t._v("四色建模法和核心模型设计")]),t._v(" "),n("li",[t._v("系统架构设计")]),t._v(" "),n("li",[t._v("数据库物理模型设计")]),t._v(" "),n("li",[t._v("Golang 编程实践")]),t._v(" "),n("li",[t._v("资金交易安全问题探讨")]),t._v(" "),n("li",[t._v("超卖问题的解决方案")]),t._v(" "),n("li",[t._v("表结构设计中的性能优化考虑")]),t._v(" "),n("li",[t._v("红包拆解和红包算法")]),t._v(" "),n("li",[t._v("系统设计和算法的选择")])]),t._v(" "),n("h4",{attrs:{id:"红包秒杀系统架构概览"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包秒杀系统架构概览"}},[t._v("#")]),t._v(" 红包秒杀系统架构概览")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(553)}})]),t._v(" "),n("h4",{attrs:{id:"红包系统演进之路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统演进之路"}},[t._v("#")]),t._v(" 红包系统演进之路")]),t._v(" "),n("ul",[n("li",[t._v("满足红包业务需求。快速迭代上线")]),t._v(" "),n("li",[t._v("出现超卖现象，事务锁来帮忙")]),t._v(" "),n("li",[t._v("流量增加，收红包出现性能瓶颈，改为乐观锁，性能提高 3 倍")]),t._v(" "),n("li",[t._v("流量继续增加，乐观锁也扛不住了，那就上缓存吧")]),t._v(" "),n("li",[t._v("缓存还没跑溜呢,服务器挂了,数据丢失了?")]),t._v(" "),n("li",[t._v("分布式消息队列来解决异步写")]),t._v(" "),n("li",[t._v("数据分片来解决数据库横向扩展?")]),t._v(" "),n("li",[t._v("Golang 编码实战从 0 到 1 构建红包秒杀系统")])]),t._v(" "),n("h4",{attrs:{id:"课程能学到什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#课程能学到什么"}},[t._v("#")]),t._v(" 课程能学到什么？")]),t._v(" "),n("p",[t._v("1.红包业务系统的需求分析方法和用例定义方法 2.学习四色建模法的基本知识,并结合红包业务场景把需求转化为业务模型来深入学习四色建模方法。 3.学习在四色建模法建模过程中如何绘制时间轴事件模型图? 4.通过业务模型如何来拆分业务系统模块?然后通过业务模型来学习如何来定义业务边界? 5.从业务模型和架构目标和愿景来学习架构设计过程、设计方法? 6.学习如何从业务模型推导物理模型? 7.如何从数据库物理模型设计上和系统架构设计上来优化性能? 8.如何解决资金交易安全(超卖)问题和资金交易上的性能优化?并结合超卖方案来学习使用 Golang 编程语言来做基准测试。 9.如何在不同的场景和时机中设计和应用红包算法? 10.学习 Golang 项目如何构建? 11.在 Golang 中如何设计和解决基础公共资源的访问问题? 12.学习使用 Golang 接口来设计基础资源加载和启动的基础设施组件,学习对基础资源组件生命周期的管理的设计?")]),t._v(" "),n("h4",{attrs:{id:"课程章节简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#课程章节简介"}},[t._v("#")]),t._v(" 课程章节简介")]),t._v(" "),n("p",[t._v("第一章 课程介绍\n第二章 业务场景需求分析\n第三章 业务模型分析和设计\n第四章 数据库设计\n第五章 总体架构和设计\n第六章 Golang 编码实践\n第七章 课程总结")]),t._v(" "),n("h2",{attrs:{id:"第-2-章-业务场景需求分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-2-章-业务场景需求分析"}},[t._v("#")]),t._v(" 第 2 章 业务场景需求分析")]),t._v(" "),n("p",[t._v("本章内容主要了解和熟悉红包业务、发红包、抢红包、摇红包业务场景、需求分析和用例分析，分析出红包业务场景的各个子业务的定义。")]),t._v(" "),n("h3",{attrs:{id:"_2-1-红包业务场景需求分析大纲和需求概述-08-11"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-红包业务场景需求分析大纲和需求概述-08-11"}},[t._v("#")]),t._v(" 2-1 红包业务场景需求分析大纲和需求概述 (08:11)")]),t._v(" "),n("h4",{attrs:{id:"本章课程大纲"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#本章课程大纲"}},[t._v("#")]),t._v(" 本章课程大纲")]),t._v(" "),n("p",[t._v("红包业务场景：")]),t._v(" "),n("ul",[n("li",[t._v("场景概述；")]),t._v(" "),n("li",[t._v("场景分析；")]),t._v(" "),n("li",[t._v("用例分析和定义：收、发(抢、摇)红包")])]),t._v(" "),n("h4",{attrs:{id:"红包业务场景分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包业务场景分析"}},[t._v("#")]),t._v(" 红包业务场景分析")]),t._v(" "),n("ul",[n("li",[t._v("场景概述")]),t._v(" "),n("li",[t._v("场景分类：祝福、庆祝、营销、显摆、曝光、求问等")]),t._v(" "),n("li",[t._v("场景分析：手气红包；固定红包；抢；摇；")])]),t._v(" "),n("h3",{attrs:{id:"_2-2-用例定义和分析的方法-04-05"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-用例定义和分析的方法-04-05"}},[t._v("#")]),t._v(" 2-2 用例定义和分析的方法 (04:05)")]),t._v(" "),n("h4",{attrs:{id:"用例定义的主要元素"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用例定义的主要元素"}},[t._v("#")]),t._v(" 用例定义的主要元素")]),t._v(" "),n("ul",[n("li",[t._v('用例名称：简单来说就是"需求名称"')]),t._v(" "),n("li",[t._v("场景概述：一句话描述需求")]),t._v(" "),n("li",[t._v("用例描述：业务场景、流程")]),t._v(" "),n("li",[t._v("用例价值：需求的价值，是一个可选项")]),t._v(" "),n("li",[t._v("约束和限制：要遵循的规则、限制等")])]),t._v(" "),n("h3",{attrs:{id:"_2-3-发红包业务场景概述-01-50"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-发红包业务场景概述-01-50"}},[t._v("#")]),t._v(" 2-3 发红包业务场景概述 (01:50)")]),t._v(" "),n("p",[t._v("按红包类型：普通红包和碰运气红包")]),t._v(" "),n("h3",{attrs:{id:"_2-4-发红包业务用例定义-09-23"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-发红包业务用例定义-09-23"}},[t._v("#")]),t._v(" 2-4 发红包业务用例定义 (09:23)")]),t._v(" "),n("h4",{attrs:{id:"正确逻辑定义-正确发送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#正确逻辑定义-正确发送"}},[t._v("#")]),t._v(" 正确逻辑定义-正确发送")]),t._v(" "),n("ul",[n("li",[t._v("场景：用户发送一定数量和金额的红包给 1 个人或多个人")]),t._v(" "),n("li",[t._v("用例描述：1.选择收红包目标；2.确定红包类型，设置金额和数量；3.后端系统接收到请求；4.系统向红包中间商(虚拟出来的逻辑存在，其实就是后台红包系统实时生成红包的过程)购买红包；5.用户支付总金额给红包中间商，扣除用户的钱包或资金账户；6.将红包的秒杀活动发布")]),t._v(" "),n("li",[t._v("约束限制：合法用户，红包数量上限 100，红包金额上限 100(这会不会太少了)")])]),t._v(" "),n("h4",{attrs:{id:"异常逻辑定义-1-用户余额不足"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#异常逻辑定义-1-用户余额不足"}},[t._v("#")]),t._v(" 异常逻辑定义 1-用户余额不足")]),t._v(" "),n("ul",[n("li",[t._v("场景：发红包用户的账户余额不足")]),t._v(" "),n("li",[t._v("用例描述：...需要将异常告知用户，终止发红包流程")]),t._v(" "),n("li",[t._v("约束限制：余额不小于红包总金额")])]),t._v(" "),n("h4",{attrs:{id:"异常逻辑定义-2-红包未接收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#异常逻辑定义-2-红包未接收"}},[t._v("#")]),t._v(" 异常逻辑定义 2-红包未接收")]),t._v(" "),n("ul",[n("li",[t._v("场景：当用户发送红包之后，红包未被接收直到过期")]),t._v(" "),n("li",[t._v("用例描述：...需要将剩余红包金额退回")])]),t._v(" "),n("h3",{attrs:{id:"_2-5-收红包业务用例定义-05-24"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-收红包业务用例定义-05-24"}},[t._v("#")]),t._v(" 2-5 收红包业务用例定义 (05:24)")]),t._v(" "),n("p",[t._v("收红包和秒杀商品类似\n收红包目标：单向红包(指定红包)；群发红包\n按收红包方式：抢红包；摇红包")]),t._v(" "),n("h4",{attrs:{id:"正常逻辑定义-抢到红包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#正常逻辑定义-抢到红包"}},[t._v("#")]),t._v(" 正常逻辑定义-抢到红包")]),t._v(" "),n("ul",[n("li",[t._v("场景：当用户点击红包链接后，抢到红包，金额存入账户")]),t._v(" "),n("li",[t._v("用例描述：...")]),t._v(" "),n("li",[t._v("约束限制：合法用户；群内用户")])]),t._v(" "),n("h4",{attrs:{id:"异常逻辑定义-未抢到红包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#异常逻辑定义-未抢到红包"}},[t._v("#")]),t._v(" 异常逻辑定义-未抢到红包")]),t._v(" "),n("ul",[n("li",[t._v("场景：当用户点击红包链接后，未抢到红包")]),t._v(" "),n("li",[t._v("用例描述：...")]),t._v(" "),n("li",[t._v("约束限制：合法用户；群内用户")])]),t._v(" "),n("h4",{attrs:{id:"摇红包场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#摇红包场景"}},[t._v("#")]),t._v(" 摇红包场景")]),t._v(" "),n("ul",[n("li",[t._v("和抢红包的异同：特殊情况、流程一致")]),t._v(" "),n("li",[t._v("摇红包特性：终端、量多、持续、不确定、营销")]),t._v(" "),n("li",[t._v("用例定义：参考抢红包定义")])]),t._v(" "),n("h3",{attrs:{id:"_2-6-红包资金账户的业务需求和设计需求-05-12"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-红包资金账户的业务需求和设计需求-05-12"}},[t._v("#")]),t._v(" 2-6 红包资金账户的业务需求和设计需求 (05:12)")]),t._v(" "),n("h4",{attrs:{id:"红包资金账户业务需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包资金账户业务需求"}},[t._v("#")]),t._v(" 红包资金账户业务需求")]),t._v(" "),n("ul",[n("li",[t._v("满足用户发红包和收红包业务过程中用于红包资金的交易和记账")])]),t._v(" "),n("h4",{attrs:{id:"红包资金账户设计需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包资金账户设计需求"}},[t._v("#")]),t._v(" 红包资金账户设计需求")]),t._v(" "),n("ul",[n("li",[t._v("资金交易\n"),n("ul",[n("li",[t._v("交易需求：账户、余额")]),t._v(" "),n("li",[t._v("记账和对账：记录资金交易过程和行为")]),t._v(" "),n("li",[t._v("交易的参与者：交易主体和交易对象")])])])]),t._v(" "),n("h3",{attrs:{id:"_2-7-红包业务场景总结-04-01"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-红包业务场景总结-04-01"}},[t._v("#")]),t._v(" 2-7 红包业务场景总结 (04:01)")]),t._v(" "),n("p",[t._v("红包是小额金融产品：充值卡、购物卡")]),t._v(" "),n("ul",[n("li",[t._v("发红包：从中间商购买和发布")]),t._v(" "),n("li",[t._v("收红包：秒杀、兑换")])]),t._v(" "),n("p",[t._v("红包资金账户满足用于红包业务资金的交易和记账")]),t._v(" "),n("h2",{attrs:{id:"第-3-章-业务模型分析和设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-3-章-业务模型分析和设计"}},[t._v("#")]),t._v(" 第 3 章 业务模型分析和设计")]),t._v(" "),n("p",[t._v("本章内容通过四色建模法和时间轴事件模型图绘制方法，对红包业务场景为基础进行分析，进一步使用工具来画出模型，构建出核心模型，以及模型之间的关系，产生核心骨干模型。")]),t._v(" "),n("h3",{attrs:{id:"_3-1-红包业务模型分析概述-02-57"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-红包业务模型分析概述-02-57"}},[t._v("#")]),t._v(" 3-1 红包业务模型分析概述 (02:57)")]),t._v(" "),n("p",[t._v("本章大纲概述")]),t._v(" "),n("ul",[n("li",[t._v("模型分析概述\n"),n("ul",[n("li",[t._v("四色建模法介绍")]),t._v(" "),n("li",[t._v("红包业务总体模型分析和设计")])])]),t._v(" "),n("li",[t._v("子业务模型设计\n"),n("ul",[n("li",[t._v("红包资金账户模型分析和设计")]),t._v(" "),n("li",[t._v("发红包模型分析和设计")]),t._v(" "),n("li",[t._v("收红包模型分析和设计")])])])]),t._v(" "),n("h3",{attrs:{id:"_3-2-红包业务模型分析-四色建模法-四个概念-03-32"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-红包业务模型分析-四色建模法-四个概念-03-32"}},[t._v("#")]),t._v(" 3-2 红包业务模型分析-四色建模法-四个概念 (03:32)")]),t._v(" "),n("h4",{attrs:{id:"时标性对象-时刻时段原型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#时标性对象-时刻时段原型"}},[t._v("#")]),t._v(" 时标性对象-时刻时段原型")]),t._v(" "),n("ul",[n("li",[t._v("业务在时间轴上发生的需要跟踪的"),n("code",[t._v("事件")]),t._v("留下的"),n("code",[t._v("痕迹")])]),t._v(" "),n("li",[t._v("图例用"),n("span",{staticStyle:{color:"#E080D4"}},[t._v("粉色")]),t._v("来表示")])]),t._v(" "),n("h4",{attrs:{id:"实体对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实体对象"}},[t._v("#")]),t._v(" 实体对象")]),t._v(" "),n("ul",[n("li",[t._v("业务事件中的参与者：人、事、物")]),t._v(" "),n("li",[t._v("图例用"),n("span",{staticStyle:{color:"#83F8A3"}},[t._v("绿色")]),t._v("来表示")])]),t._v(" "),n("h4",{attrs:{id:"角色"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#角色"}},[t._v("#")]),t._v(" 角色")]),t._v(" "),n("ul",[n("li",[t._v("实体在业务流程中所扮演的角色")]),t._v(" "),n("li",[t._v("图例用"),n("span",{staticStyle:{color:"#ECC441"}},[t._v("黄色")]),t._v("来表示")])]),t._v(" "),n("h4",{attrs:{id:"描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#描述"}},[t._v("#")]),t._v(" 描述")]),t._v(" "),n("ul",[n("li",[t._v("说明实体、时标性对象的属性")]),t._v(" "),n("li",[t._v("图例用"),n("span",{staticStyle:{color:"#5199F2"}},[t._v("蓝色")]),t._v("来表示")])]),t._v(" "),n("h3",{attrs:{id:"_3-3-红包业务模型分析四色建模法-五个步骤-02-21"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-红包业务模型分析四色建模法-五个步骤-02-21"}},[t._v("#")]),t._v(" 3-3 红包业务模型分析四色建模法-五个步骤 (02:21)")]),t._v(" "),n("p",[t._v("五个步骤来分析和设计：")]),t._v(" "),n("ul",[n("li",[t._v("第一步：寻找需要追溯的"),n("code",[t._v("事件和足迹")]),t._v("，识别出"),n("code",[t._v("时标性对象")])]),t._v(" "),n("li",[t._v("第二步：整理时标对象，得到"),n("code",[t._v("模型骨干")])]),t._v(" "),n("li",[t._v("第三步：寻找和分析出这些时间的参与者："),n("code",[t._v("人、事、物")])]),t._v(" "),n("li",[t._v("第四步：抽象出"),n("code",[t._v("角色")]),t._v("，并插入其中")]),t._v(" "),n("li",[t._v("第五步：添加对象"),n("code",[t._v("描述性")]),t._v("信息")])]),t._v(" "),n("h3",{attrs:{id:"_3-4-红包业务四色建模法模型分析和设计-13-45"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-红包业务四色建模法模型分析和设计-13-45"}},[t._v("#")]),t._v(" 3-4 红包业务四色建模法模型分析和设计 (13:45)")]),t._v(" "),n("h4",{attrs:{id:"第一步-追溯事件和痕迹-发红包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第一步-追溯事件和痕迹-发红包"}},[t._v("#")]),t._v(" 第一步：追溯事件和痕迹-发红包")]),t._v(" "),n("ul",[n("li",[t._v("以业务事件发生的事件顺序，找出事件和痕迹\n"),n("ul",[n("li",[t._v("怎么找？人、时间、地点串联起来，找出故事证据")]),t._v(" "),n("li",[t._v("谁，在什么时候，在哪里，对(为)谁，做了什么事情，获得了什么收益？")])])])]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(554)}})]),t._v(" "),n("h3",{attrs:{id:"_3-5-红包业务四色建模法模型分析和设计-12-34"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-红包业务四色建模法模型分析和设计-12-34"}},[t._v("#")]),t._v(" 3-5 红包业务四色建模法模型分析和设计 (12:34)")]),t._v(" "),n("h4",{attrs:{id:"第一步-追溯事件和痕迹-收红包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第一步-追溯事件和痕迹-收红包"}},[t._v("#")]),t._v(" 第一步：追溯事件和痕迹-收红包")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(555)}})]),t._v(" "),n("h4",{attrs:{id:"第一步-追溯事件和痕迹-红包过期"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第一步-追溯事件和痕迹-红包过期"}},[t._v("#")]),t._v(" 第一步：追溯事件和痕迹-红包过期")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(556)}})]),t._v(" "),n("h4",{attrs:{id:"第二步-骨干模型构建-挑出核心对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-骨干模型构建-挑出核心对象"}},[t._v("#")]),t._v(" 第二步：骨干模型构建-挑出核心对象")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(557)}})]),t._v(" "),n("h4",{attrs:{id:"第二步-骨干模型构建-建立关系"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-骨干模型构建-建立关系"}},[t._v("#")]),t._v(" 第二步：骨干模型构建-建立关系")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(558)}})]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(559)}})]),t._v(" "),n("h4",{attrs:{id:"第二步-骨干模型构建-用户规整"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-骨干模型构建-用户规整"}},[t._v("#")]),t._v(" 第二步：骨干模型构建-用户规整")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(560)}})]),t._v("\n收款记录、支付记录、退款记录都属于`账户流水`，余额记录属于`账户属性`，规整后就只剩`用户、账户、账户流水`\n"),n("h4",{attrs:{id:"第二步-骨干模型构建-红包规整"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-骨干模型构建-红包规整"}},[t._v("#")]),t._v(" 第二步：骨干模型构建-红包规整")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(561)}})]),t._v(" "),n("p",[t._v("商品——可售卖商品"),n("br"),t._v("\n红包记录——红包预定单"),n("br"),t._v("\n红包过期记录——红包退款订单"),n("br"),t._v("\n规整后如下：")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(562)}})]),t._v(" "),n("h4",{attrs:{id:"第二步-骨干模型构建-最终规整"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-骨干模型构建-最终规整"}},[t._v("#")]),t._v(" 第二步：骨干模型构建-最终规整")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(563)}})]),t._v(" "),n("h4",{attrs:{id:"第三步-寻找和添加参与者-人事物"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第三步-寻找和添加参与者-人事物"}},[t._v("#")]),t._v(" 第三步：寻找和添加参与者-人事物")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(564)}})]),t._v(" "),n("h4",{attrs:{id:"第四步-添加角色"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第四步-添加角色"}},[t._v("#")]),t._v(" 第四步：添加角色")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(565)}})]),t._v(" "),n("h4",{attrs:{id:"第五步-添加描述性信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第五步-添加描述性信息"}},[t._v("#")]),t._v(" 第五步：添加描述性信息")]),t._v(" "),n("p",[t._v("描述性信息：")]),t._v(" "),n("ul",[n("li",[t._v("各种对象的主要特征属性")]),t._v(" "),n("li",[t._v("主要的属性")])]),t._v(" "),n("h3",{attrs:{id:"_3-6-红包模型分析总结-02-42"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-红包模型分析总结-02-42"}},[t._v("#")]),t._v(" 3-6 红包模型分析总结 (02:42)")]),t._v(" "),n("ul",[n("li",[t._v("四色建模法核心方法")]),t._v(" "),n("li",[t._v("红包业务模型\n"),n("ul",[n("li",[t._v("资金账户模型：账户、流水、用户")]),t._v(" "),n("li",[t._v("红包模型：红包、秒杀活动、流转、库存、用户")])])])]),t._v(" "),n("h2",{attrs:{id:"第-4-章-数据库设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-4-章-数据库设计"}},[t._v("#")]),t._v(" 第 4 章 数据库设计")]),t._v(" "),n("p",[t._v("本章内容主要介绍红包账户的数据库表设计。")]),t._v(" "),n("h3",{attrs:{id:"_4-1-数据库表设计-业务模型回顾-02-55"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-数据库表设计-业务模型回顾-02-55"}},[t._v("#")]),t._v(" 4-1 数据库表设计-业务模型回顾 (02:55)")]),t._v(" "),n("h4",{attrs:{id:"大纲概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#大纲概述"}},[t._v("#")]),t._v(" 大纲概述")]),t._v(" "),n("ul",[n("li",[t._v("红包业务模型回顾"),n("br"),t._v(" "),n("ul",[n("li",[t._v("见 3-5 第四步的图：添加角色")])])]),t._v(" "),n("li",[t._v("业务模型和数据库物理模型的关系"),n("br"),t._v(" "),n("ul",[n("li",[t._v("数据库物理模型和领域业务模型："),n("code",[t._v("可以保持一致")])]),t._v(" "),n("li",[t._v("数据库物理模型和领域业务模型："),n("code",[t._v("可以不一致")])]),t._v(" "),n("li",[t._v("根据业务特点和技术要求："),n("code",[t._v("合理地调整")])])])]),t._v(" "),n("li",[t._v("资金账户模型推导和数据库表设计")]),t._v(" "),n("li",[t._v("红包模型推导和数据库表设计")])]),t._v(" "),n("h3",{attrs:{id:"_4-2-数据库表设计-资金账户物理模型推导和设计-04-41"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-数据库表设计-资金账户物理模型推导和设计-04-41"}},[t._v("#")]),t._v(" 4-2 数据库表设计-资金账户物理模型推导和设计 (04:41)")]),t._v(" "),n("h4",{attrs:{id:"资金账户数据库表设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#资金账户数据库表设计"}},[t._v("#")]),t._v(" 资金账户数据库表设计")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("account")]),t._v(" "),n("th",[t._v("account_log")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("account_no"),n("br"),t._v("user_id"),n("br"),t._v("username"),n("br"),t._v("balance")]),t._v(" "),n("td",[t._v("account_no"),n("br"),t._v("trade_no"),n("br"),t._v("user_id"),n("br"),t._v("username")])])])]),t._v(" "),n("h4",{attrs:{id:"tips-合理使用冗余字段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tips-合理使用冗余字段"}},[t._v("#")]),t._v(" tips——合理使用冗余字段")]),t._v(" "),n("p",[t._v("user_id 关联到用户表，username 作为冗余字段，减少对用户表的关联查询")]),t._v(" "),n("h4",{attrs:{id:"账户表和流水表结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#账户表和流水表结构"}},[t._v("#")]),t._v(" 账户表和流水表结构")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(566)}})]),t._v(" "),n("h4",{attrs:{id:"账户物理模型-账户表描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#账户物理模型-账户表描述"}},[t._v("#")]),t._v(" 账户物理模型-账户表描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("字段名称")]),t._v(" "),n("th",[t._v("数据类型")]),t._v(" "),n("th",[t._v("描述")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("account_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("账户编号")])]),t._v(" "),n("tr",[n("td",[t._v("account_name")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("账户名称")])]),t._v(" "),n("tr",[n("td",[t._v("account_type")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("账户类型")])]),t._v(" "),n("tr",[n("td",[t._v("currency_code")]),t._v(" "),n("td",[t._v("char")]),t._v(" "),n("td",[t._v("货币类型编码")])]),t._v(" "),n("tr",[n("td",[t._v("balance")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("账户可用余额")])]),t._v(" "),n("tr",[n("td",[t._v("user_id")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("用户编号")])]),t._v(" "),n("tr",[n("td",[t._v("username")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("账户名称")])]),t._v(" "),n("tr",[n("td",[t._v("status")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("账户状态")])]),t._v(" "),n("tr",[n("td",[t._v("created_at")]),t._v(" "),n("td",[t._v("datetime")]),t._v(" "),n("td",[t._v("创建时间")])]),t._v(" "),n("tr",[n("td",[t._v("updated_at")]),t._v(" "),n("td",[t._v("datetime")]),t._v(" "),n("td",[t._v("更新时间")])])])]),t._v(" "),n("h4",{attrs:{id:"账户物理模型-账户流水表描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#账户物理模型-账户流水表描述"}},[t._v("#")]),t._v(" 账户物理模型-账户流水表描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("字段名称")]),t._v(" "),n("th",[t._v("数据类型")]),t._v(" "),n("th",[t._v("描述")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("trade_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("交易单号")])]),t._v(" "),n("tr",[n("td",[t._v("log_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("流水编号")])]),t._v(" "),n("tr",[n("td",[t._v("account_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("账户编号")])]),t._v(" "),n("tr",[n("td",[t._v("target_account_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("目标账户编号")])]),t._v(" "),n("tr",[n("td",[t._v("user_id")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("用户编号")])]),t._v(" "),n("tr",[n("td",[t._v("target_user_id")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("目标用户编号")])]),t._v(" "),n("tr",[n("td",[t._v("amount")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("交易金额")])]),t._v(" "),n("tr",[n("td",[t._v("balance")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("交易后余额")])]),t._v(" "),n("tr",[n("td",[t._v("change_type")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("流水交易类型")])]),t._v(" "),n("tr",[n("td",[t._v("change_flag")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("交易变化标识")])]),t._v(" "),n("tr",[n("td",[t._v("status")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("交易状态")])]),t._v(" "),n("tr",[n("td",[t._v("decs")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("交易描述")])]),t._v(" "),n("tr",[n("td",[t._v("created_at")]),t._v(" "),n("td",[t._v("datetime")]),t._v(" "),n("td",[t._v("创建时间")])])])]),t._v(" "),n("h3",{attrs:{id:"_4-3-数据库表设计-红包-04-02"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-数据库表设计-红包-04-02"}},[t._v("#")]),t._v(" 4-3 数据库表设计-红包 (04:02)")]),t._v(" "),n("h4",{attrs:{id:"红包-1-比-1-数据库物理模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包-1-比-1-数据库物理模型"}},[t._v("#")]),t._v(" 红包 1 比 1 数据库物理模型")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(567)}})]),t._v(" "),n("h4",{attrs:{id:"发红包时数据库操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发红包时数据库操作"}},[t._v("#")]),t._v(" 发红包时数据库操作")]),t._v(" "),n("ul",[n("li",[t._v("插入商品、库存、订单、活动共 4 次")]),t._v(" "),n("li",[t._v("查询用户的资金账户信息 1 次")]),t._v(" "),n("li",[t._v("更新账户余额 1 次，插入账户流出 1 次")]),t._v(" "),n("li",[t._v("查询活动记录 1 次")]),t._v(" "),n("li",[t._v("总计：5 次插入、1 次更新、2 次查询，共 8 次操作")])]),t._v(" "),n("h4",{attrs:{id:"收红包时数据库操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#收红包时数据库操作"}},[t._v("#")]),t._v(" 收红包时数据库操作")]),t._v(" "),n("ul",[n("li",[t._v("查询用户红包记录 1 次和锁库存 1 次")]),t._v(" "),n("li",[t._v("插入收红包记录 1 次")]),t._v(" "),n("li",[t._v("更新账户余额 1 次，插入账户流出 1 次")]),t._v(" "),n("li",[t._v("更新库存和余额 1 次")]),t._v(" "),n("li",[t._v("总计：1 次锁、2 次插入、2 次更新、查询 1 次，共 6 次操作")])]),t._v(" "),n("h4",{attrs:{id:"一些测试数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一些测试数据"}},[t._v("#")]),t._v(" 一些测试数据")]),t._v(" "),n("p",[t._v("至强 E5606/2.13G/8 核/32G/1 万转 SATA/MySQL8")]),t._v(" "),n("ul",[n("li",[t._v("基准测试发红包:平均响应时间 240ms")])]),t._v(" "),n("p",[t._v("I7-7500U/2 核/8GB/256G SSD 小米本/MySQL8")]),t._v(" "),n("ul",[n("li",[t._v("基准测试发红包:平均响应时间 70ms")])]),t._v(" "),n("h3",{attrs:{id:"_4-4-数据库表设计-红包物理模型优化-09-02"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-数据库表设计-红包物理模型优化-09-02"}},[t._v("#")]),t._v(" 4-4 数据库表设计-红包物理模型优化 (09:02)")]),t._v(" "),n("p",[t._v("在前面的红包物理模型中，"),n("code",[t._v("order_no")]),t._v("和"),n("code",[t._v("activity_no")]),t._v("其实都是多余的，完全可以只通过红包 id 来关联")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(568)}})]),t._v("\n在以上基础上，库存模型inventory完全可以并入goods，讲师又很激进地把goods合并入了order，还取消了activity，最后的红包物理模型如下：\n"),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(569)}})]),t._v(" "),n("h4",{attrs:{id:"优化后发红包时数据库操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化后发红包时数据库操作"}},[t._v("#")]),t._v(" 优化后发红包时数据库操作")]),t._v(" "),n("ul",[n("li",[t._v("插入商品、库存、订单、活动共 1 次")]),t._v(" "),n("li",[t._v("查询用户的资金账户信息 1 次")]),t._v(" "),n("li",[t._v("更新账户余额 1 次，插入账户流出 1 次")]),t._v(" "),n("li",[t._v("查询活动记录 0 次")]),t._v(" "),n("li",[t._v("总计：2 次插入、1 次更新、1 次查询，共 4 次操作")])]),t._v(" "),n("h4",{attrs:{id:"优化后收红包时数据库操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化后收红包时数据库操作"}},[t._v("#")]),t._v(" 优化后收红包时数据库操作")]),t._v(" "),n("ul",[n("li",[t._v("查询用户红包记录和锁库 1 次完成")]),t._v(" "),n("li",[t._v("插入收红包记录 1 次")]),t._v(" "),n("li",[t._v("更新账户余额 1 次，插入账户流出 1 次")]),t._v(" "),n("li",[t._v("更新库存和余额 1 次")]),t._v(" "),n("li",[t._v("总计：1 次锁、2 次插入、2 次更新、共 5 次操作")])]),t._v(" "),n("h4",{attrs:{id:"红包物理模型概览"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包物理模型概览"}},[t._v("#")]),t._v(" 红包物理模型概览")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(570)}})]),t._v(" "),n("h4",{attrs:{id:"红包物理模型-商品订单表描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包物理模型-商品订单表描述"}},[t._v("#")]),t._v(" 红包物理模型-商品订单表描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("字段名称")]),t._v(" "),n("th",[t._v("数据类型")]),t._v(" "),n("th",[t._v("描述")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("envelope_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("红包编号")])]),t._v(" "),n("tr",[n("td",[t._v("envelope_type")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("红包类型")])]),t._v(" "),n("tr",[n("td",[t._v("username")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("用户名称")])]),t._v(" "),n("tr",[n("td",[t._v("user_id")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("用户编号")])]),t._v(" "),n("tr",[n("td",[t._v("blessing")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("祝福语")])]),t._v(" "),n("tr",[n("td",[t._v("amount")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("红包总金额")])]),t._v(" "),n("tr",[n("td",[t._v("amount_one")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("单个红包金额")])]),t._v(" "),n("tr",[n("td",[t._v("quantity")]),t._v(" "),n("td",[t._v("int")]),t._v(" "),n("td",[t._v("红包总数量")])]),t._v(" "),n("tr",[n("td",[t._v("expired_at")]),t._v(" "),n("td",[t._v("datetime")]),t._v(" "),n("td",[t._v("过期时间")])]),t._v(" "),n("tr",[n("td",[t._v("ramain_amount")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("红包剩余金额")])]),t._v(" "),n("tr",[n("td",[t._v("remain_quantity")]),t._v(" "),n("td",[t._v("int")]),t._v(" "),n("td",[t._v("红包剩余数量")])]),t._v(" "),n("tr",[n("td",[t._v("status")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("红包/订单状态")])]),t._v(" "),n("tr",[n("td",[t._v("order_type")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("订单类型")])]),t._v(" "),n("tr",[n("td",[t._v("pay_status")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("支付状态")])]),t._v(" "),n("tr",[n("td",[t._v("created")]),t._v(" "),n("td",[t._v("datetime")]),t._v(" "),n("td",[t._v("创建时间")])])])]),t._v(" "),n("h4",{attrs:{id:"红包物理模型-订单详情表描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包物理模型-订单详情表描述"}},[t._v("#")]),t._v(" 红包物理模型-订单详情表描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("字段名称")]),t._v(" "),n("th",[t._v("数据类型")]),t._v(" "),n("th",[t._v("描述")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("item_no")]),t._v(" "),n("td",[t._v("bigint")]),t._v(" "),n("td",[t._v("详情编号")])]),t._v(" "),n("tr",[n("td",[t._v("envelope_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("红包编号")])]),t._v(" "),n("tr",[n("td",[t._v("recv_username")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("用户名称")])]),t._v(" "),n("tr",[n("td",[t._v("recv_user_id")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("用户编号")])]),t._v(" "),n("tr",[n("td",[t._v("amount")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("收到金额")])]),t._v(" "),n("tr",[n("td",[t._v("quantity")]),t._v(" "),n("td",[t._v("int")]),t._v(" "),n("td",[t._v("收到数量")])]),t._v(" "),n("tr",[n("td",[t._v("remain_amount")]),t._v(" "),n("td",[t._v("decimal")]),t._v(" "),n("td",[t._v("红包剩余金额")])]),t._v(" "),n("tr",[n("td",[t._v("account_no")]),t._v(" "),n("td",[t._v("varchar")]),t._v(" "),n("td",[t._v("账户 ID")])]),t._v(" "),n("tr",[n("td",[t._v("pay_status")]),t._v(" "),n("td",[t._v("tinyint")]),t._v(" "),n("td",[t._v("支付状态")])]),t._v(" "),n("tr",[n("td",[t._v("created_at")]),t._v(" "),n("td",[t._v("datetime")]),t._v(" "),n("td",[t._v("创建时间")])])])]),t._v(" "),n("h3",{attrs:{id:"_4-5-数据库表设计-总结-01-17"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-数据库表设计-总结-01-17"}},[t._v("#")]),t._v(" 4-5 数据库表设计-总结 (01:17)")]),t._v(" "),n("p",[t._v("业务领域模型和数据库物理模型之间的关系：")]),t._v(" "),n("ul",[n("li",[t._v("可以一致，可以不一致")]),t._v(" "),n("li",[t._v("根据业务和奇数要求合理调整和设计")])]),t._v(" "),n("p",[t._v("数据库表的设计合理取舍和做减法：")]),t._v(" "),n("ul",[n("li",[t._v("根据业务特点来设计，而非必须通用")]),t._v(" "),n("li",[t._v("根据奇数要求合理冗余和增减")])]),t._v(" "),n("h2",{attrs:{id:"第-5-章-总体架构和设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-5-章-总体架构和设计"}},[t._v("#")]),t._v(" 第 5 章 总体架构和设计")]),t._v(" "),n("p",[t._v("本章通过总体的架构设计，熟悉整个红包系统及子系统的架构、算法、业务流程以及基准测试来学习整个系统核心部件的架构设计。")]),t._v(" "),n("h3",{attrs:{id:"_5-1-架构设计-大纲-00-41"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-架构设计-大纲-00-41"}},[t._v("#")]),t._v(" 5-1 架构设计-大纲 (00:41)")]),t._v(" "),n("h4",{attrs:{id:"大纲概述-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#大纲概述-2"}},[t._v("#")]),t._v(" 大纲概述")]),t._v(" "),n("ul",[n("li",[t._v("模型回顾和红包系统应用架构")]),t._v(" "),n("li",[t._v("通过一-些数据来说明高并发高性能解决之道概述")]),t._v(" "),n("li",[t._v("红包秒杀系统高并发高性能解决之道概述")])]),t._v(" "),n("h3",{attrs:{id:"_5-2-架构设计-红包系统应用架构-04-40"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-架构设计-红包系统应用架构-04-40"}},[t._v("#")]),t._v(" 5-2 架构设计-红包系统应用架构 (04:40)")]),t._v(" "),n("h4",{attrs:{id:"回顾模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#回顾模型"}},[t._v("#")]),t._v(" 回顾模型")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(571)}})]),t._v(" "),n("p",[t._v("大体上分为三部分：用户、资金账户、红包")]),t._v(" "),n("h4",{attrs:{id:"红包系统应用架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统应用架构"}},[t._v("#")]),t._v(" 红包系统应用架构")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(572)}})]),t._v(" "),n("h4",{attrs:{id:"红包业务系统特点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包业务系统特点"}},[t._v("#")]),t._v(" 红包业务系统特点")]),t._v(" "),n("ul",[n("li",[t._v("秒杀：海量并发")]),t._v(" "),n("li",[t._v("涉及资金交易：事务性要求高")]),t._v(" "),n("li",[t._v("简单来说：高并发资金交易系统")])]),t._v(" "),n("h3",{attrs:{id:"_5-3-架构设计-一些数据和高并发高性能解决之道-03-29"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-架构设计-一些数据和高并发高性能解决之道-03-29"}},[t._v("#")]),t._v(" 5-3 架构设计-一些数据和高并发高性能解决之道 (03:29)")]),t._v(" "),n("p",[t._v("参考：http://highscalability.com/numbers-everyone-should-know")]),t._v(" "),n("h4",{attrs:{id:"计算机系统中的数据读取延迟-cpu-14x-l1chache"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#计算机系统中的数据读取延迟-cpu-14x-l1chache"}},[t._v("#")]),t._v(" 计算机系统中的数据读取延迟-CPU(14x L1chache)")]),t._v(" "),n("ul",[n("li",[t._v("一级缓存读取 0.5ns")]),t._v(" "),n("li",[t._v("分支预测 5ns")]),t._v(" "),n("li",[t._v("二级缓存读取 7ns")]),t._v(" "),n("li",[t._v("互斥锁和解锁 100ns")])]),t._v(" "),n("h4",{attrs:{id:"计算机系统中的数据读取延迟-内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#计算机系统中的数据读取延迟-内存"}},[t._v("#")]),t._v(" 计算机系统中的数据读取延迟-内存")]),t._v(" "),n("ul",[n("li",[t._v("主内存读取 100ns")]),t._v(" "),n("li",[t._v("用 zip 压缩 1K 字节的数据 10,000ns (0.01ms)")]),t._v(" "),n("li",[t._v("从主内存中顺序读 1MB 数据 250,000ns (0.25ms)")])]),t._v(" "),n("h4",{attrs:{id:"计算机系统中的数据读取延迟-网络"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#计算机系统中的数据读取延迟-网络"}},[t._v("#")]),t._v(" 计算机系统中的数据读取延迟-网络")]),t._v(" "),n("ul",[n("li",[t._v("在 1Gbps 网络上发送 1K 数据 10,000ns (0.01ms)")]),t._v(" "),n("li",[t._v("同一数据中心的往返时间 500,000ns (0.5ms)")]),t._v(" "),n("li",[t._v("从网络上顺序读取 1M 数据 10,000,000ns (10ms)")]),t._v(" "),n("li",[t._v("发送一个包从加州->荷兰->加州 150,000,000ns (150ms)")])]),t._v(" "),n("h4",{attrs:{id:"计算机系统中的数据读取延迟-硬盘"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#计算机系统中的数据读取延迟-硬盘"}},[t._v("#")]),t._v(" 计算机系统中的数据读取延迟-硬盘")]),t._v(" "),n("ul",[n("li",[t._v("从 SSD 硬盘随机读取 4K 数据 150,000ns (0.15ms)")]),t._v(" "),n("li",[t._v("从 SSD 硬盘顺序读取 1MB 数据 1,000,000ns (1ms) 4x memory")]),t._v(" "),n("li",[t._v("Disk seek 磁盘寻道时间 10,000,000ns (10ms)")]),t._v(" "),n("li",[t._v("从磁盘上顺序读取 1M 数据 20,000,000ns (20ms) 80x memory 20X SSD")])]),t._v(" "),n("h4",{attrs:{id:"并发性能架构的关键"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发性能架构的关键"}},[t._v("#")]),t._v(" 并发性能架构的关键")]),t._v(" "),n("ul",[n("li",[t._v("内存>分布式内存>SSD>HHD")]),t._v(" "),n("li",[t._v("异步>同步")]),t._v(" "),n("li",[t._v("分布式>单机")])]),t._v(" "),n("h3",{attrs:{id:"_5-4-架构设计-红包系统高性能解决之道-02-48"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-架构设计-红包系统高性能解决之道-02-48"}},[t._v("#")]),t._v(" 5-4 架构设计-红包系统高性能解决之道 (02:48)")]),t._v(" "),n("h4",{attrs:{id:"红包系统-引入分布式缓存架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统-引入分布式缓存架构"}},[t._v("#")]),t._v(" 红包系统-引入分布式缓存架构")]),t._v(" "),n("p",[t._v("用户——>红包网关——>红包服务——>先写缓存 Cache——>异步同步到数据库 MySQL\n风险：缓存服务器故障宕机导致数据丢失，不符合资金交易安全的要求")]),t._v(" "),n("h4",{attrs:{id:"红包系统-本地缓存架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统-本地缓存架构"}},[t._v("#")]),t._v(" 红包系统-本地缓存架构")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(573)}})]),t._v(" "),n("h4",{attrs:{id:"红包系统-异步架构-引入消息队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统-异步架构-引入消息队列"}},[t._v("#")]),t._v(" 红包系统-异步架构(引入消息队列)")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(574)}})]),t._v(" "),n("h4",{attrs:{id:"红包系统-数据库分片"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统-数据库分片"}},[t._v("#")]),t._v(" 红包系统-数据库分片")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(575)}})]),t._v(" "),n("h3",{attrs:{id:"_5-5-架构设计-本课程红包系统架构-00-44"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-架构设计-本课程红包系统架构-00-44"}},[t._v("#")]),t._v(" 5-5 架构设计-本课程红包系统架构 (00:44)")]),t._v(" "),n("div",{attrs:{align:"center"}},[n("img",{attrs:{width:"500",src:a(576)}})]),t._v(" "),n("h3",{attrs:{id:"_5-6-架构设计-重点总结-03-02"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-架构设计-重点总结-03-02"}},[t._v("#")]),t._v(" 5-6 架构设计-重点总结 (03:02)")]),t._v(" "),n("ul",[n("li",[t._v("红包系统特点：事务安全和高并发")]),t._v(" "),n("li",[t._v("高并发高性能解决之道概述\n"),n("ul",[n("li",[t._v("数据就近访问")]),t._v(" "),n("li",[t._v("高性能存储")]),t._v(" "),n("li",[t._v("异步减少等待和缓冲")]),t._v(" "),n("li",[t._v("横向扩展：分布式集群")])])]),t._v(" "),n("li",[t._v("红包系统的一些高并发高性能解决思路\n"),n("ul",[n("li",[t._v("高效存取：分布式缓存和本地缓存")]),t._v(" "),n("li",[t._v("缓冲：消息队列异步化")]),t._v(" "),n("li",[t._v("数据层横向扩展能力：分片")])])]),t._v(" "),n("li",[t._v("本课程的红包系统架构：单体架构")])]),t._v(" "),n("h3",{attrs:{id:"_5-7-架构设计-超卖方案-大纲-00-26"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-架构设计-超卖方案-大纲-00-26"}},[t._v("#")]),t._v(" 5-7 架构设计-超卖方案-大纲 (00:26)")]),t._v(" "),n("p",[t._v("资金安全问题的解决方案-超卖设计：大纲概述")]),t._v(" "),n("ul",[n("li",[t._v("红包系统的核心问题")]),t._v(" "),n("li",[t._v("超卖现象对资金安全的影响")]),t._v(" "),n("li",[t._v("解决超卖问题的 3 个方案及其优缺点")])]),t._v(" "),n("h3",{attrs:{id:"_5-8-架构设计-超卖方案-资金安全的问题概述-02-30"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-8-架构设计-超卖方案-资金安全的问题概述-02-30"}},[t._v("#")]),t._v(" 5-8 架构设计-超卖方案-资金安全的问题概述 (02:30)")]),t._v(" "),n("p",[t._v("高并发资金交易系统——>资金交易安全，事务性要求高")]),t._v(" "),n("h4",{attrs:{id:"避免抢红包的超卖现象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#避免抢红包的超卖现象"}},[t._v("#")]),t._v(" 避免抢红包的超卖现象")]),t._v(" "),n("p",[t._v("红包系统超卖定义：\n在高并发场景下更新红包剩余数量和剩余金额,在实际红包剩余数量和剩余金额已经不足的情况下,红包剩余数量和剩余金额依然在减,导致扣减后的红包剩余数量和剩余金额超过实际发送的红包数量和总金额。")]),t._v(" "),n("h4",{attrs:{id:"红包系统中需要解决的超卖问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包系统中需要解决的超卖问题"}},[t._v("#")]),t._v(" 红包系统中需要解决的超卖问题")]),t._v(" "),n("ul",[n("li",[t._v("保证大并发请求时剩余数量和金额不能出现负数")]),t._v(" "),n("li",[t._v("本质是要保证剩余数量和金额字段不能为负数")])]),t._v(" "),n("h4",{attrs:{id:"超卖现象的一个例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#超卖现象的一个例子"}},[t._v("#")]),t._v(" 超卖现象的一个例子")]),t._v(" "),n("p",[t._v("不查询数据库，不使用数据库事务行锁，直接更新")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" red_envelope_goods r\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" remain_quantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" remain_quantity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("扣减数量\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Where")]),t._v(" envelope_no "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ?\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"_5-9-架构设计-超卖方案-1-事务锁方案-02-38"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-架构设计-超卖方案-1-事务锁方案-02-38"}},[t._v("#")]),t._v(" 5-9 架构设计-超卖方案 1-事务锁方案 (02:38)")]),t._v(" "),n("p",[t._v("程序事务+行锁")]),t._v(" "),n("h4",{attrs:{id:"行锁是一种悲观锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#行锁是一种悲观锁"}},[t._v("#")]),t._v(" 行锁是一种悲观锁")]),t._v(" "),n("ul",[n("li",[t._v("假设数据会被其他人修改，先把坑占了")]),t._v(" "),n("li",[t._v("先上锁，再更新，完成后释放锁")]),t._v(" "),n("li",[t._v("适合写多和写冲突比较多的场景")]),t._v(" "),n("li",[t._v("在数据库事务中锁定操作行"),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("table")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" id"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("? "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOR")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])])]),t._v(" "),n("li",[t._v("在数据库事务中通过程序来计算和判断"),n("div",{staticClass:"language-SQL line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[t._v("remain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("扣减后数量\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("table")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" remain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("? "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" id"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("?\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])])])]),t._v(" "),n("h5",{attrs:{id:"优点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优点"}},[t._v("#")]),t._v(" 优点")]),t._v(" "),n("ul",[n("li",[t._v("稳定可靠，不会出现超卖")])]),t._v(" "),n("h5",{attrs:{id:"缺点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),n("ul",[n("li",[t._v("需要查询和计算：性能差、锁阻塞等待")]),t._v(" "),n("li",[t._v("锁阻塞等待会导致客户端延迟或超时")]),t._v(" "),n("li",[t._v("重试增加系统和网络开销")])]),t._v(" "),n("h3",{attrs:{id:"_5-10-架构设计-超卖方案-2-无符号类型字段直接更新方案-01-35"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-10-架构设计-超卖方案-2-无符号类型字段直接更新方案-01-35"}},[t._v("#")]),t._v(" 5-10 架构设计-超卖方案 2-无符号类型字段直接更新方案 (01:35)")]),t._v(" "),n("p",[t._v("数据库字段优化+直接更新")]),t._v(" "),n("h4",{attrs:{id:"将剩余数量和金额字段类型设置为无符号整数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#将剩余数量和金额字段类型设置为无符号整数"}},[t._v("#")]),t._v(" 将剩余数量和金额字段类型设置为无符号整数")]),t._v(" "),n("ul",[n("li",[t._v("字段不能为负数")]),t._v(" "),n("li",[t._v("如果被减为小于 0，SQL 执行会报错\n"),n("ul",[n("li",[t._v("value is out of range")])])])]),t._v(" "),n("h4",{attrs:{id:"不查询-直接更新"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#不查询-直接更新"}},[t._v("#")]),t._v(" 不查询，直接更新")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" red_envelope_goods r\nSER remain_quantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" remain_quantity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("扣减数量\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" envelope_no"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("?\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("扣减为负数时：value is out of range")]),t._v(" "),n("h4",{attrs:{id:"优化后的性能提升了-2-倍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化后的性能提升了-2-倍"}},[t._v("#")]),t._v(" 优化后的性能提升了 2 倍")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("用例")]),t._v(" "),n("th",[t._v("1")]),t._v(" "),n("th",[t._v("2")]),t._v(" "),n("th",[t._v("3")]),t._v(" "),n("th",[t._v("4")]),t._v(" "),n("th",[t._v("平均")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("事务锁")]),t._v(" "),n("td",[t._v("24")]),t._v(" "),n("td",[t._v("21.5")]),t._v(" "),n("td",[t._v("22")]),t._v(" "),n("td",[t._v("19.7")]),t._v(" "),n("td",[t._v("21.8")])]),t._v(" "),n("tr",[n("td",[t._v("无符号字段"),n("br"),t._v("+直接更新")]),t._v(" "),n("td",[t._v("7.7")]),t._v(" "),n("td",[t._v("7.2")]),t._v(" "),n("td",[t._v("6.6")]),t._v(" "),n("td",[t._v("7.2")]),t._v(" "),n("td",[t._v("7.2")])])])]),t._v(" "),n("h3",{attrs:{id:"_5-11-架构设计-超卖方案-3-乐观锁方案概述-02-34"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-11-架构设计-超卖方案-3-乐观锁方案概述-02-34"}},[t._v("#")]),t._v(" 5-11 架构设计-超卖方案 3-乐观锁方案概述 (02:34)")]),t._v(" "),n("h4",{attrs:{id:"乐观锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#乐观锁"}},[t._v("#")]),t._v(" 乐观锁")]),t._v(" "),n("ul",[n("li",[t._v("假设数据不会被其他人修改，只有自己，操作时验证一下")]),t._v(" "),n("li",[t._v("CAS：先比较，再更新，比较好的做法是在表中添加一个"),n("code",[t._v("版本号")]),t._v("字段，每次更新数据时都检查改字段")]),t._v(" "),n("li",[t._v("适合写少和写冲突少的场景")])]),t._v(" "),n("h3",{attrs:{id:"_5-12-架构设计-超卖方案-3-乐观锁-case-语句方案-01-16"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-12-架构设计-超卖方案-3-乐观锁-case-语句方案-01-16"}},[t._v("#")]),t._v(" 5-12 架构设计-超卖方案 3-乐观锁 case 语句方案 (01:16)")]),t._v(" "),n("p",[t._v("update 语句中使用条件判断——Case 语句")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" red_envelope_goods r\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" remain_quantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CASE")]),t._v(" case_value\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" remain_quantity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v("扣减数量或金额 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("THEN")]),t._v(" remain_quantity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("扣减数量或金额\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ELSE")]),t._v(" remain_quantity "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CASE")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" id"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("?\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("h3",{attrs:{id:"_5-13-架构设计-超卖方案-3-乐观锁-where-条件方案-01-01"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-13-架构设计-超卖方案-3-乐观锁-where-条件方案-01-01"}},[t._v("#")]),t._v(" 5-13 架构设计-超卖方案 3-乐观锁 where 条件方案 (01:01)")]),t._v(" "),n("p",[t._v("update where 语句中添加条件判断")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" red_envelope_goods r\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" remain_quantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" remain_quantity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("扣减数量或金额\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" id"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("? "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" remain_quantity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v("扣减数量或金额\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("说明：这种方案还优于无符号字段方案，更新语句会返回影响数据记录数，从而得知操作是否成功")]),t._v(" "),n("h3",{attrs:{id:"_5-14-架构设计-超卖方案-性能比较和建议-01-15"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-14-架构设计-超卖方案-性能比较和建议-01-15"}},[t._v("#")]),t._v(" 5-14 架构设计-超卖方案-性能比较和建议 (01:15)")]),t._v(" "),n("h4",{attrs:{id:"方案性能比较"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方案性能比较"}},[t._v("#")]),t._v(" 方案性能比较")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("用例")]),t._v(" "),n("th",[t._v("1")]),t._v(" "),n("th",[t._v("2")]),t._v(" "),n("th",[t._v("3")]),t._v(" "),n("th",[t._v("平均")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("事务锁")]),t._v(" "),n("td",[t._v("20")]),t._v(" "),n("td",[t._v("21")]),t._v(" "),n("td",[t._v("23.5")]),t._v(" "),n("td",[t._v("21.5")])]),t._v(" "),n("tr",[n("td",[t._v("无符号字段")]),t._v(" "),n("td",[t._v("8.2")]),t._v(" "),n("td",[t._v("8")]),t._v(" "),n("td",[t._v("9.1")]),t._v(" "),n("td",[t._v("8.4")])]),t._v(" "),n("tr",[n("td",[t._v("乐观锁")]),t._v(" "),n("td",[t._v("8")]),t._v(" "),n("td",[t._v("7.7")]),t._v(" "),n("td",[t._v("8.6")]),t._v(" "),n("td",[t._v("8.1")])]),t._v(" "),n("tr",[n("td",[t._v("无符号字段+乐观锁")]),t._v(" "),n("td",[t._v("8.6")]),t._v(" "),n("td",[t._v("8.5")]),t._v(" "),n("td",[t._v("8.9")]),t._v(" "),n("td",[t._v("8.7")])])])]),t._v(" "),n("h4",{attrs:{id:"建议的方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#建议的方案"}},[t._v("#")]),t._v(" 建议的方案")]),t._v(" "),n("p",[t._v("数据库字段正整数+乐观锁")]),t._v(" "),n("ul",[n("li",[t._v("双重保险")]),t._v(" "),n("li",[t._v("有较好的性能")])]),t._v(" "),n("h3",{attrs:{id:"_5-15-技术选型-golang-编程语言-04-33"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-15-技术选型-golang-编程语言-04-33"}},[t._v("#")]),t._v(" 5-15 技术选型-golang 编程语言 (04:33)")]),t._v(" "),n("h4",{attrs:{id:"编程语言-golang"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编程语言-golang"}},[t._v("#")]),t._v(" 编程语言-Golang")]),t._v(" "),n("ul",[n("li",[t._v("受够了 C++煎熬，目标是取代 C++\n"),n("ul",[n("li",[t._v("接近 C 的执行性能")]),t._v(" "),n("li",[t._v("近解释性型语言的开发效率")]),t._v(" "),n("li",[t._v("近乎完美的编译速度")])])]),t._v(" "),n("li",[t._v("语言设计哲学——将简单、实用体现得淋漓尽致")])]),t._v(" "),n("h4",{attrs:{id:"性能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#性能"}},[t._v("#")]),t._v(" 性能")]),t._v(" "),n("p",[t._v("https://benchmarksgame-team.pages.debian.net/benchmarksgame/faster/go.html\nVS C++：平均慢 1 个数量级\nVS Java：平均快不了多少，相当(有些评测比 java 快，有些慢)；内存比 java 少")]),t._v(" "),n("h4",{attrs:{id:"优势"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优势"}},[t._v("#")]),t._v(" 优势")]),t._v(" "),n("ul",[n("li",[t._v("并发性，非性能，语言层面支持并发(原生协程 goroutine)")]),t._v(" "),n("li",[t._v("运行时无依赖(这点比 python 好)")])]),t._v(" "),n("h3",{attrs:{id:"_5-16-技术选型-验证框架-01-19"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-16-技术选型-验证框架-01-19"}},[t._v("#")]),t._v(" 5-16 技术选型-验证框架 (01:19)")]),t._v(" "),n("h4",{attrs:{id:"参数和结构体验证框架"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参数和结构体验证框架"}},[t._v("#")]),t._v(" 参数和结构体验证框架")]),t._v(" "),n("p",[t._v("https://github.com/go-playground/validator")]),t._v(" "),n("ul",[n("li",[t._v("自称 100 分的验证框架")]),t._v(" "),n("li",[t._v("struct 和 field 验证：包括交叉 field，struct，Map，Slice and Array")]),t._v(" "),n("li",[t._v("支持自定义")]),t._v(" "),n("li",[t._v("很多框架都将 validator 作为默认的验证框架")])]),t._v(" "),n("h3",{attrs:{id:"_5-17-技术选型-配置框架-01-28"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-17-技术选型-配置框架-01-28"}},[t._v("#")]),t._v(" 5-17 技术选型-配置框架 (01:28)")]),t._v(" "),n("h4",{attrs:{id:"配置源客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置源客户端"}},[t._v("#")]),t._v(" 配置源客户端")]),t._v(" "),n("p",[t._v("https://github.com/tietang/props")]),t._v(" "),n("ul",[n("li",[t._v("Key/Value 抽象，Unmarshal 支持")]),t._v(" "),n("li",[t._v("多种配置源：本地文件和分布式配置源")]),t._v(" "),n("li",[t._v("组合配置源和上下文变量")]),t._v(" "),n("li",[t._v("一个统一的配置库")])]),t._v(" "),n("h3",{attrs:{id:"_5-18-技术选型-日志框架-02-15"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-18-技术选型-日志框架-02-15"}},[t._v("#")]),t._v(" 5-18 技术选型-日志框架 (02:15)")]),t._v(" "),n("p",[t._v("https://github.com/sirupsen/logrus")]),t._v(" "),n("ul",[n("li",[t._v("结构化可插拔的标准日志工具")]),t._v(" "),n("li",[t._v("多种日志输出格式和自定义输出格式")]),t._v(" "),n("li",[t._v("支持自定义扩展 hook：定制，输出(比如扔到 MQ、ES)")]),t._v(" "),n("li",[t._v("stars 最多，很多知名软件都在用(如 docker)")])]),t._v(" "),n("h3",{attrs:{id:"_5-19-技术选型-数据库工具-01-20"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-19-技术选型-数据库工具-01-20"}},[t._v("#")]),t._v(" 5-19 技术选型-数据库工具 (01:20)")]),t._v(" "),n("h4",{attrs:{id:"数据库访问工具-go-操作数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据库访问工具-go-操作数据库"}},[t._v("#")]),t._v(" 数据库访问工具(go 操作数据库)")]),t._v(" "),n("p",[t._v("xorm.io or dbx")]),t._v(" "),n("ul",[n("li",[t._v("性能出色")]),t._v(" "),n("li",[t._v("功能足够")]),t._v(" "),n("li",[t._v("事务支持")])]),t._v(" "),n("h3",{attrs:{id:"_5-20-技术选型-web-服务框架-02-15"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-20-技术选型-web-服务框架-02-15"}},[t._v("#")]),t._v(" 5-20 技术选型-web 服务框架 (02:15)")]),t._v(" "),n("h4",{attrs:{id:"go-的-web-框架"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#go-的-web-框架"}},[t._v("#")]),t._v(" go 的 web 框架")]),t._v(" "),n("p",[t._v("出名的有：beego、gin、revel"),n("br"),t._v("\nhttps://github.com/kataras/iris")]),t._v(" "),n("ul",[n("li",[t._v("号称全宇宙最快的 web 框架(笑)、具有完备的 MVC 支持")]),t._v(" "),n("li",[t._v("性能出色")]),t._v(" "),n("li",[t._v("简单易用，强大的路由支持")]),t._v(" "),n("li",[t._v("自定义中间件扩展和丰富的中间件生态")])]),t._v(" "),n("h3",{attrs:{id:"_5-21-技术选型-测试用例框架-02-17"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-21-技术选型-测试用例框架-02-17"}},[t._v("#")]),t._v(" 5-21 技术选型-测试用例框架 (02:17)")]),t._v(" "),n("p",[t._v("https://github.com/smartystreets/goconvey")]),t._v(" "),n("ul",[n("li",[t._v("go test 集成，测试覆盖")]),t._v(" "),n("li",[t._v("自动化的 web ui")]),t._v(" "),n("li",[t._v("丰富的测试工具套件")])]),t._v(" "),n("h2",{attrs:{id:"第-6-章-golang-编码实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-6-章-golang-编码实践"}},[t._v("#")]),t._v(" 第 6 章 Golang 编码实践")]),t._v(" "),n("p",[t._v("本章内容从实际编码实战来实现红包系统的主要核心代码架构和代码实现。")]),t._v(" "),n("h3",{attrs:{id:"_6-1-红包系统项目主体结构构建概述-00-48"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-红包系统项目主体结构构建概述-00-48"}},[t._v("#")]),t._v(" 6-1 红包系统项目主体结构构建概述 (00:48)")]),t._v(" "),n("h4",{attrs:{id:"golang-红包项目构建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#golang-红包项目构建"}},[t._v("#")]),t._v(" Golang 红包项目构建")]),t._v(" "),n("p",[t._v("代码仓库创建，项目空间和项目创建，包结构构建，骨干文件构建")]),t._v(" "),n("h3",{attrs:{id:"_6-2-项目仓库创建-01-05"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-项目仓库创建-01-05"}},[t._v("#")]),t._v(" 6-2 项目仓库创建 (01:05)")]),t._v(" "),n("p",[t._v("在码云上创建一个仓库(自己喜欢的话，github 也可以)\n注：我在码云搜索到的别人的代码https://gitee.com/wendell01/resk-pilot")]),t._v(" "),n("h3",{attrs:{id:"_6-3-项目空间构建-02-55"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-项目空间构建-02-55"}},[t._v("#")]),t._v(" 6-3 项目空间构建 (02:55)")]),t._v(" "),n("ol",[n("li",[t._v("讲师使用 GoLand 新建了一个 Go 的项目，我将就一下就用 IDEA 了(代码位置：~/GoProjects/resk-projects)。")]),t._v(" "),n("li",[t._v("在项目根目录下新建一个 src 目录，在 src 目录中新建一个 imooc.com 目录(讲师的个人介绍就是 java 程序员，浓浓的 java 项目风格)")]),t._v(" "),n("li",[t._v("将仓库代码拉取到 imooc.com 目录")])]),t._v(" "),n("h3",{attrs:{id:"_6-4-项目主目录和包结构构建-04-16"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-项目主目录和包结构构建-04-16"}},[t._v("#")]),t._v(" 6-4 项目主目录和包结构构建 (04:16)")]),t._v(" "),n("p",[t._v("在 imooc.com/resk 目录下分别新建以下目录：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("resk\n├── README.md\n├── apis\n│   ├── thrift\n│   └── web\n├── brun    # 项目运行main函数、其他相关工具集、编译后的二进制代码\n├── core    # 存放核心业务代码\n│   ├── accounts\n│   ├──envelopes\n│   └── users\n├── doc\n├── infra   # 基础设施：MQ、工具类等\n├── public   # css js img html\n└── services\n\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("h3",{attrs:{id:"_6-5-项目骨干文件构建-04-00"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-项目骨干文件构建-04-00"}},[t._v("#")]),t._v(" 6-5 项目骨干文件构建 (04:00)")]),t._v(" "),n("p",[t._v("分别创建以下 go 文件：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("apis/web：\n    account.go\n    envelope.go\nbrun：\n    main.go   # 将第一行package brun改为package main\n# 注：po开头的是结构体代码(和Rust语言一样，go的类=结构体+挂载方法)，dao开头的是数据库访问对象，domain是核心业务逻辑代码\ncore/accounts：\n    po_account.go\n    po_account_log.go(账户流水)\n    dao_account.go\n    dao_account_log.go\n    domain_account.go\n    domain_account_log.go\n    domains.go\n    service.go\ncore/envelopes：\n    po_goods.go\n    po_item.go\n    dao_goods.go\n    dao_item.go\n    domain_goods.go\n    domain_item.go\n    domains.go\n    service.go\nservies：\n    accounts.go\n    envelopes.go\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br")])]),n("p",[t._v("此时提交一次代码")]),t._v(" "),n("h3",{attrs:{id:"_6-6-红包算法概述-05-26"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-红包算法概述-05-26"}},[t._v("#")]),t._v(" 6-6 红包算法概述 (05:26)")]),t._v(" "),n("h4",{attrs:{id:"大纲概述-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#大纲概述-3"}},[t._v("#")]),t._v(" 大纲概述")]),t._v(" "),n("ul",[n("li",[t._v("算法概述")]),t._v(" "),n("li",[t._v("简单随机法")]),t._v(" "),n("li",[t._v("2 次随机算法：先随机再洗牌、先洗牌再随机")]),t._v(" "),n("li",[t._v("2 倍均值法：微信红包算法")])]),t._v(" "),n("h5",{attrs:{id:"算法概述-红包序列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#算法概述-红包序列"}},[t._v("#")]),t._v(" 算法概述-红包序列")]),t._v(" "),n("ul",[n("li",[t._v("按照红包总金额和总数量通过红包算法计算拆分")]),t._v(" "),n("li",[t._v("计算拆分后的子红包集合叫做"),n("code",[t._v("红包序列")])])]),t._v(" "),n("h5",{attrs:{id:"算法概述-计算时机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#算法概述-计算时机"}},[t._v("#")]),t._v(" 算法概述-计算时机")]),t._v(" "),n("ul",[n("li",[t._v("发红包时计算")]),t._v(" "),n("li",[t._v("抢红包时计算")])]),t._v(" "),n("h5",{attrs:{id:"算法概述-红包算法要求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#算法概述-红包算法要求"}},[t._v("#")]),t._v(" 算法概述-红包算法要求")]),t._v(" "),n("ul",[n("li",[t._v("业务逻辑要求\n"),n("ul",[n("li",[t._v("保证红包数量的人能拿到红包且金额>0")]),t._v(" "),n("li",[t._v("抢到的总金额不能超过红包总金额")])])]),t._v(" "),n("li",[t._v("设计逻辑要求\n"),n("ul",[n("li",[t._v("红包序列是随机的，序列元素之间差异性可以控制")]),t._v(" "),n("li",[t._v("算法尽可能简单\n"),n("ol",[n("li",[t._v("大小分布可以预期")]),t._v(" "),n("li",[t._v("尽可能降低性能损耗")])])])])])]),t._v(" "),n("h5",{attrs:{id:"算法概述-基本逻辑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#算法概述-基本逻辑"}},[t._v("#")]),t._v(" 算法概述-基本逻辑")]),t._v(" "),n("p",[t._v("计算逻辑如何来设计？")]),t._v(" "),n("ul",[n("li",[t._v("计算时需要守住底线，避免 0 金额红包")]),t._v(" "),n("li",[t._v("2 个公式\n"),n("ol",[n("li",[t._v("最大可调度金额=总金额-最小金额*红包数量")]),t._v(" "),n("li",[t._v("平均可调度金额=(总金额-最小金额*红包数量)/红包数量")])])])]),t._v(" "),n("h3",{attrs:{id:"_6-7-红包算法-简单随机算法-12-25"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-红包算法-简单随机算法-12-25"}},[t._v("#")]),t._v(" 6-7 红包算法-简单随机算法 (12:25)")]),t._v(" "),n("h4",{attrs:{id:"简单随机算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单随机算法"}},[t._v("#")]),t._v(" 简单随机算法")]),t._v(" "),n("ul",[n("li",[t._v("随机范围为(0~最大可用金额)")]),t._v(" "),n("li",[t._v("随机数+最小金额作为红包序列元素")])]),t._v(" "),n("h5",{attrs:{id:"缺点-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缺点-2"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),n("ul",[n("li",[t._v("金额先大后小")])]),t._v(" "),n("h4",{attrs:{id:"接下来就是写代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#接下来就是写代码"}},[t._v("#")]),t._v(" 接下来就是写代码")]),t._v(" "),n("p",[t._v("所有的红包算法都放到 infra/algo 目录(新建 algo，algorithm -算法)，这里我们新建一个"),n("code",[t._v("simple-random.go")]),t._v("文件，编写以下代码：")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" algo\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"math/rand"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" min "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*\n简单随机算法，金额单位为分(1元钱=100分)\n@params count:红包数量\n@params id:红包金额\n*/")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SimpleRand")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//当红包数量为一个的时候，就直接返回剩余金额")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" amount\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算最大可调度金额")]),t._v("\n\tmax "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" min"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("count\n\trand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Seed")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UnixNano")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 和java生成完全随机数一样，需要种子，否则就是伪随机")]),t._v("\n\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int63n")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" min\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br")])]),n("h4",{attrs:{id:"在-idea-goland-中设置-gopath"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在-idea-goland-中设置-gopath"}},[t._v("#")]),t._v(" 在 IDEA/GoLand 中设置 GOPATH")]),t._v(" "),n("p",[t._v("我的备注：类似 python 项目的"),n("code",[t._v("sys.path.insert(0,dir_name)")]),t._v("\n打开设置，搜索 GOPTAH，在 Project GOPATH 中添加当前项目根目录："),n("code",[t._v("/Users/xxx/GoProjects/resk-projects")])]),t._v(" "),n("h4",{attrs:{id:"编写测试代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写测试代码"}},[t._v("#")]),t._v(" 编写测试代码")]),t._v(" "),n("p",[t._v("在 brun 目录下新建一个 test 目录，新建一个"),n("code",[t._v("simple-rand.go")]),t._v("文件，编写以下代码：")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"imooc.com/resk/infra/algo"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" algo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SimpleRand")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("float64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("float64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('","')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("h4",{attrs:{id:"运行一下"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行一下"}},[t._v("#")]),t._v(" 运行一下")]),t._v(" "),n("p",[t._v("在 IDEA/GoLang 中，直接在"),n("code",[t._v("simple-rand.go")]),t._v("文件内容中右键运行或者点击 main()方法左边的绿色运行按钮直接执行")]),t._v(" "),n("h3",{attrs:{id:"_6-8-红包算法-后洗牌算法设计和编程实践-07-49"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-红包算法-后洗牌算法设计和编程实践-07-49"}},[t._v("#")]),t._v(" 6-8 红包算法-后洗牌算法设计和编程实践 (07:49)")]),t._v(" "),n("h4",{attrs:{id:"后洗牌算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#后洗牌算法"}},[t._v("#")]),t._v(" 后洗牌算法")]),t._v(" "),n("p",[t._v("算法：2 次随机，先随机再洗牌")]),t._v(" "),n("ul",[n("li",[t._v("随机生成序列，范围为(0~最大可用金额)")]),t._v(" "),n("li",[t._v("随机数+最小金额作为红包序列元素")]),t._v(" "),n("li",[t._v("对生成的序列再洗牌打乱")])]),t._v(" "),n("h4",{attrs:{id:"写代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#写代码"}},[t._v("#")]),t._v(" 写代码")]),t._v(" "),n("p",[t._v("在 infra/algo 目录新建一个"),n("code",[t._v("after-shuffle.go")]),t._v("文件，编写以下代码：")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" algo\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"math/rand"')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//后洗牌算法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("AfterShuffle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tinds "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算最大可调度金额")]),t._v("\n\tmax "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" min"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("count\n\tremain "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" max\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//随机生成初级红包序列")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SimpleRand")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remain"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tremain "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-=")]),t._v(" x\n\t\tinds "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//洗牌，洗初级红包序列")]),t._v("\n\trand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Shuffle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" j "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tinds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" inds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" inds\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br")])]),n("h4",{attrs:{id:"编写测试代码-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写测试代码-2"}},[t._v("#")]),t._v(" 编写测试代码")]),t._v(" "),n("p",[n("code",[t._v("src/imooc.com/resk/brun/test/after-shuffle.go")])]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"imooc.com/resk/infra/algo"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("algo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("AfterShuffle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])]),n("h4",{attrs:{id:"缺点-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缺点-3"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),n("ul",[n("li",[t._v("事先生成整个序列")]),t._v(" "),n("li",[t._v("只适用于发红包时当场生成")])]),t._v(" "),n("h5",{attrs:{id:"性能-和简单随机比较"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#性能-和简单随机比较"}},[t._v("#")]),t._v(" 性能：和简单随机比较")]),t._v(" "),n("ul",[n("li",[t._v("和简单随机差不多，总体慢不到万分之 1")])]),t._v(" "),n("h3",{attrs:{id:"_6-9-红包算法-先洗牌算法设计和编程实践-10-48"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-9-红包算法-先洗牌算法设计和编程实践-10-48"}},[t._v("#")]),t._v(" 6-9 红包算法-先洗牌算法设计和编程实践 (10:48)")]),t._v(" "),n("h4",{attrs:{id:"先洗牌算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#先洗牌算法"}},[t._v("#")]),t._v(" 先洗牌算法")]),t._v(" "),n("p",[t._v("算法：2 次随机，先洗牌再随机")]),t._v(" "),n("ul",[n("li",[t._v("第一步：生成一个一定长度的红包种子金额序列\n"),n("ul",[n("li",[t._v("种子金额序列长度控制在 3~1/3 剩余红包数量")]),t._v(" "),n("li",[t._v("序列元素为最大可用剩余金额/(n+1)")]),t._v(" "),n("li",[t._v("最大可用剩余金额=剩余金额-最小金额*剩余数量")])])]),t._v(" "),n("li",[t._v("第二步：再随机一个数字，取模计算索引")])]),t._v(" "),n("h4",{attrs:{id:"写代码-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#写代码-2"}},[t._v("#")]),t._v(" 写代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/infra/algo/before-shuffle.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" algo\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"math/rand"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//先洗牌算法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("BeforeShuffle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" amount\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算出最大可调度金额")]),t._v("\n\tmax "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" min"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("count\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//生成红包种子金额序列")]),t._v("\n\tseeds "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//红包种子金额序列长度=3~1/2*count")]),t._v("\n\tsize "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tsize "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" max "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tseeds "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("seeds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\trand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Seed")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UnixNano")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//从红包种子金额序列中随机选择一个作为随机基数")]),t._v("\n\tidx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int63n")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("seeds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//使用随机基数作为最大数，随机出一个数字作为红包金额序列元素")]),t._v("\n\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int63n")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("seeds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" min\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br")])]),n("h4",{attrs:{id:"测试代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试代码"}},[t._v("#")]),t._v(" 测试代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/brun/test/before-shuflle.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"imooc.com/resk/infra/algo"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" algo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("BeforeShuffle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('","')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br")])]),n("h4",{attrs:{id:"缺点-4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缺点-4"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),n("p",[t._v("随着红包数量的变大：计算性能变差；红包分布出现先大后小")]),t._v(" "),n("h3",{attrs:{id:"_6-10-红包算法-先洗牌算法优化设计和编程实践-08-52"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-10-红包算法-先洗牌算法优化设计和编程实践-08-52"}},[t._v("#")]),t._v(" 6-10 红包算法-先洗牌算法优化设计和编程实践 (08:52)")]),t._v(" "),n("h4",{attrs:{id:"改进先洗牌算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#改进先洗牌算法"}},[t._v("#")]),t._v(" 改进先洗牌算法")]),t._v(" "),n("p",[t._v("改进一下，优化 2 个缺点，采用双随机")]),t._v(" "),n("ul",[n("li",[t._v("把种子金额序列的生成改成随机生成")]),t._v(" "),n("li",[t._v("随机种子数量，范围 0~2 倍剩余数量")]),t._v(" "),n("li",[t._v("剩余金额除以随机的种子数量")])]),t._v(" "),n("h4",{attrs:{id:"优化后优缺点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化后优缺点"}},[t._v("#")]),t._v(" 优化后优缺点")]),t._v(" "),n("ul",[n("li",[t._v("优点是基本克服了先洗牌再计算的缺点")]),t._v(" "),n("li",[t._v("缺点是红包金额大且数量较小时，最后一个大金额的概率增加")])]),t._v(" "),n("h4",{attrs:{id:"写代码-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#写代码-3"}},[t._v("#")]),t._v(" 写代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/infra/algo/double-random.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" algo\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"math/rand"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//二次随机算法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("DoubleRandom")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" amount\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算最大可调度金额")]),t._v("\n\tmax "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" min"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("count\n\trand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Seed")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UnixNano")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//一次随机，计算出一个种子金额作为基数")]),t._v("\n\tseed "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int63n")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\tn "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" max"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("seed "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" min\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//二次随机，计算出红包金额序列元素")]),t._v("\n\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int63n")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" min\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br")])]),n("h4",{attrs:{id:"测试代码-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试代码-2"}},[t._v("#")]),t._v(" 测试代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/brun/test/double-random.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"imooc.com/resk/infra/algo"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" algo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("DoubleRandom")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('","')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("h3",{attrs:{id:"_6-11-红包算法-2-倍均值算法设计和编码实践-07-29"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-11-红包算法-2-倍均值算法设计和编码实践-07-29"}},[t._v("#")]),t._v(" 6-11 红包算法-2 倍均值算法设计和编码实践 (07:29)")]),t._v(" "),n("h4",{attrs:{id:"_2-倍平均算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-倍平均算法"}},[t._v("#")]),t._v(" 2 倍平均算法")]),t._v(" "),n("p",[t._v("关键思路")]),t._v(" "),n("ul",[n("li",[t._v("每次随机金额的平均值基本相等")]),t._v(" "),n("li",[t._v("剩余金额平均数的 2 倍作为随机最大数")])]),t._v(" "),n("p",[t._v("为什么是 2 倍，而不是 3 倍呢？")]),t._v(" "),n("ul",[n("li",[t._v("每次随机金额的平均值作为中位数，随机上下范围一致")]),t._v(" "),n("li",[t._v("(最大值+最小值)/2=平均值")])]),t._v(" "),n("h4",{attrs:{id:"写代码-4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#写代码-4"}},[t._v("#")]),t._v(" 写代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/brun/test/double-average.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" algo\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"math/rand"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//二倍均值算法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("DoubleAverage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" amount\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算出最大可用金额")]),t._v("\n\tmax "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" min"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("count\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算最大可用平均值")]),t._v("\n\tavg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" max "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" count\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//二倍均值基础在加上最小金额，防止出现0值")]),t._v("\n\tavg2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("avg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" min\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//随机红包金额序列元素，把二倍均值作为随机的最大数")]),t._v("\n\trand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Seed")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UnixNano")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int63n")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("avg2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" min\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br")])]),n("h4",{attrs:{id:"测试代码-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试代码-3"}},[t._v("#")]),t._v(" 测试代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/brun/test/double-average.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"imooc.com/resk/infra/algo"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" algo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("DoubleAverage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('","')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("h3",{attrs:{id:"_6-12-红包算法-单元测试用例编写和-goconvey-实践-14-31"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-12-红包算法-单元测试用例编写和-goconvey-实践-14-31"}},[t._v("#")]),t._v(" 6-12 红包算法-单元测试用例编写和 goconvey 实践 (14:31)")]),t._v(" "),n("h4",{attrs:{id:"go-中的单元测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#go-中的单元测试"}},[t._v("#")]),t._v(" go 中的单元测试")]),t._v(" "),n("p",[t._v("文件命名规则：以_test 结尾\n方法命名：Test 开头\n安装 goconvey(时间比较久，耐心点)：go get github.com/smartystreets/goconvey\ngoconvey 的 github 地址：https://github.com/smartystreets/goconvey\n编写代码：")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/infra/algo/algo_test.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" algo\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"github.com/smartystreets/goconvey/convey"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"testing"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("TestSimpleRand")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("testing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("T"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ForTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"简单随机算法"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SimpleRand"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("TestBeforeShuffle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("testing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("T"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ForTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"先洗牌算法"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BeforeShuffle"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("TestDoubleRandom")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("testing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("T"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ForTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"二次随机算法"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DoubleRandom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("TestDoubleAverage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("testing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("T"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ForTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"二倍随机算法"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DoubleAverage"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ForTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("testing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("T"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tremain "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" amount\n\tsum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remain"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tremain "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-=")]),t._v(" x\n\t\tsum "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" x\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Convey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("So")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ShouldEqual"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br")])]),n("h4",{attrs:{id:"goconvey-的-web-界面"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#goconvey-的-web-界面"}},[t._v("#")]),t._v(" goconvey 的 web 界面")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cd GoProjects/resk-projects/src/imooc.com/resk/infra/algo\ngoconvey\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("h3",{attrs:{id:"_6-13-超卖方案-资源准备编码实践-07-42"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-13-超卖方案-资源准备编码实践-07-42"}},[t._v("#")]),t._v(" 6-13 超卖方案-资源准备编码实践 (07:42)")]),t._v(" "),n("p",[t._v("先安装依赖：")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("go get github.com/tietang/dbx\ngo get github.com/shopspring/decimal\ngo get github.com/go-sql-driver/mysql\ngo get github.com/segmentio/ksuid\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("p",[t._v("新建并编写代码：")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/test/over.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事务锁方案")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//事务锁方案")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" query "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"select * from goods "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"where envelope_no=? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"for update"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" update "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update goods "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"set remain_amount=?,remain_quantity=? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"where envelope_no=? "')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpdateForLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("g Goods"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//通过db.tx函数构建事务锁代码块")]),t._v("\n\terr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Tx")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("runner "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("dbx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TxRunner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//第一步：锁定需要修改的资源，也就是需要修改的数据行")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//编写事务锁查询语句，使用for update子句来锁定资源")]),t._v("\n\n\t\tout "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("GoodsSigned"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tok"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" runner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" query"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" g"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EnvelopeNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ok "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//第二部：计算剩余金额和剩余数量")]),t._v("\n\t\tsubAmount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" decimal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewFromFloat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tremainAmount "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RemainAmount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sub")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("subAmount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tremainQuantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RemainQuantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//第三步：执行更新")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v("runner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remainAmount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remainQuantity"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" g"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EnvelopeNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" errors"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("New")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"库存扣减失败"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br")])]),n("p",[t._v("建表 sql："),n("code",[t._v("src/imooc.com/resk/doc/over_test.sql")]),t._v("\n表对应的结构体 model："),n("code",[t._v("src/imooc.com/resk/test/over_po.go")]),t._v("\n注意：go 中没有 decimal 类型，为了不丢失精度，所以使用了别人写好的 decimal\n基准测试代码："),n("code",[t._v("src/imooc.com/resk/test/over_test.go")])]),t._v(" "),n("h3",{attrs:{id:"_6-14-超卖方案-无符号类型字段直接更新基准测试编码实践-05-29"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-14-超卖方案-无符号类型字段直接更新基准测试编码实践-05-29"}},[t._v("#")]),t._v(" 6-14 超卖方案-无符号类型字段直接更新基准测试编码实践 (05:29)")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/test/over.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//数据库无符号类型+直接更新方案")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpdateForUnsigned")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("g Goods"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tupdate "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update goods_unsigned "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"set remain_amount=remain_amount-?, "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"remain_quantity=remain_quantity-? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"where envelope_no=?"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" g"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EnvelopeNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"扣减失败"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("h3",{attrs:{id:"_6-15-超卖方案-乐观锁-where-条件方案基准测试编码实践-03-54"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-15-超卖方案-乐观锁-where-条件方案基准测试编码实践-03-54"}},[t._v("#")]),t._v(" 6-15 超卖方案-乐观锁 where 条件方案基准测试编码实践 (03:54)")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//乐观锁方案")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpdateForOptimistic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("g Goods"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tupdate "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update goods "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"set remain_amount=remain_amount-?, "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" remain_quantity=remain_quantity-? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" where envelope_no=? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" and remain_amount>=? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" and remain_quantity>=? "')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" g"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EnvelopeNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"扣减失败"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br")])]),n("h3",{attrs:{id:"_6-16-超卖方案的性能基准测试比较和建议-03-58"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-16-超卖方案的性能基准测试比较和建议-03-58"}},[t._v("#")]),t._v(" 6-16 超卖方案的性能基准测试比较和建议 (03:58)")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//乐观锁+无符号字段双保险方案")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpdateForOptimisticAndUnsigned")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("g Goods"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tupdate "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update goods_unsigned "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"set remain_amount=remain_amount-?, "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" remain_quantity=remain_quantity-? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" where envelope_no=? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" and remain_amount>=? "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('" and remain_quantity>=? "')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" g"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EnvelopeNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"扣减失败"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br")])]),n("p",[t._v("tips——业务中尽量不要使用事务级悲观锁，非常影响性能")]),t._v(" "),n("h3",{attrs:{id:"_6-17-基础公共资源访问问题的设计和编码实践-08-03"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-17-基础公共资源访问问题的设计和编码实践-08-03"}},[t._v("#")]),t._v(" 6-17 基础公共资源访问问题的设计和编码实践 (08:03)")]),t._v(" "),n("p",[t._v("略")]),t._v(" "),n("h3",{attrs:{id:"_6-18-基础资源组件生命周期的管理的设计和编码实践-16-59"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-18-基础资源组件生命周期的管理的设计和编码实践-16-59"}},[t._v("#")]),t._v(" 6-18 基础资源组件生命周期的管理的设计和编码实践 (16:59)")]),t._v(" "),n("p",[t._v("编写代码")]),t._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//src/imooc.com/resk/infra/starer.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" infra\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//基础资源上下结构体")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" StarterContext "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//基础资源启动器接口")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Starter "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//1.系统启动，初始化一些基础资源")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//2. 系统基础资源的安装")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Setup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//3. 启动基础资源")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//启动器是否可阻塞")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartBlocking")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//4. 资源停止和销毁")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Stop")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),t._v(" Starter "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BaseStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//基础空启动器实现,为了方便资源启动器的代码实现")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" BaseStarter "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("BaseStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("BaseStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Setup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("BaseStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("BaseStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartBlocking")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("BaseStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Stop")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//启动器注册器")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" starterRegister "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tstarters "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("Starter\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//启动器注册")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("starterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Register")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s Starter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("starters "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("starters"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("starterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("AllStarters")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("Starter "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" r"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("starters\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" StarterRegister "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("starterRegister "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("starterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Register")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s Starter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tStarterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Register")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//系统基础资源的启动管理")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SystemRun")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//1. 初始化")]),t._v("\n\tctx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" starter "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" StarterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("AllStarters")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tstarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//2. 安装")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" starter "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" StarterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("AllStarters")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tstarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Setup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//2. 启动")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" starter "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" StarterRegister"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("AllStarters")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tstarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br"),n("span",{staticClass:"line-number"},[t._v("43")]),n("br"),n("span",{staticClass:"line-number"},[t._v("44")]),n("br"),n("span",{staticClass:"line-number"},[t._v("45")]),n("br"),n("span",{staticClass:"line-number"},[t._v("46")]),n("br"),n("span",{staticClass:"line-number"},[t._v("47")]),n("br"),n("span",{staticClass:"line-number"},[t._v("48")]),n("br"),n("span",{staticClass:"line-number"},[t._v("49")]),n("br"),n("span",{staticClass:"line-number"},[t._v("50")]),n("br"),n("span",{staticClass:"line-number"},[t._v("51")]),n("br"),n("span",{staticClass:"line-number"},[t._v("52")]),n("br"),n("span",{staticClass:"line-number"},[t._v("53")]),n("br"),n("span",{staticClass:"line-number"},[t._v("54")]),n("br"),n("span",{staticClass:"line-number"},[t._v("55")]),n("br"),n("span",{staticClass:"line-number"},[t._v("56")]),n("br"),n("span",{staticClass:"line-number"},[t._v("57")]),n("br"),n("span",{staticClass:"line-number"},[t._v("58")]),n("br"),n("span",{staticClass:"line-number"},[t._v("59")]),n("br"),n("span",{staticClass:"line-number"},[t._v("60")]),n("br"),n("span",{staticClass:"line-number"},[t._v("61")]),n("br"),n("span",{staticClass:"line-number"},[t._v("62")]),n("br"),n("span",{staticClass:"line-number"},[t._v("63")]),n("br"),n("span",{staticClass:"line-number"},[t._v("64")]),n("br"),n("span",{staticClass:"line-number"},[t._v("65")]),n("br"),n("span",{staticClass:"line-number"},[t._v("66")]),n("br"),n("span",{staticClass:"line-number"},[t._v("67")]),n("br"),n("span",{staticClass:"line-number"},[t._v("68")]),n("br"),n("span",{staticClass:"line-number"},[t._v("69")]),n("br"),n("span",{staticClass:"line-number"},[t._v("70")]),n("br")])]),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/imooc.com/resk/infra/conf.go")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" infra\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Register")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ConfStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" ConfStarter "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tBaseStarter\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ConfStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"配置初始化"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ConfStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Setup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"配置安装"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ConfStarter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx StarterContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"配置启动"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br")])]),n("h2",{attrs:{id:"第-7-章-课程总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第-7-章-课程总结"}},[t._v("#")]),t._v(" 第 7 章 课程总结")]),t._v(" "),n("p",[t._v("对课程进行总结和后续扩展课程预告")]),t._v(" "),n("h4",{attrs:{id:"红包业务需求用例定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#红包业务需求用例定义"}},[t._v("#")]),t._v(" 红包业务需求用例定义")]),t._v(" "),n("p",[t._v("讲清楚需求的业务需求、场景，分析总结")]),t._v(" "),n("ul",[n("li",[t._v("用例名称、场景、描述、价值、约束和限制")]),t._v(" "),n("li",[t._v("正常逻辑、异常逻辑、替代(降级)逻辑")]),t._v(" "),n("li",[t._v("小而美的红包商品交易系统")])]),t._v(" "),n("h4",{attrs:{id:"业务模型分析和设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#业务模型分析和设计"}},[t._v("#")]),t._v(" 业务模型分析和设计")]),t._v(" "),n("p",[t._v("四色建模法的四个概念，五个步骤")]),t._v(" "),n("ul",[n("li",[t._v("时标性对象，实体、角色、描述")]),t._v(" "),n("li",[t._v("时间轴模型图、模型关系、识别和添加实体、角色、描述")]),t._v(" "),n("li",[t._v("资金账户模型、红包模型")])]),t._v(" "),n("h4",{attrs:{id:"数据库物理模型设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据库物理模型设计"}},[t._v("#")]),t._v(" 数据库物理模型设计")]),t._v(" "),n("p",[t._v("以业务领域模型为基础，推导出物理模型")]),t._v(" "),n("ul",[n("li",[t._v("数据库物理模型不一定要和业务领域模型保持一致")]),t._v(" "),n("li",[t._v("合理的取舍和做减法")]),t._v(" "),n("li",[t._v("从设计角度优化物理模型")])]),t._v(" "),n("h4",{attrs:{id:"架构设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#架构设计"}},[t._v("#")]),t._v(" 架构设计")]),t._v(" "),n("p",[t._v("红包系统是一个高并发的资金交易系统")]),t._v(" "),n("ul",[n("li",[t._v("应用架构概述")]),t._v(" "),n("li",[t._v("红包系统高并发高性能解决之道")]),t._v(" "),n("li",[t._v("超卖问题：事务锁、数据库无符号类型字段、乐观锁")])]),t._v(" "),n("h4",{attrs:{id:"golang-编程实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#golang-编程实践"}},[t._v("#")]),t._v(" Golang 编程实践")]),t._v(" "),n("ul",[n("li",[t._v("项目主体构建和代码分层架构")]),t._v(" "),n("li",[t._v("公共资源访问设计和基础资源的管理")]),t._v(" "),n("li",[t._v("红包算法设计和超卖问题的基准测试实战")])]),t._v(" "),n("h4",{attrs:{id:"后续课程预告"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#后续课程预告"}},[t._v("#")]),t._v(" 后续课程预告")]),t._v(" "),n("p",[t._v("构建一个完整的五脏俱全的高并发分布式微服务红包系统")]),t._v(" "),n("ul",[n("li",[t._v("红包单体应用编码实战、微服务拆分、性能分析")]),t._v(" "),n("li",[t._v("性能优化：接口、缓存、分片、消息队列")]),t._v(" "),n("li",[t._v("微服务生态：网关、限流、监控告警、安全")])])])}),[],!1,null,null,null);s.default=r.exports}}]);