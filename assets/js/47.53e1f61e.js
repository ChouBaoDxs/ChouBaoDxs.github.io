(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{1001:function(s,a,t){"use strict";t.r(a);var e=t(12),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"custom-block danger"},[e("p",{staticClass:"title"}),e("p",[s._v("视频名称：Jenkins+K8s 实现持续集成"),e("br"),s._v("\n视频地址：http://www.imooc.com/learn/1112"),e("br"),s._v("\n简介：本课程介绍 jenkins、docker、k8s 以及使用一个实例讲解如何实现持续集成、代码的自动化编译打包和部署"),e("br"),s._v("\n我的评价：★★★★★")])]),s._v(" "),e("p",[s._v("[TOC]")]),s._v(" "),e("h2",{attrs:{id:"第-1-章-课程介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-1-章-课程介绍"}},[s._v("#")]),s._v(" 第 1 章 课程介绍")]),s._v(" "),e("p",[s._v("本章主要介绍课程目标：1）让大家基本了解 docker、k8s、持续集成与 Jenkins；2）让大家掌握实际项目在测试环境中，如何通过 Jenkins+k8s 实现持续集成的；介绍学习内容：Docker、k8s、持续集成、Jenkins、实例 介绍使用案例：一个 spring boot 项目，使用 Jenkins 自动化编译、打包、发布 以及效果展示。")]),s._v(" "),e("h3",{attrs:{id:"_1-1-课程整体介绍-04-44"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-课程整体介绍-04-44"}},[s._v("#")]),s._v(" 1-1 课程整体介绍 (04:44)")]),s._v(" "),e("h4",{attrs:{id:"课程目标"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课程目标"}},[s._v("#")]),s._v(" 课程目标")]),s._v(" "),e("ul",[e("li",[s._v("让大家基本了解 docker、k8s、持续集成、Jenkins")]),s._v(" "),e("li",[s._v("让大家掌握 docker、k8s、Jenkins 的基本使用")]),s._v(" "),e("li",[s._v("让大家掌握如何使用 Jenkins+k8s 实现持续集成与测试环境的自动化管理")])]),s._v(" "),e("h4",{attrs:{id:"课程安排"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课程安排"}},[s._v("#")]),s._v(" 课程安排")]),s._v(" "),e("p",[s._v("docker、k8s、持续集成、jenkins、实例综合运用")]),s._v(" "),e("h4",{attrs:{id:"课程使用案例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课程使用案例"}},[s._v("#")]),s._v(" 课程使用案例")]),s._v(" "),e("ul",[e("li",[s._v("一个 spring boot 项目, 使用 Jenkins 自动化编译、打包、发布")]),s._v(" "),e("li",[s._v("项目地址:https://github.com/solochen84/SpringBootDemo")])]),s._v(" "),e("h4",{attrs:{id:"效果展示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#效果展示"}},[s._v("#")]),s._v(" 效果展示")]),s._v(" "),e("p",[s._v('jenkins 里点击"开始构建"，然后浏览器就能访问该项目')]),s._v(" "),e("h4",{attrs:{id:"课前技术储备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课前技术储备"}},[s._v("#")]),s._v(" 课前技术储备")]),s._v(" "),e("ul",[e("li",[s._v("初步了解 java、maven、spring boot")]),s._v(" "),e("li",[s._v("了解 git")]),s._v(" "),e("li",[s._v("熟悉 Linux、了解 shell")])]),s._v(" "),e("h3",{attrs:{id:"_1-2-实验环境规划-02-03"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-实验环境规划-02-03"}},[s._v("#")]),s._v(" 1-2 实验环境规划 (02:03)")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("主机")]),s._v(" "),e("th",[s._v("用途")]),s._v(" "),e("th",[s._v("主机名")]),s._v(" "),e("th",[s._v("操作系统")]),s._v(" "),e("th",[s._v("网络模式")]),s._v(" "),e("th",[s._v("内存大小")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("10.10.10.45")]),s._v(" "),e("td",[s._v("K8s master")]),s._v(" "),e("td",[s._v("Ubuntu")]),s._v(" "),e("td",[s._v("Ubuntu 16.04")]),s._v(" "),e("td",[s._v("桥接")]),s._v(" "),e("td",[s._v("1024M")])]),s._v(" "),e("tr",[e("td",[s._v("10.10.10.71")]),s._v(" "),e("td",[s._v("K8s node、"),e("br"),s._v("Jenkins、registry")]),s._v(" "),e("td",[s._v("Ubuntu-node")]),s._v(" "),e("td",[s._v("Ubuntu 16.04")]),s._v(" "),e("td",[s._v("桥接")]),s._v(" "),e("td",[s._v("1024M")])])])]),s._v(" "),e("p",[s._v("使用 VirtualBox 安装虚拟机。主机名必须不一样，因为 k8s 使用主机名来识别节点。")]),s._v(" "),e("h3",{attrs:{id:"_1-3-虚拟机安装配置-12-04"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-虚拟机安装配置-12-04"}},[s._v("#")]),s._v(" 1-3 虚拟机安装配置 (12:04)")]),s._v(" "),e("p",[s._v("virtualbox 安装：https://www.virtualbox.org/\nubuntu 镜像下载：http://releases.ubuntu.com/ ，一路点击找到http://releases.ubuntu.com/xenial/ubuntu-16.04.6-server-amd64.iso这个下载链接\n后续：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("使用VirtualBox无脑新建两台Ubuntu虚拟机(注意主机名一定要不一样)，设置网络为桥接网卡(需要重启)。\n设置root密码。\n    sudo passwd root\n发现没装ssh,安装ssh：\n    apt-get update\n    apt-get install ssh -y\n设置允许ssh root连接。\n    sudo vim /etc/ssh/ssh_config\n    # 找到PermitRootLogin设置为yes\n    PermitRootLogin yes\n重启ssh：systemctl restart sshd\n查看ip，记下来用ssh连接一下看看\n    ip a\n关闭防火墙：\n    ufw disable\n设置科学上网：\n    安装一下shadowsocks，搞一个账号来\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h2",{attrs:{id:"第-2-章-你应该掌握的-docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-2-章-你应该掌握的-docker"}},[s._v("#")]),s._v(" 第 2 章 你应该掌握的 Docker")]),s._v(" "),e("p",[s._v("本章重点介绍 docker 是什么、docker 为什么出现、docker 的特点、docker 的基本使用如 1. 基本概念：镜像、容器、存储卷、仓库；2. 版本查看、镜像拉取、容器运行、端口映射、数据持久化、进入容器、查看容器日志、查询容器、查询镜像；3. 镜像构建、Dockerfile 语法等。")]),s._v(" "),e("h3",{attrs:{id:"_2-1-docker-容器-07-15"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-docker-容器-07-15"}},[s._v("#")]),s._v(" 2-1 docker 容器 (07:15)")]),s._v(" "),e("ul",[e("li",[s._v("Docker 是一种容器技术")]),s._v(" "),e("li",[s._v("容器是什么：容器是一种轻量级、可移植、自包含的软件打包技术，使应用程序可以在几乎任何地方以相同的方式运行")]),s._v(" "),e("li",[s._v("开发在自己笔记本上创建并测试好的容器，无需任何修改就能够所在生产系统的虚拟机、物理服务器或公有云主机上运行")]),s._v(" "),e("li",[s._v("容器来源于集装箱，二者的英文都是 Container，集装箱解决了运输的难题")]),s._v(" "),e("li",[s._v("Docker 的中文意思是码头工人")]),s._v(" "),e("li",[s._v("Docker 的图标是集装箱")]),s._v(" "),e("li",[s._v("容器 VS 虚拟机：容器是虚拟出硬件和操作系统，容器相当于进程(轻量级、可移植、资源占用少)")])]),s._v(" "),e("h4",{attrs:{id:"docker-的特点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-的特点"}},[s._v("#")]),s._v(" docker 的特点")]),s._v(" "),e("ul",[e("li",[s._v("轻量级、可移植、资源占用少")]),s._v(" "),e("li",[s._v("对于开发人员-Build Once、Run Anywhere")]),s._v(" "),e("li",[s._v("对于运维人员-Configure Once、Run Anything")])]),s._v(" "),e("h3",{attrs:{id:"_2-2-docker-安装以及配置-03-37"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-docker-安装以及配置-03-37"}},[s._v("#")]),s._v(" 2-2 docker 安装以及配置 (03:37)")]),s._v(" "),e("h4",{attrs:{id:"ubuntu-安装-docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ubuntu-安装-docker"}},[s._v("#")]),s._v(" ubuntu 安装 docker")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("apt-get update\napt-get install -y docker.io\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h4",{attrs:{id:"docker-配置加速器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-配置加速器"}},[s._v("#")]),s._v(" docker 配置加速器")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('进入阿里云容器镜像服务控制台，会看到阿里云专门分配的加速地址，我的是：https://fm6qrf83.mirror.aliyuncs.com\n容器镜像服务控制台下面一点还有各种系统的配置说明，这里复制一下ubuntu的：\nsudo mkdir -p /etc/docker\nsudo tee /etc/docker/daemon.json <<-\'EOF\'\n{\n  "registry-mirrors": ["https://fm6qrf83.mirror.aliyuncs.com"]\n}\nEOF\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"_2-3-docker-基本使用-19-35"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-docker-基本使用-19-35"}},[s._v("#")]),s._v(" 2-3 docker 基本使用 (19:35)")]),s._v(" "),e("p",[s._v("两节合并")]),s._v(" "),e("h3",{attrs:{id:"_2-4-docker-基本使用-07-15"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-docker-基本使用-07-15"}},[s._v("#")]),s._v(" 2-4 docker 基本使用 (07:15)")]),s._v(" "),e("h4",{attrs:{id:"启动一个-mysql-容器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动一个-mysql-容器"}},[s._v("#")]),s._v(" 启动一个 mysql 容器")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("拉取mysql镜像：docker pull mysql:5.6\n启动一个mysql容器：docker run -p 3306:3306 --name mymysql -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6\nmysql的docker hub地址：https://hub.docker.com/_/mysql\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"docker-架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-架构"}},[s._v("#")]),s._v(" docker 架构")]),s._v(" "),e("ul",[e("li",[s._v("Client：docker build/pull/run")]),s._v(" "),e("li",[s._v("DOCKER_HOST：Images、Containers、Docker Daemon")]),s._v(" "),e("li",[s._v("Registry：.")])]),s._v(" "),e("h4",{attrs:{id:"docker-基本概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-基本概念"}},[s._v("#")]),s._v(" Docker 基本概念")]),s._v(" "),e("ul",[e("li",[s._v("镜像(image)、容器(container)、仓库(registry)：仓库用于存放镜像，镜像下载下来并运行，就成为一个容器。(在我看来，镜像其实就类似于启动虚拟机的 iso)")]),s._v(" "),e("li",[s._v("仓库分公有和私有两种。Docker hub 是默认仓库。")])]),s._v(" "),e("h4",{attrs:{id:"docker-基本使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-基本使用"}},[s._v("#")]),s._v(" docker 基本使用")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("查看docker版本：docker version\n镜像拉取：docker pull <image_name>\n查询本地的镜像：docker image ls / docker images\n镜像删除：docker rmi <image_name>\n查看本地容器：docker ps\n仓库登录：docker login\n\n命令讲解：\n例子：docker run -p 3306:3306 --name mymysql -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6\n    容器运行：docker run ...\n    端口映射：-p <宿主机端口>:<容器端口> # 可以在主机端口前面指定ip，也可以多个-p来映射多个端口\n    挂存储卷：-v /home/mysql/data:/var/lib/mysql\n    进入容器：docker exec -it <容器id或名字> /bin/bash # 进入后当普通虚拟机用\n    查看容器日志：docker logs -f <容器id或名字>\n    查询容器：docker ps # 运行起来的，想要查看全部的带上-a参数\n    设置环境变量：-e MYSQL_ROOT_PASSWORD=123456\n    容器停止：docker stop <容器id或名字>\n    容器删除：docker rm <容器id或名字>\n\n镜像构建：先写一个Dockerfile，然后执行docker build\n镜像打tag：\n    docker build -t aaaa:1.0 .   # .代表去当前目录找Dockerfile\n    docker build -t aaaa:1.0 -f /root/Dockerfile   # 指定Dockerfile路径\n镜像推送：\n    1. 先build或给一个现成的镜像打tag\n        docker tag mysql:5.6 myregistry/mysql:1.0   # 执行docker images看看\n    2. 推送\n        docker push myregistry/mysql:1.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br")])]),e("h4",{attrs:{id:"dockerfile-基本语法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-基本语法"}},[s._v("#")]),s._v(" Dockerfile 基本语法")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("FROM：指定基础镜像\nRUN/CMD/ENTRYPOINT\n    RUN命令执行命令并创建新的镜像层，通常用于安装软件包\n    CMD命令设置容器启动后默认执行的命令及其参数，但CMD设置的命令能够被docker run命令后面的命令行参数替换\n    ENTRYPOINT配置容器启动时的执行命令（不会被忽略，一定会被执行，即使运行 docker run时指定了其他命令）\nEXPOSE：暴露端口\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("strong",[s._v("flask 项目例子")]),s._v("：\ngithub 代码：https://github.com/solochen84/ph\n目录结构如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(".\n├── Dockerfile\n├── main.py\n└── requirements.txt\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("Dockerfile：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 基础镜像信息")]),s._v("\nFROM ubuntu"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.04")]),s._v('\n\nRUN echo "deb http'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('//mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse" '),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' /etc/apt/sources.list\nRUN echo "deb http'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//mirrors.aliyun.com/ubuntu/ xenial"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('security main restricted universe multiverse" '),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' /etc/apt/sources.list\nRUN echo "deb http'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//mirrors.aliyun.com/ubuntu/ xenial"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('updates main restricted universe multiverse" '),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' /etc/apt/sources.list\nRUN echo "deb http'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//mirrors.aliyun.com/ubuntu/ xenial"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('backports main restricted universe multiverse" '),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" /etc/apt/sources.list\n\nRUN apt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key update "),e("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" apt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get update "),e("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" apt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get install "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("y wget\nRUN apt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get remove python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pip python3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pip\nRUN apt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get install "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("y python3 python\nRUN wget https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//bootstrap.pypa.io/get"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pip.py "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("check"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("certificate\nRUN python get"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pip.py\nRUN python3 get"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pip.py\n\nRUN apt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get install "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("y \\\n    python3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("numpy python3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nose python3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pandas python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("h5py \\\n    python python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("numpy python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nose python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pandas python3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("h5py \\\n    pep8 python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("wheel  python"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sphinx\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建目录")]),s._v("\nRUN mkdir "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p /usr/local/ph\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拷贝文件")]),s._v("\nADD ./ /usr/local/ph\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置工作目录")]),s._v("\nWORKDIR /usr/local/ph\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装requirements")]),s._v("\nRUN /usr/local/bin/pip install "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cache"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dir "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r requirements.txt\nCMD "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"python3"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./main.py"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nEXPOSE 5000\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("p",[s._v("requirements.txt：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("flask\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("main.py：")]),s._v(" "),e("div",{staticClass:"language-py line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" flask "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Flask\n\n\napp "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("hello")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world12333345677!!!"')]),s._v("\n\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'__main__'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n    app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.0.0'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("h2",{attrs:{id:"第-3-章-必知必会的-k8s"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-3-章-必知必会的-k8s"}},[s._v("#")]),s._v(" 第 3 章 必知必会的 K8s")]),s._v(" "),e("h3",{attrs:{id:"_3-1-k8s-介绍-04-10"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-k8s-介绍-04-10"}},[s._v("#")]),s._v(" 3-1 k8s 介绍 (04:10)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("一行命令启动k8s：kubectl apply -f /root/kube.yaml\n查看启动的服务：kubectl get services --all-namespaces\n根据配置文件创建应用：kubectl create -f test.yaml\nk8s作用就是根据配置文件直接启动一个应用，这个配置文件里可能涉及很多服务、副本\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("k8s 是什么：")]),s._v(" "),e("ul",[e("li",[s._v("基于容器技术的分布式架构领先方案。它是 google 严格保密十几年的秘密武器 Borg 的一个开源版本。")]),s._v(" "),e("li",[s._v("Kubernetes 是 Google 开源的一个容器编排引擎,它支持自动化部署、大规模可伸缩、应用容器化管理。")])]),s._v(" "),e("h3",{attrs:{id:"_3-2-k8-能做什么-18-04"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-k8-能做什么-18-04"}},[s._v("#")]),s._v(" 3-2 k8 能做什么 (18:04)")]),s._v(" "),e("h4",{attrs:{id:"k8-能做什么"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8-能做什么"}},[s._v("#")]),s._v(" k8 能做什么")]),s._v(" "),e("ul",[e("li",[s._v("容器的自动化复制和部署。随时扩展或收缩容器规模，并提供负载均衡。")]),s._v(" "),e("li",[s._v("方便地容器升级")]),s._v(" "),e("li",[s._v("提供容器弹性，如果失效就替换它")])]),s._v(" "),e("h4",{attrs:{id:"k8s-对于测试能做什么"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-对于测试能做什么"}},[s._v("#")]),s._v(" k8s 对于测试能做什么")]),s._v(" "),e("ul",[e("li",[s._v("测试服务器的集中化、自动化管理。将各种平台的服务器加入集群，按需部署或销毁。")]),s._v(" "),e("li",[s._v("持续集成时方便地自动部署。")])]),s._v(" "),e("h4",{attrs:{id:"k8s-架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-架构"}},[s._v("#")]),s._v(" k8s 架构")]),s._v(" "),e("div",{attrs:{align:"center"}},[e("img",{attrs:{width:"300",src:t(811)}})]),s._v(" "),e("h4",{attrs:{id:"k8s-基本概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-基本概念"}},[s._v("#")]),s._v(" k8s 基本概念")]),s._v(" "),e("ul",[e("li",[s._v("Master 是主服务器，node 是用于部署应用容器的服务器。")]),s._v(" "),e("li",[s._v("Pod 基本操作单元，也是应用运行的载体。整个 Kubernetes 系统都是围绕着 Pod 展开的，比如如何部署运行 Pod、如何保证 Pod 的数量、如何访问 Pod 等。")]),s._v(" "),e("li",[s._v("Deployment 定义了 pod 部署的信息。")]),s._v(" "),e("li",[s._v("若干个 pod 副本组成一个 service，对外提供服务")]),s._v(" "),e("li",[s._v("副本是指一个 pod 的多个实例")]),s._v(" "),e("li",[s._v("Namesapce 用于多租户的资源隔离。在测试环境中可以根据 namespace 划分成多套测试环境。默认有 2 个 namespace:kube-system/default")])]),s._v(" "),e("h4",{attrs:{id:"k8s-调度过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-调度过程"}},[s._v("#")]),s._v(" k8s 调度过程")]),s._v(" "),e("ol",[e("li",[s._v("kubernetes client 将请求发送给 API server")]),s._v(" "),e("li",[s._v("API Server 根据请求的类型，将处理结果存入高可用键值存储系统 Etcd 中")]),s._v(" "),e("li",[s._v("Scheduler 将未分发的 Pod 绑定(bind)到可用的 Node 节点上，存到 etcd 中")]),s._v(" "),e("li",[s._v("Controller Manager 根据 Etcd 中的信息，调用 node 中的 kubelet 创建 pod")]),s._v(" "),e("li",[s._v("Controller Manager 监控 pod 的运行状况并确保运行正常")])]),s._v(" "),e("h3",{attrs:{id:"_3-3-k8s-的安装-05-05"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-k8s-的安装-05-05"}},[s._v("#")]),s._v(" 3-3 k8s 的安装 (05:05)")]),s._v(" "),e("h4",{attrs:{id:"k8s-安装前的准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-安装前的准备"}},[s._v("#")]),s._v(" k8s 安装前的准备")]),s._v(" "),e("ul",[e("li",[s._v("准备科学上网。在主机上安装 shadowsocks，并配好服务器(我自己是搬瓦工自建 ss 的，虽然网速慢了点)")])]),s._v(" "),e("h4",{attrs:{id:"k8s-安装说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-安装说明"}},[s._v("#")]),s._v(" k8s 安装说明")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("2台主机都要安装docker\n2台主机都要安装kubeadm，kubelet、kubectl\n2台主机上都要禁用虚拟内存\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"k8s-安装以及配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-安装以及配置"}},[s._v("#")]),s._v(" k8s 安装以及配置")]),s._v(" "),e("p",[s._v("禁用虚拟内存："),e("code",[s._v("swapoff -a")]),s._v("\n安装 kubeadm，kubelet、kubectl：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1. apt-get update && apt-get install -y apt-transport-https curl\n\n2.\ncurl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -\n\ncat <<EOF >/etc/apt/sources.list.d/kubernetes.list\ndeb http://apt.kubernetes.io/ kubernetes-xenial main\nEOF\n\n# curl如果连不上，需要设置科学上网：export http_proxy=10.10.10.94:1087 && export https_proxy=10.10.10.94:1087\n\n3. apt-get update && apt-get install -y kubelet kubeadm kubectl\n4. apt-mark hold kubelet kubeadm kubectl # 禁止更新\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"_3-4-k8s-的设置科学上网-03-40"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-k8s-的设置科学上网-03-40"}},[s._v("#")]),s._v(" 3-4 k8s 的设置科学上网 (03:40)")]),s._v(" "),e("p",[s._v("就是上一节笔记中 export 代理那里，端口需要查看一下宿主机的 shadowsocks 监听在哪个端口上(点击纸飞机->HTTP 代理设置)，ip 则是宿主机的内网 ip。\n查看是否设置成功："),e("code",[s._v("echo $http_proxy")])]),s._v(" "),e("h3",{attrs:{id:"_3-5-k8s-配置-07-45"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-k8s-配置-07-45"}},[s._v("#")]),s._v(" 3-5 k8s 配置 (07:45)")]),s._v(" "),e("p",[s._v("就是 3-3 中的")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("3. apt-get update && apt-get install -y kubelet kubeadm kubectl\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("注意这一步也需要设置科学上网，而且比较麻烦，步骤如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('1. 随便新建一个文件，讲师的是apt_proxy_conf，写入以下内容：\n    Acquire::http::proxy "http://192.168.0.186:1087";\n    Acquire::ftp::proxy "ftp://192.168.0.186:1087";\n    Acquire::https::proxy "https://192.168.0.186:1087";\n2. 此时应当执行的apt命令如下：\n    apt-get -c apt_proxy_conf update\n    apt-get -c apt_proxy_conf install -y kubelet kubeadm kubectl\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("然后执行 3-3 中的 4：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("4. apt-mark hold kubelet kubeadm kubectl # 禁止更新\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"_3-6-k8s-初始化-master-03-08"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-k8s-初始化-master-03-08"}},[s._v("#")]),s._v(" 3-6 k8s 初始化 master (03:08)")]),s._v(" "),e("p",[s._v("合并到下一节")]),s._v(" "),e("h3",{attrs:{id:"_3-7-k8s-初始化-master-二-01-26"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-k8s-初始化-master-二-01-26"}},[s._v("#")]),s._v(" 3-7 k8s 初始化 master（二） (01:26)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1.禁用虚拟内存：swapoff -a\n2.初始化k8s：kubeadm init --pod-network-cidr=10.244.0.0/16\n    - 讲师这里安装报错了，要求CPU核数必须为2以上，可以按照提示带上参数忽略：\n        --ignore-preflight-errors=NumCPU\n    - 这一步因为连不上Google的镜像库，会导致失败。记录下载失败的镜像，按如下方式处理：\n        1. 可以从keveon后mirrorgooglecontainers镜像库中下载，当其中一个镜像库找不到时，尝试另外一个\n        2. 然后再手工设置tag\n            docker pull mirrorgooglecontainers/$imageName\n            # 提示找不到镜像就换这个看看docker pull keveon/$imageName\n            docker tag mirrorgooglecontainers/$imageName k8s.gcr.io/$imageName\n            docker rmi mirrorgooglecontainers/$imageName\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h3",{attrs:{id:"_3-8-k8s-安装和配置-17-11"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-k8s-安装和配置-17-11"}},[s._v("#")]),s._v(" 3-8 k8s 安装和配置 (17:11)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1.手工下载各种失败的镜像并打好tag之后，重新执行：\n    kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=NumCPU\n2.记录一下最后一条kubeadm join命令，在其他k8s主机上执行这个命令就可以加入成为节点之一\n3.进行一些基础配置(kubeadm init的结果中有提示)：\n    mkdir -p $HOME/.kube\n    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n    sudo chown $(id -u):$(id -g) $HOME/.kube/config\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"_3-9-k8s-安装网络插件-07-50"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-k8s-安装网络插件-07-50"}},[s._v("#")]),s._v(" 3-9 k8s 安装网络插件 (07:50)")]),s._v(" "),e("h4",{attrs:{id:"安装网络插件-只需要在-master-执行"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装网络插件-只需要在-master-执行"}},[s._v("#")]),s._v(" 安装网络插件(只需要在 master 执行)")]),s._v(" "),e("ol",[e("li",[s._v("下载配置文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("sysctl net.bridge.bridge-nf-call-iptables=1\ncurl -O https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("修改一下 kube-flannel.yml 配置文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("...\ntolerations:\n    - key: node-role.kubernetes.io/master\n        operator: Exists\n        effect: NoSchedule\n    # 以下是新增的部分\n    - key: node.kubernetes.io/not-ready\n        operator: Exists\n        effect: NoSchedule\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("应用配置文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl apply -f kube-flannel.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h4",{attrs:{id:"添加-node-只在-node-上执行"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#添加-node-只在-node-上执行"}},[s._v("#")]),s._v(" 添加 node(只在 node 上执行)")]),s._v(" "),e("ul",[e("li",[s._v("将之前(3-8 节)记录下来的 kubeadm join 命令执行")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("swapoff -a\n(这一句就是3-8节记录下来的)kubeadm join ......\nsysctl net.bridge.bridge-nf-call-iptables=1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"检查安装配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#检查安装配置"}},[s._v("#")]),s._v(" 检查安装配置")]),s._v(" "),e("p",[s._v("检查 node 是否 ready：kubectl get node\n检查所有 pod 是否正常：kubectl get pod --all-namespaces -o wide # 讲师执行的是 kubectl get po --all-namespaces\npod 异常处理：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("如果有pod处于非running状态,则查看该pod: kubectl describe pod XXXXX -n kube-system, # 讲师执行的命令中，pod是po\n有可能是因为镜像无法下载导致镜像启动失败,如果是,手工在node上pull image ,然后在master上删掉对应pod,k8s会自动重新调度pod。\n删除pod命令: kubectl delete pod xxxx -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_3-10-k8s-安装异常处理-11-20"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-10-k8s-安装异常处理-11-20"}},[s._v("#")]),s._v(" 3-10 k8s 安装异常处理 (11:20)")]),s._v(" "),e("p",[s._v("查看异常的 pod(非 running 的)信息：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl describe po XXXXX -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("发现错误信息是没有拉取镜像，就在 node 机子上重新拉取一下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("docker pull mirrorgoolecontainers/{image_name}\n# 讲师执行的docker pull mirrorgoolecontainers/pause:3.1\n打个tag：\ndocker tag mirrorgoolecontainers/pause:3.1 k8s.gcr.io/pause:3.1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("在 master 上删除 pod：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl delete pod xxxx -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("稍等一会儿，master 会自动加载 pod")]),s._v(" "),e("h4",{attrs:{id:"node-断开与-master-连接重新-init"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#node-断开与-master-连接重新-init"}},[s._v("#")]),s._v(" node 断开与 master 连接重新 init")]),s._v(" "),e("p",[s._v("node 断开与 master 的连接：执行"),e("code",[s._v("kubeadm reset")]),s._v("即可，然后重新 join\nmaster 重新 init：执行"),e("code",[s._v("kubeadm reset")]),s._v("之后可以重新 init\n重启后需要执行以下命令：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("swapoff -a\nsystemctl daemon-reload\nsystemctl restart kubelet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_3-11-k8s-基本使用-09-36"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-11-k8s-基本使用-09-36"}},[s._v("#")]),s._v(" 3-11 k8s 基本使用 (09:36)")]),s._v(" "),e("h4",{attrs:{id:"deployment-创建、删除、查看"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deployment-创建、删除、查看"}},[s._v("#")]),s._v(" Deployment 创建、删除、查看")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl get deployment --all-namespaces\nkubectl create -f test.yaml\nkubectl delete -f test.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"service-创建及查看"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service-创建及查看"}},[s._v("#")]),s._v(" Service 创建及查看")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl get service --all-namespaces\nkubectl create -f test.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h4",{attrs:{id:"pod-查看、删除"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pod-查看、删除"}},[s._v("#")]),s._v(" Pod 查看、删除")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl get pod --all-namespaces -o wide\nkubectl describe pod xxxxx -n kube-system # 查看某个pod的具体信息\nkubectl delete pod xxxxx -n kube-system # 删除某个pod的具体信息\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("- k8s介绍(what/why、架构、重要概念)\n- k8s安装配置(master安装配置、node安装配置)\n- k8s基本使用(node、deployment、service、pod)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"第-4-章-持续集成与-jenkins"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-4-章-持续集成与-jenkins"}},[s._v("#")]),s._v(" 第 4 章 持续集成与 Jenkins")]),s._v(" "),e("p",[s._v("本章重点讲解持续集成是什么、为什么需要持续集成、Jenkins 是什么、Jenkins 安装、Jenkins 服务器 git/maven 安装以及 Jenkins 配置：ssh/publish over ssh/git parameter/Maven Integration plugin。")]),s._v(" "),e("h3",{attrs:{id:"_4-1-持续集成-06-02"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-持续集成-06-02"}},[s._v("#")]),s._v(" 4-1 持续集成 (06:02)")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("持续集成(CI)是一种软件开发实践")])]),s._v(" "),e("li",[e("p",[s._v("团队开发成员经常集成他们的工作，每个成员每天至少集成一次")])]),s._v(" "),e("li",[e("p",[s._v("每天可能会发生多次集成")])]),s._v(" "),e("li",[e("p",[s._v("每次集成都通过自动化的构建(包括编译、打包、部署、测试，全是自动化)来验证")])]),s._v(" "),e("li",[e("p",[s._v("从而尽早地发现集成错误")])]),s._v(" "),e("li",[e("p",[s._v("构建分为提交构建和定时构建(比如每天一次)")])]),s._v(" "),e("li",[e("p",[s._v("持续集成过程：")]),s._v(" "),e("div",{attrs:{align:"center"}},[e("img",{attrs:{width:"500",src:t(812)}})])]),s._v(" "),e("li",[e("p",[s._v("持续集成优势：快速集成、快速反馈、快速解决；团队信心更强；发布效率更高")])])]),s._v(" "),e("h3",{attrs:{id:"_4-2-jenkins-介绍-03-16"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-jenkins-介绍-03-16"}},[s._v("#")]),s._v(" 4-2 Jenkins 介绍 (03:16)")]),s._v(" "),e("ul",[e("li",[s._v("最流行的持续集成工具")]),s._v(" "),e("li",[s._v("任务调度平台")])]),s._v(" "),e("h3",{attrs:{id:"_4-3-jenkins-安装以及配置-31-43"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-jenkins-安装以及配置-31-43"}},[s._v("#")]),s._v(" 4-3 Jenkins 安装以及配置 (31:43)")]),s._v(" "),e("h4",{attrs:{id:"jdk-安装以及配置环境变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jdk-安装以及配置环境变量"}},[s._v("#")]),s._v(" jdk 安装以及配置环境变量")]),s._v(" "),e("p",[s._v("下载 jdk(一般 1.8 版本就可以)，解压即可\n配置环境变量：\n"),e("code",[s._v("vim /etc/profile # 添加 export JAVA_HOME=/home/jdk.1.8.0_181 export JRE_HOME=${JAVA_HOME}/jre export CLASSPATH=.:${JAVA_HOME}/lib;${JRE_HOME}/lib export PATH=.:${JAVA_HOME}/bin:$PATH # 使配置生效 source /etc/profile")])]),s._v(" "),e("h4",{attrs:{id:"tomcat-下载并解压"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tomcat-下载并解压"}},[s._v("#")]),s._v(" tomcat 下载并解压")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v("wget下载tomcat的tar.gz，tar -xvf xxx.tar.gz解压\n")])])]),e("h4",{attrs:{id:"jenkins-的-war-包-官网分类是-generic-java-package-下载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-的-war-包-官网分类是-generic-java-package-下载"}},[s._v("#")]),s._v(" Jenkins 的 war 包(官网分类是 Generic Java package)下载")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v("下载war包后放到tomcat的app目录，启动tomcat\n启动tomcat：/home/tomcat9# bin/startup.sh\n查看ip：ip a\n访问jenkins：ip:8080/jenkins，第一次访问需要一些初始化配置\n")])])]),e("h4",{attrs:{id:"安装-git"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-git"}},[s._v("#")]),s._v(" 安装 git")]),s._v(" "),e("ul",[e("li",[s._v("apt-get install git")])]),s._v(" "),e("h4",{attrs:{id:"安装-maven"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-maven"}},[s._v("#")]),s._v(" 安装 maven")]),s._v(" "),e("ul",[e("li",[s._v("去官网找到 appache-maven-x.x.x-bin.tar.gz 的下载连接，wget 下载后 tar 解压")]),s._v(" "),e("li",[s._v("配置环境变量："),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("vim etc/profile\n    export M2_HOME=/home/appache-maven-x.x.x-bin\n    export CLASSPATH=$CLASSPATH:$M2_HOME/lib\n    export PATH=$PATH:$M2_HOME/bin\nsource etc/profile\nmvn -v\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])])]),s._v(" "),e("li",[s._v("修改成阿里云镜像，maven 的 conf 目录下的 settings.xml 文件"),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("...\n<mirrors>\n    <mirror>\n　　　　<id>nexus-aliyun</id>\n　　　　<mirrorOf>*</mirrorOf>\n　　　　<name>Nexus aliyun</name>\n　　　　<url>http://maven.aliyun.com/nexus/content/groups/public/</url>\n　　</mirror>\n</mirrors>\n...\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])])])]),s._v(" "),e("h4",{attrs:{id:"jenkins-配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-配置"}},[s._v("#")]),s._v(" jenkins 配置")]),s._v(" "),e("ul",[e("li",[s._v("全局工具配置中，配置 jdk/git/maven，配置项可以通过以下几个命令查到\n"),e("ul",[e("li",[s._v("echo $JAVA_HOME")]),s._v(" "),e("li",[s._v("which git")]),s._v(" "),e("li",[s._v("ehco $M2_HOME")])])])]),s._v(" "),e("h4",{attrs:{id:"总结-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),e("ul",[e("li",[s._v("持续集成介绍(what/why)")]),s._v(" "),e("li",[s._v("Jenkins 介绍")]),s._v(" "),e("li",[s._v("Jenkins 安装配置")])]),s._v(" "),e("h2",{attrs:{id:"第-5-章-jenkins-k8s-发布实例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-5-章-jenkins-k8s-发布实例"}},[s._v("#")]),s._v(" 第 5 章 Jenkins+k8s 发布实例")]),s._v(" "),e("p",[s._v("本章重点介绍 Registry 安装配置和使用、Jenkin 项目创建与配置、Jenkin 项目构建等。")]),s._v(" "),e("h3",{attrs:{id:"_5-1-jenkins-k8s-发布实例-06-40"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-jenkins-k8s-发布实例-06-40"}},[s._v("#")]),s._v(" 5-1 Jenkins+k8s 发布实例 (06:40)")]),s._v(" "),e("h4",{attrs:{id:"安装启动-registry"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装启动-registry"}},[s._v("#")]),s._v(" 安装启动 registry")]),s._v(" "),e("p",[s._v("使用私有仓库，在 k8s 的 node 机器上执行")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("docker pull registry\ndocker run -p 5000:5000 -v /home/registry_images:/var/lib/registry -d registry\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h4",{attrs:{id:"registry-使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#registry-使用"}},[s._v("#")]),s._v(" registry 使用")]),s._v(" "),e("p",[s._v("node 和 master 都要进行以下操作")]),s._v(" "),e("ul",[e("li",[s._v("修改/etc/docker/daemon.json 文件"),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "insecure-registries":[\n        "192.168.0.108:5000", # 这一行是新增的，就是指向上面启动registry的那台机子\n        "registry-scu.cloudtogo.cn"\n    ],\n    "registry-mirrors":["http://dcwzscc0.mirror.aliyuncs.com"],\n    "live-restore":true\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])])]),s._v(" "),e("li",[s._v("重启 docker："),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl restart docker\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])]),s._v(" "),e("li",[s._v("测试拉取镜像并 push 到私有仓库："),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("docker pull nginx\ndocker tag nginx 192.168.0.108:5000/nginx:test\ndocker push 192.168.0.108:5000/nginx:test\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])])]),s._v(" "),e("h3",{attrs:{id:"_5-2-registry-安装配置和使用-00-15"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-registry-安装配置和使用-00-15"}},[s._v("#")]),s._v(" 5-2 registry 安装配置和使用 (00:15)")]),s._v(" "),e("p",[s._v("就 15 秒，就是展示了一下 5-1 中测试 nginx 镜像拉取和 push 的三句命令")]),s._v(" "),e("h3",{attrs:{id:"_5-3-jenkin-项目创建与配置-11-42"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-jenkin-项目创建与配置-11-42"}},[s._v("#")]),s._v(" 5-3 Jenkin 项目创建与配置 (11:42)")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("在 jenkins 中创建一个 maven 项目")])]),s._v(" "),e("li",[e("p",[s._v("设置参数化构建")]),s._v(" "),e("ul",[e("li",[s._v("丢弃旧的构建：保持的构建的天数-2，保持构建的最大个数-2")]),s._v(" "),e("li",[s._v("参数化构建过程：Add Parameter——>Git Parameter"),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Name：branch\nDescription：# 可以不写\nParameter Type：Branch or Tag # 以git分支或tag进行构建\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])])])]),s._v(" "),e("li",[e("p",[s._v("设置源代码：")]),s._v(" "),e("ul",[e("li",[s._v("假如是一个 pubilc 项目，可以直接在"),e("code",[s._v("源码管理-git")]),s._v("中填写仓库地址，私有的话就需要配置下账号密码或私钥\n"),e("ul",[e("li",[s._v("讲师的例子仓库：https://github.com/solochen84/SpringBootDemo")])])])])]),s._v(" "),e("li",[e("p",[s._v("设置 Build 中的 maven 构建命令：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Root POM：pom.xml\nGoals and options：clean package\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("设置构建后操作，将 jar 包打包成 docker 镜像，并推送 registry")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("注意，对应打包和 push 的 docker 脚本(deploy_docker.sh)要提前写好放到对应目录")])]),s._v(" "),e("li",[e("p",[s._v("jenkins 中的项目配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Post Steps选项卡中Add post-build step——>执行shell，讲师填写的Command如下：\n#!/bin/sh\njarName=spring-boot-demo-0.0.1-SNAPSHOT.jar\njarFolder=ph\nprojectName=maven\ndocker_path=${WORKSPACE}\ncp ${WORKSPACE}/target/${jarName} ${docker_path}\nsh /root/docker_dir/deploy_docker.sh ${projectName} ${docker_path} ${jarName}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("讲师写的 deploy_docker.sh 内容大致如下(暂停视频纯手敲)：")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/sh")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# maven01 $workspace $jarname")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ${projectName} ${docker_path} ${jarName}")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("projectName")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("docker_path")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("appName")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$3")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#user_name=")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#password=")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%s"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("server_path")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.108:5000\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("target_image")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${projectName}")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${tag}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#${BUILD_NUMBER}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${target_image}")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${docker_path}")]),s._v("\ndocker build --build-arg "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${appName}")]),s._v(" -t "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${target_image}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\ndocker tag "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${target_image}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${server_path}")]),s._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${projectName}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" The name of image is "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${server_path}")]),s._v("\\/"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${target_image}")]),s._v('"')]),s._v("\ndocker push "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${server_path}")]),s._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${projectName}")]),s._v(":latest\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最后删除本地镜像")]),s._v("\ndocker rmi -f "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("docker images "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("projectName"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $3}'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" -n "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])])])])])]),s._v(" "),e("h3",{attrs:{id:"_5-4-jenkin-项目创建与配置-07-06"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-jenkin-项目创建与配置-07-06"}},[s._v("#")]),s._v(" 5-4 Jenkin 项目创建与配置 (07:06)")]),s._v(" "),e("p",[s._v("5-3 已经推送了构建好的 docker 镜像，现在需要在 k8s 的 master 中弄一个 development 把这个镜像跑起来")]),s._v(" "),e("ul",[e("li",[s._v("设置 jenkins 服务器到 k8s master ssh 免密登录\n"),e("ul",[e("li",[s._v("在 jenkins 服务器上执行："),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("ssh-keygen -t rsa # 生成秘钥对\nssh-copy-id -i ~/.ssh/id_rsa_pub root@{k8s的master的ip} # 把公钥扔到目标服务器上\nssh root@{k8s的master的ip} # 测试一下是否能免密登录\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])])])]),s._v(" "),e("li",[s._v("设置构建后操作，将 yaml 文件(即 development 的描述文件)拷贝到 k8s master 上并运行应用\n"),e("ul",[e("li",[s._v("讲师的示例项目(SpringBootDemo)根目录下有一个 kube.yaml 文件，内容如下：")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" maven"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" maven\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("31002")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" maven\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" extensions/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" maven"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" maven\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" maven\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.0.108"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("5000/maven"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" key\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"value"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br")])]),e("ul",[e("li",[s._v("jenkins 要执行的 shell(jenkins 构建后操作中增加一条执行 shell 就行)：")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" ok\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${WORKSPACE}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("docker_path")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${WORKSPACE}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${WORKSPACE}")]),s._v("/*.yaml "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("k8s master的ip"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(":/root/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("k8s master的ip"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'opt/bin/kubectl apply -f /root/kube.yaml'")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("k8s master的ip"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'opt/bin/kubectl get svc|grep maven'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])])])]),s._v(" "),e("h3",{attrs:{id:"_5-5-jenkin-项目构建-00-24"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-jenkin-项目构建-00-24"}},[s._v("#")]),s._v(" 5-5 Jenkin 项目构建 (00:24)")]),s._v(" "),e("p",[s._v("就 24 秒，没什么用")]),s._v(" "),e("h3",{attrs:{id:"_5-6-jenkin-项目构建-06-56"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-jenkin-项目构建-06-56"}},[s._v("#")]),s._v(" 5-6 Jenkin 项目构建 (06:56)")]),s._v(" "),e("p",[s._v("流程：参数化构建——>代码库地址——>maven 构建 jar 包——>docker 镜像构建、push——>ssh 到 k8s 运行镜像\n这一节演示了一下配置完成之后构建的效果，但是构建失败了，错误原因是 springboot 项目的 Dockerfile 有问题")]),s._v(" "),e("h3",{attrs:{id:"_5-7-jenkin-项目构建-12-32"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-jenkin-项目构建-12-32"}},[s._v("#")]),s._v(" 5-7 Jenkin 项目构建 (12:32)")]),s._v(" "),e("p",[s._v("项目根目录下的"),e("code",[s._v("Dockerfile")]),s._v("内容：")]),s._v(" "),e("div",{staticClass:"language-dockerfile line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" registry-scu.cloudtogo.cn/ubuntu:jdk")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" app")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$app")]),s._v(" app.jar")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"java"')]),s._v(","),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Djava.security.egd=file:/dev/./urandom"')]),s._v(","),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-jar"')]),s._v(","),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app.jar"')]),s._v("]")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("错误原因是基础镜像找不到，这个第三方提供的基础镜像应该是 http，而非 https 的，需要设置一下(node 和 master 都要操作)：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('vim /etc/docker/daemon.json\n    {\n        "insecure-registries":[ # 非安全的仓库地址，即以会以http访问\n            "192.168.0.108:5000",\n            "registry-scu.cloudtogo.cn" # 就是这一句，5-1中列出来过\n        ],\n        "registry-mirrors":["http://dcwzscc0.mirror.aliyuncs.com"],\n        "live-restore":true\n    }\nsystemctl daemon-reload\nsystemctl restart docker\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("修改完成之后，重新在 jenkins 里执行一下构建\ntips：将基础镜像都拉到私有仓库构建好，Dockerfile 里直接使用私有仓库的镜像，这样会快很多\n等待许久之后，查看运行状态：kubectl get services --all-namespaces")]),s._v(" "),e("h3",{attrs:{id:"_5-8-jenkin-项目构建-05-03"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-8-jenkin-项目构建-05-03"}},[s._v("#")]),s._v(" 5-8 Jenkin 项目构建 (05:03)")]),s._v(" "),e("p",[s._v("发现访问 springboot 项目失败，执行命令查看错误信息：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl get po --all-namespaces | grep maven # 这条命令会输出development名\nkubectl describe po {development名} -n default\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("发现错误原因是 yaml 文件里的 image 仓库地址配置错误，需要修改，先删除一下："),e("code",[s._v("kubectl delete -f kube.yaml")]),s._v("，然后"),e("code",[s._v("vim kube.yaml")]),s._v("修改成正确的仓库地址，执行"),e("code",[s._v("kubectl apply -f kube.yaml")]),s._v("重新创建 pod。执行"),e("code",[s._v("kubectl get services --all-namespaces查看service运行状态")]),s._v("，执行"),e("code",[s._v("kubectl get po --all-namespaces | grep maven")]),s._v("查看 pod 状态。")]),s._v(" "),e("h3",{attrs:{id:"_5-9-jenkins-项目构建-01-49"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-jenkins-项目构建-01-49"}},[s._v("#")]),s._v(" 5-9 Jenkins 项目构建 (01:49)")]),s._v(" "),e("p",[s._v("总结：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("- Registry安装配置和使用(使用docker安装)\n- Jenkins项目创建和配置\n- Jenkins项目构建\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"第-6-章-课程总结与回顾"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-6-章-课程总结与回顾"}},[s._v("#")]),s._v(" 第 6 章 课程总结与回顾")]),s._v(" "),e("p",[s._v("本章重点总结持续集成、docker、k8s 的理念强调难点：k8s 的架构、安装、使用给出扩展建议：1）Jenkins 配置单元测试；2）Jenkins 配置接口自动化；3）Jenkins 配置接口自动化测试；4）Jenkins 配置邮件通知；5）学习微服务")]),s._v(" "),e("h3",{attrs:{id:"_6-1-课程总结-05-23"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-课程总结-05-23"}},[s._v("#")]),s._v(" 6-1 课程总结 (05:23)")]),s._v(" "),e("h4",{attrs:{id:"课程大纲"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课程大纲"}},[s._v("#")]),s._v(" 课程大纲")]),s._v(" "),e("p",[s._v("1.课程介绍、环境准备：课程整体介绍、实验环境规划、虚拟机安装配置\n2.Docker：docker 介绍、安装以及配置、基本使用\n3.k8s：介绍、安装以及配置、基本使用 4.持续集成与 jenkins：持续集成介绍、Jenkins 介绍、安装以及配置\n5.Jenkins+k8s 发布实例：Registry 安装配置和使用、Jenkins 项目创建与配置、Jenkins 项目构建 6.课程总结与回顾：课程总结")]),s._v(" "),e("h4",{attrs:{id:"课程重点与难点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课程重点与难点"}},[s._v("#")]),s._v(" 课程重点与难点")]),s._v(" "),e("ul",[e("li",[s._v("课程重点\n"),e("ul",[e("li",[s._v("持续集成的理念")]),s._v(" "),e("li",[s._v("Docker、k8s 的设计思想")]),s._v(" "),e("li",[s._v("Docker、k8s、Jenkins 的基本操作")]),s._v(" "),e("li",[s._v("PS：在我看来，k8s 的作用和 supervisor 很像啊")])])]),s._v(" "),e("li",[s._v("课程难点\n"),e("ul",[e("li",[s._v("k8s 的架构、安装(不同版本可能安装也不一样)")]),s._v(" "),e("li",[s._v("科学上网的设置")])])])]),s._v(" "),e("h4",{attrs:{id:"后续学习建议"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#后续学习建议"}},[s._v("#")]),s._v(" 后续学习建议")]),s._v(" "),e("ul",[e("li",[s._v("Jenkins 的更多配置(静态代码检查、单测、接口测试、邮件通知等)")]),s._v(" "),e("li",[s._v("微服务架构")]),s._v(" "),e("li",[s._v("Spring Cloud")])])])}),[],!1,null,null,null);a.default=n.exports},811:function(s,a,t){s.exports=t.p+"assets/img/k8s架构.98992b2d.jpg"},812:function(s,a,t){s.exports=t.p+"assets/img/持续集成过程.248a87ab.jpg"}}]);